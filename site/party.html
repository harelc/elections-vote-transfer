<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <script>if(/Android|iPhone|iPod/i.test(navigator.userAgent)&&!location.search.includes('desktop')){var lp=new URLSearchParams(location.search);lp.delete('desktop');var qs=lp.toString();location.replace('m/party.html'+(qs?'?'+qs:''))}</script>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
    <meta property="og:title" content="◊ß◊ï◊ú◊ï◊™ ◊†◊ï◊ì◊ì◊ô◊ù ‚Äî ◊§◊®◊ï◊§◊ô◊ú ◊û◊§◊ú◊í◊î">
    <meta property="og:description" content="◊†◊ô◊™◊ï◊ó ◊ê◊ô◊†◊ò◊®◊ê◊ß◊ò◊ô◊ë◊ô ◊©◊ú ◊†◊™◊ï◊†◊ô ◊ë◊ó◊ô◊®◊ï◊™ ◊ú◊õ◊†◊°◊™ ‚Äî Interactive Israeli Knesset election data analysis">
    <meta property="og:image" content="https://kolot-nodedim.netlify.app/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <title>◊§◊®◊ï◊§◊ô◊ú ◊û◊§◊ú◊í◊î - ◊ß◊ï◊ú◊ï◊™ ◊†◊ï◊ì◊ì◊ô◊ù</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="i18n.css">
    <script src="i18n.js"></script>
    <style>
        .profile-container {
            flex: 1;
            padding: var(--spacing-xl) var(--spacing-lg);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Hero */
        .profile-hero {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        .hero-color-bar {
            width: 8px;
            min-height: 80px;
            border-radius: 4px;
            flex-shrink: 0;
            align-self: stretch;
        }
        .hero-leader-img {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 3px solid var(--border-color);
        }
        .hero-info { flex: 1; min-width: 0; }
        .hero-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .hero-name-en {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        .hero-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }
        .hero-meta-item {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .hero-meta-item strong {
            color: var(--text-primary);
        }
        .hero-aliases {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            line-height: 1.6;
        }
        .hero-aliases strong { color: var(--text-muted); }

        /* Section */
        .profile-section {
            margin-bottom: 2.5rem;
        }
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Charts */
        .trends-chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            height: 350px;
            position: relative;
        }

        /* Election history table */
        .history-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }
        .history-table th {
            background: var(--bg-tertiary);
            padding: 0.6rem 0.75rem;
            text-align: start;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border-color);
        }
        .history-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .history-table tr:last-child td { border-bottom: none; }
        .history-table .color-dot {
            display: inline-block;
            width: 10px; height: 10px;
            border-radius: 50%;
            margin-inline-end: 0.4rem;
            vertical-align: middle;
        }
        .history-table .merged-note {
            font-size: 0.78rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Strongholds grid */
        .strongholds-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .strongholds-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        .strongholds-list h4 {
            padding: 0.6rem 0.75rem;
            background: var(--bg-tertiary);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0;
            border-bottom: 1px solid var(--border-color);
        }
        .stronghold-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }
        .stronghold-item:last-child { border-bottom: none; }
        .stronghold-item a {
            color: var(--text-primary);
            text-decoration: none;
        }
        .stronghold-item a:hover { color: var(--accent-primary); }
        .stronghold-pct { color: var(--text-muted); }

        /* Mini map */
        .strongholds-map-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-top: 1.5rem;
        }
        #strongholds-map { height: 350px; }

        /* Migration */
        .migration-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .migration-controls select {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.88rem;
        }
        .migration-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .migration-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
        }
        .migration-panel h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0 0 0.75rem;
            color: var(--text-secondary);
        }
        .migration-bar-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            font-size: 0.82rem;
        }
        .migration-bar-label {
            min-width: 100px;
            text-align: end;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .migration-bar-track {
            flex: 1;
            height: 18px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        .migration-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .migration-bar-value {
            min-width: 45px;
            color: var(--text-muted);
            font-size: 0.78rem;
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .metrics-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
        }
        .metrics-card h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0 0 0.75rem;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-color);
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: var(--text-secondary); }
        .metric-value { color: var(--text-primary); font-weight: 600; }
        .metric-big {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        .metric-sub {
            font-size: 0.78rem;
            color: var(--text-muted);
        }
        .sim-row {
            display: flex;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }
        .sim-row:last-child { border-bottom: none; }
        .sim-label {
            width: 130px;
            flex-shrink: 0;
            color: var(--text-secondary);
        }
        .sim-bar-track {
            flex: 1;
            height: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 6px;
            margin: 0 0.6rem;
            overflow: hidden;
            direction: ltr;
        }
        .sim-bar-fill {
            height: 100%;
            border-radius: 5px;
            opacity: 0.75;
        }
        .sim-value {
            width: 40px;
            flex-shrink: 0;
            text-align: left;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.8rem;
        }
        .metric-explainer {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
            margin-top: 0.25rem;
            padding: 0.4rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        /* Search */
        .party-search {
            margin-bottom: 2rem;
            position: relative;
        }
        .party-search input {
            width: 100%;
            max-width: 400px;
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
        }
        .party-search input:focus { border-color: var(--accent-primary); }
        .search-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 100%;
            max-width: 400px;
            max-height: 250px;
            overflow-y: auto;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-top: 4px;
            z-index: 100;
            display: none;
        }
        .search-dropdown.visible { display: block; }
        .search-dropdown a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.88rem;
        }
        .search-dropdown a:hover { background: var(--bg-hover); }
        .search-dropdown .sdot {
            display: inline-block;
            width: 10px; height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Landing grid */
        .party-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .party-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            text-decoration: none;
            color: inherit;
            transition: transform var(--transition-normal), border-color var(--transition-normal), box-shadow var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .party-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }
        .party-card-dot {
            width: 14px; height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .party-card-info { min-width: 0; }
        .party-card-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .party-card-seats {
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        /* Loading */
        .loading-msg {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .strongholds-grid { grid-template-columns: 1fr; }
            .migration-grid { grid-template-columns: 1fr; }
            .profile-hero { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="dunes-container">
        <div class="dune dune-3"></div>
        <div class="dune dune-2"></div>
        <div class="dune dune-1"></div>
    </div>

    <div class="app-container">
        <header class="main-header">
            <div class="header-content">
                <h1 class="site-title">
                    <span class="title-icon">üó≥Ô∏è</span>
                    <span data-i18n="site_title">◊ß◊ï◊ú◊ï◊™ ◊†◊ï◊ì◊ì◊ô◊ù</span>
                </h1>
                <p class="site-subtitle" data-i18n="party_profile">◊§◊®◊ï◊§◊ô◊ú ◊û◊§◊ú◊í◊î</p>
            </div>
            <nav class="view-switcher"></nav>
        </header>

        <div class="profile-container" id="profile-container">
            <div class="loading-msg" id="loading" data-i18n="loading">◊ò◊ï◊¢◊ü ◊†◊™◊ï◊†◊ô◊ù...</div>
        </div>
    </div>

    <script>
    (function() {
        i18n.renderNav('party'); i18n.renderBMC();

        /* ‚îÄ‚îÄ Party Families ‚îÄ‚îÄ */
        const PARTY_FAMILIES = [
            {
                id: 'likud', name: '◊î◊ú◊ô◊õ◊ï◊ì', name_en: 'Likud', color: '#2563eb',
                elections: {
                    '21': { partyName: '◊î◊ú◊ô◊õ◊ï◊ì', symbol: '◊û◊ó◊ú', seats: 35 },
                    '22': { partyName: '◊î◊ú◊ô◊õ◊ï◊ì', symbol: '◊û◊ó◊ú', seats: 32 },
                    '23': { partyName: '◊î◊ú◊ô◊õ◊ï◊ì', symbol: '◊û◊ó◊ú', seats: 36 },
                    '24': { partyName: '◊î◊ú◊ô◊õ◊ï◊ì', symbol: '◊û◊ó◊ú', seats: 30 },
                    '25': { partyName: '◊î◊ú◊ô◊õ◊ï◊ì', symbol: '◊û◊ó◊ú', seats: 32 },
                }
            },
            {
                id: 'yesh_atid', name: '◊ô◊© ◊¢◊™◊ô◊ì', name_en: 'Yesh Atid', color: '#06b6d4',
                elections: {
                    '21': { partyName: '◊õ◊ó◊ï◊ú ◊ú◊ë◊ü', symbol: '◊§◊î', seats: 35 },
                    '22': { partyName: '◊õ◊ó◊ï◊ú ◊ú◊ë◊ü', symbol: '◊§◊î', seats: 33 },
                    '23': { partyName: '◊õ◊ó◊ï◊ú ◊ú◊ë◊ü', symbol: '◊§◊î', seats: 33 },
                    '24': { partyName: '◊ô◊© ◊¢◊™◊ô◊ì', symbol: '◊§◊î', seats: 17 },
                    '25': { partyName: '◊ô◊© ◊¢◊™◊ô◊ì', symbol: '◊§◊î', seats: 24 },
                }
            },
            {
                id: 'national_unity', name: '◊î◊û◊ó◊†◊î ◊î◊û◊û◊ú◊õ◊™◊ô', name_en: 'National Unity', color: '#7c3aed',
                elections: {
                    '24': { partyName: '◊õ◊ó◊ï◊ú ◊ú◊ë◊ü', symbol: '◊õ◊ü', seats: 8 },
                    '25': { partyName: '◊î◊û◊ó◊†◊î ◊î◊û◊û◊ú◊õ◊™◊ô', symbol: '◊õ◊ü', seats: 12 },
                },
                notes: { '21': '◊õ◊ó◊ï◊ú ◊ú◊ë◊ü (◊§◊î)', '22': '◊õ◊ó◊ï◊ú ◊ú◊ë◊ü (◊§◊î)', '23': '◊õ◊ó◊ï◊ú ◊ú◊ë◊ü (◊§◊î)' }
            },
            {
                id: 'shas', name: '◊©◊¥◊°', name_en: 'Shas', color: '#1e3a8a',
                elections: {
                    '21': { partyName: '◊©◊¥◊°', symbol: '◊©◊°', seats: 8 },
                    '22': { partyName: '◊©◊¥◊°', symbol: '◊©◊°', seats: 9 },
                    '23': { partyName: '◊©◊¥◊°', symbol: '◊©◊°', seats: 9 },
                    '24': { partyName: '◊©◊¥◊°', symbol: '◊©◊°', seats: 9 },
                    '25': { partyName: '◊©◊¥◊°', symbol: '◊©◊°', seats: 11 },
                }
            },
            {
                id: 'utj', name: '◊ô◊î◊ì◊ï◊™ ◊î◊™◊ï◊®◊î', name_en: 'United Torah Judaism', color: '#4b5563',
                elections: {
                    '21': { partyName: '◊ô◊î◊ì◊ï◊™ ◊î◊™◊ï◊®◊î', symbol: '◊í', seats: 8 },
                    '22': { partyName: '◊ô◊î◊ì◊ï◊™ ◊î◊™◊ï◊®◊î', symbol: '◊í', seats: 7 },
                    '23': { partyName: '◊ô◊î◊ì◊ï◊™ ◊î◊™◊ï◊®◊î', symbol: '◊í', seats: 7 },
                    '24': { partyName: '◊ô◊î◊ì◊ï◊™ ◊î◊™◊ï◊®◊î', symbol: '◊í', seats: 7 },
                    '25': { partyName: '◊ô◊î◊ì◊ï◊™ ◊î◊™◊ï◊®◊î', symbol: '◊í', seats: 7 },
                }
            },
            {
                id: 'yisrael_beiteinu', name: '◊ô◊©◊®◊ê◊ú ◊ë◊ô◊™◊†◊ï', name_en: 'Yisrael Beiteinu', color: '#db2777',
                elections: {
                    '21': { partyName: '◊ô◊©◊®◊ê◊ú ◊ë◊ô◊™◊†◊ï', symbol: '◊ú', seats: 5 },
                    '22': { partyName: '◊ô◊©◊®◊ê◊ú ◊ë◊ô◊™◊†◊ï', symbol: '◊ú', seats: 8 },
                    '23': { partyName: '◊ô◊©◊®◊ê◊ú ◊ë◊ô◊™◊†◊ï', symbol: '◊ú', seats: 7 },
                    '24': { partyName: '◊ô◊©◊®◊ê◊ú ◊ë◊ô◊™◊†◊ï', symbol: '◊ú', seats: 7 },
                    '25': { partyName: '◊ô◊©◊®◊ê◊ú ◊ë◊ô◊™◊†◊ï', symbol: '◊ú', seats: 6 },
                }
            },
            {
                id: 'labor', name: '◊î◊¢◊ë◊ï◊ì◊î', name_en: 'Labor', color: '#dc2626',
                elections: {
                    '21': { partyName: '◊î◊¢◊ë◊ï◊ì◊î', symbol: '◊ê◊û◊™', seats: 6 },
                    '22': { partyName: '◊î◊¢◊ë◊ï◊ì◊î-◊í◊©◊®', symbol: '◊ê◊û◊™', seats: 6 },
                    '23': { partyName: '◊¢◊ë◊ï◊ì◊î-◊í◊©◊®-◊û◊®◊¶', symbol: '◊ê◊û◊™', seats: 7 },
                    '24': { partyName: '◊î◊¢◊ë◊ï◊ì◊î', symbol: '◊ê◊û◊™', seats: 7 },
                    '25': { partyName: '◊î◊¢◊ë◊ï◊ì◊î', symbol: '◊ê◊û◊™', seats: 4 },
                }
            },
            {
                id: 'meretz', name: '◊û◊®◊¶', name_en: 'Meretz', color: '#16a34a',
                elections: {
                    '21': { partyName: '◊û◊®◊¶', symbol: '◊û◊®◊¶', seats: 4 },
                    '22': { partyName: '◊î◊û◊ó◊†◊î ◊î◊ì◊û◊ï◊ß◊®◊ò◊ô', symbol: '◊û◊®◊¶', seats: 5 },
                    '24': { partyName: '◊û◊®◊¶', symbol: '◊û◊®◊¶', seats: 6 },
                    '25': { partyName: '◊û◊®◊¶', symbol: '◊û◊®◊¶', seats: 0 },
                },
                notes: { '23': '◊¢◊ë◊ï◊ì◊î-◊í◊©◊®-◊û◊®◊¶ (◊ê◊û◊™)' }
            },
            {
                id: 'joint_list', name: '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™', name_en: 'Joint List', color: '#059669',
                elections: {
                    '21': { partyName: '◊ó◊ì◊¥◊©-◊™◊¢◊¥◊ú', symbol: '◊ï◊ù', seats: 6 },
                    '22': { partyName: '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™', symbol: '◊ï◊ì◊¢◊ù', seats: 13 },
                    '23': { partyName: '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™', symbol: '◊ï◊ì◊¢◊ù', seats: 15 },
                    '24': { partyName: '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™', symbol: '◊ï◊ì◊¢◊ù', seats: 6 },
                    '25': { partyName: '◊ó◊ì◊¥◊©-◊™◊¢◊¥◊ú', symbol: '◊ï◊ù', seats: 5 },
                }
            },
            {
                id: 'raam', name: '◊®◊¢◊¥◊ù', name_en: "Ra'am", color: '#84cc16',
                elections: {
                    '21': { partyName: '◊®◊¢◊¥◊ù-◊ë◊ú◊¥◊ì', symbol: '◊ì◊¢◊ù', seats: 4 },
                    '24': { partyName: '◊®◊¢◊¥◊ù', symbol: '◊¢◊ù', seats: 4 },
                    '25': { partyName: '◊®◊¢◊¥◊ù', symbol: '◊¢◊ù', seats: 5 },
                },
                notes: { '22': '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™ (◊ï◊ì◊¢◊ù)', '23': '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™ (◊ï◊ì◊¢◊ù)' }
            },
            {
                id: 'yamina', name: '◊ô◊û◊ô◊†◊î', name_en: 'Yamina', color: '#ea580c',
                elections: {
                    '21': { partyName: '◊î◊ë◊ô◊™ ◊î◊ô◊î◊ï◊ì◊ô', symbol: '◊ò◊ë', seats: 5 },
                    '22': { partyName: '◊ô◊û◊ô◊†◊î', symbol: '◊ò◊ë', seats: 7 },
                    '23': { partyName: '◊ô◊û◊ô◊†◊î', symbol: '◊ò◊ë', seats: 6 },
                    '24': { partyName: '◊ô◊û◊ô◊†◊î', symbol: '◊ë', seats: 7 },
                }
            },
            {
                id: 'religious_zionism', name: '◊î◊¶◊ô◊ï◊†◊ï◊™ ◊î◊ì◊™◊ô◊™', name_en: 'Religious Zionism', color: '#92400e',
                elections: {
                    '24': { partyName: '◊î◊¶◊ô◊ï◊†◊ï◊™ ◊î◊ì◊™◊ô◊™', symbol: '◊ò', seats: 6 },
                    '25': { partyName: '◊î◊¶◊ô◊ï◊†◊ï◊™ ◊î◊ì◊™◊ô◊™', symbol: '◊ò', seats: 14 },
                }
            },
            {
                id: 'new_hope', name: '◊™◊ß◊ï◊ï◊î ◊ó◊ì◊©◊î', name_en: 'New Hope', color: '#a855f7',
                elections: {
                    '24': { partyName: '◊™◊ß◊ï◊ï◊î ◊ó◊ì◊©◊î', symbol: '◊™', seats: 6 },
                },
                notes: { '25': '◊î◊û◊ó◊†◊î ◊î◊û◊û◊ú◊õ◊™◊ô (◊õ◊ü)' }
            },
            {
                id: 'kulanu', name: '◊õ◊ï◊ú◊†◊ï', name_en: 'Kulanu', color: '#eab308',
                elections: {
                    '21': { partyName: '◊õ◊ï◊ú◊†◊ï', symbol: '◊õ', seats: 4 },
                },
                notes: { '22': '◊î◊ú◊ô◊õ◊ï◊ì (◊û◊ó◊ú)' }
            },
            {
                id: 'balad', name: '◊ë◊ú◊¥◊ì', name_en: 'Balad', color: '#065f46',
                elections: {
                    '25': { partyName: '◊ë◊ú◊¥◊ì', symbol: '◊ì', seats: 0 },
                },
                notes: { '21': '◊®◊¢◊¥◊ù-◊ë◊ú◊¥◊ì (◊ì◊¢◊ù)', '22': '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™ (◊ï◊ì◊¢◊ù)', '23': '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™ (◊ï◊ì◊¢◊ù)', '24': '◊î◊®◊©◊ô◊û◊î ◊î◊û◊©◊ï◊™◊§◊™ (◊ï◊ì◊¢◊ù)' }
            },
        ];

        const ELECTIONS = ['21', '22', '23', '24', '25'];
        const ELECTION_LABELS = {
            '21': { he: '◊õ◊†◊°◊™ 21', en: 'Knesset 21' },
            '22': { he: '◊õ◊†◊°◊™ 22', en: 'Knesset 22' },
            '23': { he: '◊õ◊†◊°◊™ 23', en: 'Knesset 23' },
            '24': { he: '◊õ◊†◊°◊™ 24', en: 'Knesset 24' },
            '25': { he: '◊õ◊†◊°◊™ 25', en: 'Knesset 25' },
        };
        const TRANSITION_PAIRS = ['21_to_22', '22_to_23', '23_to_24', '24_to_25'];

        const params = new URLSearchParams(location.search);
        const partyParam = params.get('name');

        let allMapData = {};
        let allTransfers = {};
        let coordsData = {};
        let wikiResults = {};
        let metricsData = null;

        if (!partyParam) {
            showLanding();
        } else {
            showProfile(partyParam);
        }

        function findFamily(name) {
            return PARTY_FAMILIES.find(f =>
                f.name === name || f.name_en === name ||
                Object.values(f.elections).some(e => e.partyName === name)
            );
        }

        /* ‚îÄ‚îÄ Landing ‚îÄ‚îÄ */
        function showLanding() {
            const container = document.getElementById('profile-container');
            const lang = i18n.getLang();

            // Sort families by latest seats desc
            const sorted = [...PARTY_FAMILIES].sort((a, b) => {
                const aSeats = getLatestSeats(a);
                const bSeats = getLatestSeats(b);
                return bSeats - aSeats;
            });

            let html = '';
            html += '<div class="party-search">';
            html += '<input type="text" id="search-input" placeholder="' + i18n.t('search_party') + '">';
            html += '<div class="search-dropdown" id="search-dropdown"></div>';
            html += '</div>';

            html += '<div class="party-grid">';
            sorted.forEach(f => {
                const seats = getLatestSeats(f);
                const displayName = lang === 'en' ? f.name_en : f.name;
                const seatsLabel = seats > 0 ? seats + ' ' + i18n.t('seats') : '‚Äî';
                html += '<a class="party-card" href="party.html?name=' + encodeURIComponent(f.name) + '">';
                html += '<span class="party-card-dot" style="background:' + f.color + '"></span>';
                html += '<div class="party-card-info">';
                html += '<div class="party-card-name">' + displayName + '</div>';
                html += '<div class="party-card-seats">' + seatsLabel + '</div>';
                html += '</div></a>';
            });
            html += '</div>';

            container.innerHTML = html;
            initPartySearch();

            window.addEventListener('langchange', () => {
                showLanding();
            });
        }

        function getLatestSeats(family) {
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                const e = family.elections[ELECTIONS[i]];
                if (e) return e.seats;
            }
            return -1;
        }

        /* ‚îÄ‚îÄ Profile ‚îÄ‚îÄ */
        function showProfile(familyName) {
            const family = findFamily(familyName);
            if (!family) {
                document.getElementById('profile-container').innerHTML =
                    '<div class="loading-msg">' + i18n.t('no_data') + '</div>';
                return;
            }

            document.title = family.name + ' - ◊ß◊ï◊ú◊ï◊™ ◊†◊ï◊ì◊ì◊ô◊ù';

            Promise.all([
                ...ELECTIONS.map(e => fetch('data/map_' + e + '.json').then(r => r.json()).then(d => { allMapData[e] = d; })),
                fetch('data/all_transfers.json').then(r => r.json()).then(d => { allTransfers = d; }).catch(() => {}),
                fetch('data/station_coordinates.json').then(r => r.json()).then(d => { coordsData = d; }).catch(() => {}),
                fetch('data/wiki_official_results.json').then(r => r.json()).then(d => { wikiResults = d; }).catch(() => {}),
                fetch('data/metrics.json').then(r => r.json()).then(d => { metricsData = d; }).catch(() => {}),
            ]).then(() => {
                renderProfile(family);
            }).catch(() => {
                document.getElementById('loading').textContent = i18n.t('error_loading');
            });
        }

        function renderProfile(family) {
            const container = document.getElementById('profile-container');
            const lang = i18n.getLang();
            const displayName = lang === 'en' ? family.name_en : family.name;

            // Get party info from map data for leader etc.
            let latestInfo = null;
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                const elec = family.elections[ELECTIONS[i]];
                if (!elec) continue;
                const mapData = allMapData[ELECTIONS[i]];
                if (!mapData) continue;
                const p = mapData.parties.find(p => p.name === elec.partyName);
                if (p && p.info) { latestInfo = p.info; break; }
            }

            let html = '';

            // Search bar
            html += '<div class="party-search">';
            html += '<input type="text" id="search-input" placeholder="' + i18n.t('search_party') + '">';
            html += '<div class="search-dropdown" id="search-dropdown"></div>';
            html += '</div>';

            // Hero
            html += '<section class="profile-hero">';
            html += '<div class="hero-color-bar" style="background:' + family.color + '"></div>';
            if (latestInfo && latestInfo.leader_image) {
                html += '<img class="hero-leader-img" src="' + latestInfo.leader_image + '" alt="" onerror="this.style.display=\'none\'">';
            }
            html += '<div class="hero-info">';
            html += '<h2 class="hero-name">' + displayName + '</h2>';
            if (lang === 'he' && family.name_en) {
                html += '<div class="hero-name-en">' + family.name_en + '</div>';
            } else if (lang === 'en') {
                html += '<div class="hero-name-en">' + family.name + '</div>';
            }
            html += '<div class="hero-meta">';
            if (latestInfo) {
                const leader = lang === 'en' && latestInfo.leader_en ? latestInfo.leader_en : latestInfo.leader;
                if (leader) html += '<span class="hero-meta-item"><strong>' + leader + '</strong></span>';
                if (latestInfo.ideology) html += '<span class="hero-meta-item">' + latestInfo.ideology + '</span>';
                if (latestInfo.founded) html += '<span class="hero-meta-item">' + i18n.t('founded_label') + ' ' + latestInfo.founded + '</span>';
            }
            html += '</div>';

            // Aliases ‚Äî show unique names used across elections (different from canonical)
            const aliases = [];
            Object.entries(family.elections).forEach(([e, data]) => {
                if (data.partyName !== family.name && !aliases.includes(data.partyName)) {
                    aliases.push(data.partyName);
                }
            });
            if (aliases.length > 0) {
                html += '<div class="hero-aliases"><strong>' + i18n.t('also_known_as') + '</strong> ' + aliases.join(', ') + '</div>';
            }

            html += '</div></section>';

            // Seats & Support trend chart
            html += '<section class="profile-section">';
            html += '<h3 class="section-title" data-i18n="seats_trend">' + i18n.t('seats_trend') + '</h3>';
            html += '<div class="trends-chart-container"><canvas id="trends-chart"></canvas></div>';
            html += '</section>';

            // Election history table
            html += '<section class="profile-section">';
            html += '<h3 class="section-title" data-i18n="election_history">' + i18n.t('election_history') + '</h3>';
            html += buildHistoryTable(family);
            html += '</section>';

            // Geographic strongholds (latest election with data)
            html += '<section class="profile-section">';
            html += '<h3 class="section-title" data-i18n="geographic_strongholds">' + i18n.t('geographic_strongholds') + '</h3>';
            html += '<div class="strongholds-grid" id="strongholds-grid"></div>';
            html += '<div class="strongholds-map-container"><div id="strongholds-map"></div></div>';
            html += '</section>';

            // Statistical metrics
            html += buildMetricsSection(family, metricsData);

            // Voter migration
            html += '<section class="profile-section">';
            html += '<h3 class="section-title" data-i18n="voter_migration">' + i18n.t('voter_migration') + '</h3>';
            html += '<div class="migration-controls">';
            html += '<span data-i18n="transition_label">' + i18n.t('transition_label') + '</span>';
            html += '<select id="migration-select">';
            TRANSITION_PAIRS.forEach(pair => {
                const [from, to] = pair.split('_to_');
                html += '<option value="' + pair + '">' + ELECTION_LABELS[from][lang] + ' ‚Üí ' + ELECTION_LABELS[to][lang] + '</option>';
            });
            html += '</select></div>';
            html += '<div class="migration-grid" id="migration-grid"></div>';
            html += '</section>';

            container.innerHTML = html;

            setTimeout(() => {
                initTrendsChart(family);
                initStrongholds(family);
                initMigration(family);
                initPartySearch();
                drawConcentrationCDF(family);
            }, 50);
        }

        function buildMetricsSection(family, metricsData) {
            if (!metricsData) return '';
            const lang = i18n.getLang();

            // Find the party name in metrics (use latest election's partyName)
            let partyName = null;
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                const e = family.elections[ELECTIONS[i]];
                if (e) { partyName = e.partyName; break; }
            }
            if (!partyName) return '';

            const hhi = metricsData.party_hhi[partyName];
            const cosine = metricsData.party_cosine_similarity[partyName];
            const corr = metricsData.party_ballot_correlations[partyName];
            const conc = metricsData.party_concentration[partyName];

            if (!hhi && !cosine && !conc) return '';

            let html = '<section class="profile-section">';
            html += '<h3 class="section-title" data-i18n="party_analytics">' + i18n.t('party_analytics') + '</h3>';
            html += '<div class="metrics-grid">';

            // Geographic concentration card with CDF chart
            if (hhi && conc) {
                html += '<div class="metrics-card">';
                html += '<h4 data-i18n="geographic_concentration">' + i18n.t('geographic_concentration') + '</h4>';
                html += '<div class="metric-explainer">' + i18n.t('hhi_explainer') + '</div>';
                html += '<canvas id="concentration-cdf" style="width:100%;height:210px;margin:0.75rem 0"></canvas>';
                html += '<div style="margin-top:0.5rem">';
                html += '<div class="metric-row"><span class="metric-label">' + i18n.t('settlements_for_half') + '</span><span class="metric-value">' + conc.settlements_for_50pct + '</span></div>';
                html += '<div class="metric-row"><span class="metric-label">' + i18n.t('settlements_for_90') + '</span><span class="metric-value">' + conc.settlements_for_90pct + '</span></div>';
                html += '<div class="metric-row"><span class="metric-label">' + i18n.t('effective_settlements') + '</span><span class="metric-value">' + hhi.effective_settlements + '</span></div>';
                html += '<div style="font-size:0.72rem;color:var(--text-muted);margin-top:-0.1rem;padding-bottom:0.3rem">' + i18n.t('effective_settlements_tip') + '</div>';
                html += '</div></div>';
            }

            // Similar parties card (cosine + correlation)
            if (cosine) {
                html += '<div class="metrics-card">';
                html += '<h4 data-i18n="similar_parties">' + i18n.t('similar_parties') + '</h4>';
                html += '<div class="metric-explainer">' + i18n.t('cosine_explainer') + '</div>';

                // Top 5 by cosine similarity
                html += '<div style="margin-top:0.5rem">';
                var cosSorted = Object.entries(cosine).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 5);
                cosSorted.forEach(function(pair) {
                    var pName = pair[0], sim = pair[1];
                    var pctW = Math.round(sim * 100);
                    html += '<div class="sim-row">';
                    html += '<span class="sim-label">' + i18n.partyName(pName) + '</span>';
                    html += '<div class="sim-bar-track"><div class="sim-bar-fill" style="width:' + pctW + '%;background:' + family.color + '"></div></div>';
                    html += '<span class="sim-value">' + sim.toFixed(2) + '</span>';
                    html += '</div>';
                });
                html += '</div>';

                // Show ballot-level correlations if available
                if (corr) {
                    html += '<div style="margin-top:0.75rem;padding-top:0.5rem;border-top:1px solid var(--border-color)">';
                    html += '<div class="metric-sub" style="margin-bottom:0.25rem">' + i18n.t('ballot_correlation') + '</div>';
                    html += '<div class="metric-explainer" style="margin-bottom:0.5rem">' + i18n.t('ballot_corr_explainer') + '</div>';
                    var corrSorted = Object.entries(corr).sort(function(a, b) { return b[1] - a[1]; });
                    // Top 3 positive
                    corrSorted.slice(0, 3).forEach(function(pair) {
                        html += '<div class="metric-row"><span class="metric-label">' + i18n.partyName(pair[0]) + '</span><span class="metric-value" style="color:#4ade80">+' + pair[1].toFixed(2) + '</span></div>';
                    });
                    // Top 3 negative
                    corrSorted.slice(-3).reverse().forEach(function(pair) {
                        html += '<div class="metric-row"><span class="metric-label">' + i18n.partyName(pair[0]) + '</span><span class="metric-value" style="color:#f87171">' + pair[1].toFixed(2) + '</span></div>';
                    });
                    html += '</div>';
                }

                html += '</div>';
            }

            html += '</div></section>';
            return html;
        }

        function buildHistoryTable(family) {
            const lang = i18n.getLang();
            let html = '<div class="history-table-container"><table class="history-table">';
            html += '<thead><tr>';
            html += '<th>' + i18n.t('election') + '</th>';
            html += '<th>' + i18n.t('party') + '</th>';
            html += '<th>' + i18n.t('symbol_label') + '</th>';
            html += '<th>' + i18n.t('seats') + '</th>';
            html += '<th>' + i18n.t('votes') + '</th>';
            html += '<th>' + i18n.t('national_support') + '</th>';
            html += '<th>' + i18n.t('leader_col') + '</th>';
            html += '</tr></thead><tbody>';

            ELECTIONS.forEach(e => {
                const data = family.elections[e];
                const label = ELECTION_LABELS[e][lang];

                if (!data) {
                    const note = family.notes && family.notes[e];
                    html += '<tr><td>' + label + '</td>';
                    if (note) {
                        html += '<td colspan="6" class="merged-note">' + i18n.t('merged_into') + ' ' + note + '</td>';
                    } else {
                        html += '<td colspan="6" class="merged-note">' + i18n.t('did_not_run') + '</td>';
                    }
                    html += '</tr>';
                    return;
                }

                // Get official vote count from wiki results
                let supportPct = '‚Äî';
                let votesDisplay = '‚Äî';
                const wikiEntry = (wikiResults[e] || []).find(p => p.name === data.partyName);
                if (wikiEntry && wikiEntry.votes) {
                    votesDisplay = i18n.fmtNum(wikiEntry.votes);
                    // Calculate % from official votes / total valid votes
                    const totalValid = (wikiResults[e] || []).reduce((sum, p) => sum + (p.votes || 0), 0);
                    if (totalValid > 0) {
                        supportPct = (wikiEntry.votes / totalValid * 100).toFixed(1) + '%';
                    }
                }

                // Get leader from party info
                let leader = '‚Äî';
                const mapData = allMapData[e];
                if (mapData && mapData.parties) {
                    const p = mapData.parties.find(p => p.name === data.partyName);
                    if (p && p.info) {
                        leader = lang === 'en' && p.info.leader_en ? p.info.leader_en : (p.info.leader || '‚Äî');
                    }
                }

                const partyDisplayName = i18n.partyName(data.partyName);
                html += '<tr>';
                html += '<td>' + label + '</td>';
                html += '<td><span class="color-dot" style="background:' + family.color + '"></span>' + partyDisplayName + '</td>';
                html += '<td>' + data.symbol + '</td>';
                html += '<td>' + data.seats + '</td>';
                html += '<td>' + votesDisplay + '</td>';
                html += '<td>' + supportPct + '</td>';
                html += '<td>' + leader + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            return html;
        }

        function initTrendsChart(family) {
            const canvas = document.getElementById('trends-chart');
            if (!canvas) return;
            const lang = i18n.getLang();

            // Compute support % per election
            const supportData = [];
            const seatsData = [];
            ELECTIONS.forEach(e => {
                const data = family.elections[e];
                if (!data) {
                    supportData.push(null);
                    seatsData.push(null);
                    return;
                }
                seatsData.push(data.seats);

                const wikiEntry = (wikiResults[e] || []).find(p => p.name === data.partyName);
                if (wikiEntry && wikiEntry.votes) {
                    const totalValid = (wikiResults[e] || []).reduce((sum, p) => sum + (p.votes || 0), 0);
                    supportData.push(totalValid > 0 ? +(wikiEntry.votes / totalValid * 100).toFixed(2) : null);
                } else {
                    supportData.push(null);
                }
            });

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: ELECTIONS.map(e => ELECTION_LABELS[e][lang]),
                    datasets: [
                        {
                            label: i18n.t('support_pct'),
                            data: supportData,
                            borderColor: family.color,
                            backgroundColor: family.color + '33',
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: family.color,
                            yAxisID: 'y',
                            spanGaps: false,
                        },
                        {
                            label: i18n.t('seats'),
                            data: seatsData,
                            borderColor: family.color + '99',
                            borderDash: [6, 4],
                            tension: 0.3,
                            pointRadius: 4,
                            pointStyle: 'rectRot',
                            yAxisID: 'y1',
                            spanGaps: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#a0a0b0', font: { family: 'Heebo' }, padding: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    if (ctx.datasetIndex === 0) return ctx.dataset.label + ': ' + ctx.parsed.y + '%';
                                    return ctx.dataset.label + ': ' + ctx.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a0a0b0', font: { family: 'Heebo' } },
                            grid: { color: '#2a2a3a' }
                        },
                        y: {
                            position: lang === 'en' ? 'left' : 'right',
                            title: { display: true, text: i18n.t('support_pct'), color: '#a0a0b0' },
                            ticks: { color: '#a0a0b0', callback: v => v + '%' },
                            grid: { color: '#2a2a3a' },
                            min: 0,
                        },
                        y1: {
                            position: lang === 'en' ? 'right' : 'left',
                            title: { display: true, text: i18n.t('seats'), color: '#a0a0b0' },
                            ticks: { color: '#94a3b8', stepSize: 5 },
                            grid: { display: false },
                            min: 0,
                        }
                    }
                }
            });
        }

        function drawConcentrationCDF(family) {
            const canvas = document.getElementById('concentration-cdf');
            if (!canvas) return;

            // Find latest election with data
            let latestE = null, latestPartyName = null;
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                if (family.elections[ELECTIONS[i]]) {
                    latestE = ELECTIONS[i];
                    latestPartyName = family.elections[latestE].partyName;
                    break;
                }
            }
            if (!latestE || !allMapData[latestE]) return;

            // Compute absolute votes per settlement for this party
            const settlements = allMapData[latestE].settlements || [];
            const partyVotes = settlements
                .filter(s => s.proportions && s.proportions[latestPartyName] != null && s.voters > 0)
                .map(s => ({
                    name: s.name,
                    votes: s.proportions[latestPartyName] / 100 * s.voters
                }))
                .filter(s => s.votes > 0)
                .sort((a, b) => b.votes - a.votes);

            if (partyVotes.length === 0) return;

            const totalVotes = partyVotes.reduce((sum, s) => sum + s.votes, 0);

            // Build cumulative data
            const cumData = [];
            let cumSum = 0;
            for (let i = 0; i < partyVotes.length; i++) {
                cumSum += partyVotes[i].votes;
                cumData.push({ n: i + 1, pct: cumSum / totalVotes * 100, name: partyVotes[i].name });
            }

            // Find 50% and 90% crossings
            const n50 = cumData.find(d => d.pct >= 50);
            const n90 = cumData.find(d => d.pct >= 90);

            // Draw on canvas
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            const W = rect.width, H = rect.height;
            const pad = { top: 15, right: 15, bottom: 45, left: 45 };
            const plotW = W - pad.left - pad.right;
            const plotH = H - pad.top - pad.bottom;
            const maxN = partyVotes.length;

            function xScale(n) { return pad.left + (n / maxN) * plotW; }
            function yScale(pct) { return pad.top + plotH - (pct / 100) * plotH; }

            // Background
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-card').trim() || '#1a1a2e';
            ctx.fillRect(0, 0, W, H);

            // Grid lines
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            ctx.lineWidth = 0.5;
            for (const pct of [25, 50, 75, 100]) {
                ctx.beginPath();
                ctx.moveTo(pad.left, yScale(pct));
                ctx.lineTo(W - pad.right, yScale(pct));
                ctx.stroke();
            }

            // 50% fill area
            if (n50) {
                ctx.fillStyle = family.color + '18';
                ctx.beginPath();
                ctx.moveTo(xScale(0), yScale(0));
                for (let i = 0; i < cumData.length && cumData[i].n <= n50.n; i++) {
                    ctx.lineTo(xScale(cumData[i].n), yScale(cumData[i].pct));
                }
                ctx.lineTo(xScale(n50.n), yScale(0));
                ctx.closePath();
                ctx.fill();
            }

            // CDF curve
            ctx.strokeStyle = family.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(xScale(0), yScale(0));
            for (const d of cumData) {
                ctx.lineTo(xScale(d.n), yScale(d.pct));
            }
            ctx.stroke();

            // 50% reference line + marker
            ctx.setLineDash([4, 3]);
            ctx.strokeStyle = 'rgba(255,255,255,0.35)';
            ctx.lineWidth = 1;
            if (n50) {
                ctx.beginPath();
                ctx.moveTo(xScale(n50.n), yScale(50));
                ctx.lineTo(xScale(n50.n), yScale(0));
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pad.left, yScale(50));
                ctx.lineTo(xScale(n50.n), yScale(50));
                ctx.stroke();
            }
            // 90% reference line
            if (n90) {
                ctx.beginPath();
                ctx.moveTo(xScale(n90.n), yScale(90));
                ctx.lineTo(xScale(n90.n), yScale(0));
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pad.left, yScale(90));
                ctx.lineTo(xScale(n90.n), yScale(90));
                ctx.stroke();
            }
            ctx.setLineDash([]);

            // Dot at 50% crossing
            if (n50) {
                ctx.beginPath();
                ctx.arc(xScale(n50.n), yScale(50), 4, 0, Math.PI * 2);
                ctx.fillStyle = family.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }

            // Y-axis labels
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '10px system-ui, sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (const pct of [0, 25, 50, 75, 100]) {
                ctx.fillText(pct + '%', pad.left - 5, yScale(pct));
            }

            // X-axis labels
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            const xTicks = [1];
            if (n50) xTicks.push(n50.n);
            if (n90 && n90.n !== n50?.n) xTicks.push(n90.n);
            if (maxN > 10) xTicks.push(maxN);
            for (const n of xTicks) {
                ctx.fillText(n, xScale(n), H - pad.bottom + 5);
            }

            // X-axis title
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.font = '10px system-ui, sans-serif';
            ctx.textAlign = 'center';
            const xTitle = i18n.getLang() === 'en' ? 'Settlements (sorted by votes)' : '◊ô◊ô◊©◊ï◊ë◊ô◊ù (◊ú◊§◊ô ◊û◊°◊§◊® ◊ß◊ï◊ú◊ï◊™)';
            ctx.fillText(xTitle, pad.left + plotW / 2, H - 3);

            // 50% label on chart
            if (n50) {
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.font = 'bold 10px system-ui, sans-serif';
                ctx.textAlign = 'left';
                const label50 = i18n.getLang() === 'en' ? '50% ‚Üê ' + n50.n + ' towns' : n50.n + ' ◊ô◊ô◊©◊ï◊ë◊ô◊ù ‚Üí 50%';
                ctx.fillText(label50, xScale(n50.n) + 6, yScale(50) - 2);
            }
        }

        function initStrongholds(family) {
            const grid = document.getElementById('strongholds-grid');
            if (!grid) return;

            // Find latest election with data
            let latestE = null, latestPartyName = null;
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                if (family.elections[ELECTIONS[i]]) {
                    latestE = ELECTIONS[i];
                    latestPartyName = family.elections[latestE].partyName;
                    break;
                }
            }
            if (!latestE || !allMapData[latestE]) return;

            const settlements = allMapData[latestE].settlements || [];
            const withSupport = settlements
                .filter(s => s.proportions && s.proportions[latestPartyName] != null && s.voters >= 100)
                .map(s => ({ name: s.name, pct: s.proportions[latestPartyName], lat: s.lat, lng: s.lng }))
                .sort((a, b) => b.pct - a.pct);

            const top10 = withSupport.slice(0, 10);
            const bottom10 = withSupport.slice(-10).reverse();

            function buildList(items, titleKey) {
                let html = '<div class="strongholds-list"><h4 data-i18n="' + titleKey + '">' + i18n.t(titleKey) + '</h4>';
                items.forEach(s => {
                    const display = i18n.getLang() === 'en' ? i18n.settlementName(s.name) : s.name;
                    html += '<div class="stronghold-item">';
                    html += '<a href="settlement.html?name=' + encodeURIComponent(s.name) + '">' + display + '</a>';
                    html += '<span class="stronghold-pct">' + s.pct.toFixed(1) + '%</span>';
                    html += '</div>';
                });
                html += '</div>';
                return html;
            }

            grid.innerHTML = buildList(top10, 'top_strongholds');

            // Mini map
            const mapEl = document.getElementById('strongholds-map');
            if (!mapEl) return;

            const map = L.map('strongholds-map', {
                center: [31.5, 35.0],
                zoom: 7,
                zoomControl: false,
            });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM &copy; CARTO',
                maxZoom: 19,
            }).addTo(map);

            // Color scale: low support ‚Üí grey, high support ‚Üí party color
            const maxPct = withSupport.length > 0 ? withSupport[0].pct : 50;
            withSupport.forEach(s => {
                if (!s.lat || !s.lng) return;
                const intensity = Math.min(s.pct / maxPct, 1);
                const alpha = 0.2 + intensity * 0.65;
                L.circleMarker([s.lat, s.lng], {
                    radius: 4 + intensity * 6,
                    fillColor: family.color,
                    color: '#fff',
                    weight: 0.5,
                    fillOpacity: alpha,
                }).addTo(map).bindPopup(
                    '<strong>' + s.name + '</strong><br>' + s.pct.toFixed(1) + '%'
                );
            });
        }

        function initMigration(family) {
            const select = document.getElementById('migration-select');
            const grid = document.getElementById('migration-grid');
            if (!select || !grid || !allTransfers.transitions) return;

            function render(pair) {
                const tr = allTransfers.transitions[pair];
                if (!tr) { grid.innerHTML = '<p>' + i18n.t('no_data') + '</p>'; return; }

                const [fromE, toE] = pair.split('_to_');
                const fromData = family.elections[fromE];
                const toData = family.elections[toE];

                let fromHtml = '', toHtml = '';

                // "Where voters came from" ‚Äî transfers INTO this party in toE
                if (toData) {
                    const incoming = tr.transfers.filter(t => t.target === toData.partyName && t.votes > 0)
                        .sort((a, b) => b.percentage - a.percentage)
                        .slice(0, 8);

                    // These percentages are "of the SOURCE party", we need "of the TARGET party"
                    // Recalculate: what fraction of target's votes came from each source?
                    const targetNode = tr.nodes_to.find(n => n.name === toData.partyName);
                    const targetVotes = targetNode ? targetNode.votes : 0;

                    fromHtml = '<div class="migration-panel"><h4 data-i18n="where_from">' + i18n.t('where_from') + '</h4>';
                    if (incoming.length === 0) {
                        fromHtml += '<p>' + i18n.t('no_data') + '</p>';
                    } else {
                        incoming.forEach(t => {
                            const pct = targetVotes > 0 ? (t.votes / targetVotes * 100) : 0;
                            const label = i18n.partyName(t.source);
                            fromHtml += buildMigrationBar(label, pct, family.color);
                        });
                    }
                    fromHtml += '</div>';
                } else {
                    fromHtml = '<div class="migration-panel"><h4>' + i18n.t('where_from') + '</h4><p class="merged-note">' + i18n.t('did_not_run') + '</p></div>';
                }

                // "Where voters went" ‚Äî transfers FROM this party in fromE
                if (fromData) {
                    const outgoing = tr.transfers.filter(t => t.source === fromData.partyName && t.votes > 0)
                        .sort((a, b) => b.percentage - a.percentage)
                        .slice(0, 8);

                    toHtml = '<div class="migration-panel"><h4 data-i18n="where_to">' + i18n.t('where_to') + '</h4>';
                    if (outgoing.length === 0) {
                        toHtml += '<p>' + i18n.t('no_data') + '</p>';
                    } else {
                        outgoing.forEach(t => {
                            const label = i18n.partyName(t.target);
                            toHtml += buildMigrationBar(label, t.percentage, family.color);
                        });
                    }
                    toHtml += '</div>';
                } else {
                    toHtml = '<div class="migration-panel"><h4>' + i18n.t('where_to') + '</h4><p class="merged-note">' + i18n.t('did_not_run') + '</p></div>';
                }

                grid.innerHTML = fromHtml + toHtml;
            }

            // Default: select last pair where party participated
            let defaultPair = TRANSITION_PAIRS[TRANSITION_PAIRS.length - 1];
            for (let i = TRANSITION_PAIRS.length - 1; i >= 0; i--) {
                const [f, t] = TRANSITION_PAIRS[i].split('_to_');
                if (family.elections[f] || family.elections[t]) {
                    defaultPair = TRANSITION_PAIRS[i];
                    break;
                }
            }
            select.value = defaultPair;
            render(defaultPair);

            select.addEventListener('change', () => render(select.value));
        }

        function buildMigrationBar(label, pct, color) {
            return '<div class="migration-bar-row">' +
                '<span class="migration-bar-label">' + label + '</span>' +
                '<div class="migration-bar-track"><div class="migration-bar-fill" style="width:' + Math.min(pct, 100) + '%;background:' + color + '"></div></div>' +
                '<span class="migration-bar-value">' + pct.toFixed(1) + '%</span>' +
                '</div>';
        }

        function initPartySearch() {
            const input = document.getElementById('search-input');
            const dropdown = document.getElementById('search-dropdown');
            if (!input || !dropdown) return;

            input.addEventListener('input', () => {
                const q = input.value.trim().toLowerCase();
                if (q.length < 1) { dropdown.classList.remove('visible'); return; }

                const lang = i18n.getLang();
                const matches = PARTY_FAMILIES.filter(f => {
                    const names = [f.name, f.name_en, ...Object.values(f.elections).map(e => e.partyName)];
                    return names.some(n => n && n.toLowerCase().includes(q));
                }).slice(0, 10);

                if (matches.length === 0) { dropdown.classList.remove('visible'); return; }

                dropdown.innerHTML = matches.map(f => {
                    const display = lang === 'en' ? f.name_en : f.name;
                    return '<a href="party.html?name=' + encodeURIComponent(f.name) + '">' +
                        '<span class="sdot" style="background:' + f.color + '"></span>' + display + '</a>';
                }).join('');
                dropdown.classList.add('visible');
            });

            input.addEventListener('blur', () => {
                setTimeout(() => dropdown.classList.remove('visible'), 200);
            });
        }
    })();
    </script>
</body>
</html>
