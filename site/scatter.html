<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <script>if(/Android|iPhone|iPod/i.test(navigator.userAgent)&&!location.search.includes('desktop')){var lp=new URLSearchParams(location.search).get('lang');location.replace('m/scatter.html'+(lp?'?lang='+lp:''))}</script>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
    <meta property="og:title" content="×§×•×œ×•×ª × ×•×“×“×™× â€” ×”×©×•×•××ª ××¤×œ×’×•×ª">
    <meta property="og:description" content="× ×™×ª×•×— ××™× ×˜×¨××§×˜×™×‘×™ ×©×œ × ×ª×•× ×™ ×‘×—×™×¨×•×ª ×œ×›× ×¡×ª â€” Interactive Israeli Knesset election data analysis">
    <meta property="og:image" content="https://kolot-nodedim.netlify.app/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <title>×”×©×•×•××ª ×ª××™×›×” ×‘××¤×œ×’×•×ª - ×§×•×œ×•×ª × ×•×“×“×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2a2a3a;
            --accent-primary: #3b82f6;
            --accent-secondary: #06b6d4;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .app-container {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Animated sand dunes background */
        .dunes-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 250px;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .dune {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background-repeat: repeat-x;
            background-position: bottom;
        }

        .dune-1 {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23c9a66b' fill-opacity='0.15' d='M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,218.7C672,235,768,245,864,234.7C960,224,1056,192,1152,181.3C1248,171,1344,181,1392,186.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: 1440px 180px;
            animation: dune-move-1 30s linear infinite;
            opacity: 0.9;
        }

        .dune-2 {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23d4a574' fill-opacity='0.12' d='M0,288L48,272C96,256,192,224,288,213.3C384,203,480,213,576,229.3C672,245,768,267,864,261.3C960,256,1056,224,1152,208C1248,192,1344,192,1392,192L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: 1200px 150px;
            animation: dune-move-2 25s linear infinite;
            opacity: 0.8;
        }

        .dune-3 {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23e6c9a8' fill-opacity='0.1' d='M0,256L60,245.3C120,235,240,213,360,218.7C480,224,600,256,720,261.3C840,267,960,245,1080,229.3C1200,213,1320,203,1380,197.3L1440,192L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: 1600px 200px;
            animation: dune-move-3 40s linear infinite;
            opacity: 0.7;
        }

        @keyframes dune-move-1 {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        @keyframes dune-move-2 {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(0); }
        }

        @keyframes dune-move-3 {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Header */
        .main-header {
            text-align: center;
            padding: 1.2rem 1.5rem 0.8rem;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 0.2rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title-icon {
            display: inline-block;
            margin-left: 0.5rem;
            -webkit-text-fill-color: initial;
        }

        .main-header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .view-switcher {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.6rem;
            position: relative;
            padding-left: 120px;
            padding-right: 120px;
            flex-wrap: nowrap;
        }

        .view-btn {
            padding: 0.5rem 1.5rem;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            transition: var(--transition-fast);
            cursor: pointer;
        }

        .view-btn:hover {
            background: #252535;
            color: var(--text-primary);
        }

        .view-btn.active {
            background: var(--accent-primary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1rem;
            padding: 1rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        /* Control panel */
        .control-panel {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 1.5rem;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .control-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .control-select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }

        .control-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .stats-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .stat-row:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            color: var(--text-muted);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .correlation-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .correlation-positive {
            color: #10b981;
        }

        .correlation-negative {
            color: #ef4444;
        }

        /* Scale toggle */
        .scale-toggle {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .scale-toggle .toggle-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .toggle-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .toggle-btn {
            flex: 1;
            padding: 0.4rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .toggle-btn:hover {
            background: #3a3a4a;
            color: var(--text-primary);
        }

        .toggle-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .export-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 150ms ease;
        }

        .export-btn:hover {
            background: var(--border-color);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .header-export {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Visualization */
        .visualization-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            position: relative;
            min-height: 600px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .loading::before {
            content: '';
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scatter plot */
        .station-dot {
            cursor: pointer;
            transition: opacity 0.15s ease;
        }

        .station-dot:hover {
            opacity: 1 !important;
        }

        /* Settlement hover highlighting */
        .station-dot.settlement-highlight {
            opacity: 0.95 !important;
            stroke: #fff;
            stroke-width: 1.5;
        }

        .station-dot.settlement-dim {
            opacity: 0.08 !important;
        }

        .station-dot-bg.settlement-dim {
            opacity: 0.05 !important;
        }

        .axis-label-text {
            fill: var(--text-secondary);
            font-size: 0.85rem;
        }

        .axis text {
            fill: var(--text-muted);
            font-size: 0.75rem;
        }

        .axis line, .axis path {
            stroke: var(--border-color);
        }

        .grid line {
            stroke: var(--border-color);
            stroke-opacity: 0.3;
        }

        .regression-line {
            stroke: #f59e0b;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            opacity: 0.7;
            fill: none;
        }

        .diagonal-line {
            stroke: var(--text-muted);
            stroke-width: 1;
            stroke-dasharray: 3, 3;
            opacity: 0.5;
            fill: none;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            pointer-events: none;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 280px;
            opacity: 0;
            transition: opacity var(--transition-fast);
            font-size: 0.85rem;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .tooltip-subtitle {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .tooltip-location {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .tooltip-values {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.25rem 0.75rem;
        }

        .tooltip-party {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tooltip-party-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .tooltip-pct {
            text-align: left;
            font-weight: 500;
        }

        /* Footer */
        .main-footer {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .footer-content {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
        }

        .methodology {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .methodology strong {
            color: var(--text-primary);
        }

        .credits {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .credits a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .credits a:hover {
            text-decoration: underline;
        }

        /* Swap axes button */
        .swap-axes-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.4rem;
            margin: -0.5rem 0 0.5rem;
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition-fast);
            gap: 0.4rem;
        }

        .swap-axes-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .swap-axes-btn .swap-icon {
            font-size: 1rem;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .swap-axes-btn:hover .swap-icon {
            transform: rotate(180deg);
        }

        /* Zoom */
        .zoom-rect {
            cursor: grab;
        }

        .zoom-rect:active {
            cursor: grabbing;
        }

        .reset-zoom {
            position: absolute;
            top: 12px;
            right: 12px;
            display: none;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.75rem;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition-fast);
        }

        .reset-zoom:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        /* Settlement search */
        .search-container {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
        }

        .search-result-item .station-count {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .selected-settlements {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .selected-settlement {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--accent-primary);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .selected-settlement .remove-btn {
            cursor: pointer;
            opacity: 0.7;
            font-size: 1rem;
            line-height: 1;
        }

        .selected-settlement .remove-btn:hover {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .control-panel {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .control-section {
                margin-bottom: 0;
            }
        }
    </style>
    <link rel="stylesheet" href="i18n.css">
    <script src="i18n.js"></script>
</head>
<body>
    <!-- Animated sand dunes - ×—×•×œ×•×ª × ×•×“×“×™× -->
    <div class="dunes-container">
        <div class="dune dune-3"></div>
        <div class="dune dune-2"></div>
        <div class="dune dune-1"></div>
    </div>

    <div class="app-container">
        <header class="main-header">
            <h1><span class="title-icon">ğŸ—³ï¸</span><span data-i18n="site_title">×§×•×œ×•×ª × ×•×“×“×™×</span></h1>
            <p class="subtitle" data-i18n="scatter_subtitle">×”×©×•×•××ª ×ª××™×›×” ×‘××¤×œ×’×•×ª ×œ×¤×™ ×§×œ×¤×™×•×ª</p>
            <nav class="view-switcher">
                <a href="sankey.html" class="view-btn" data-i18n="nav_sankey">× ×“×™×“×ª ×§×•×œ×•×ª</a>
                <a href="tsne.html" class="view-btn" data-i18n="nav_tsne">×”×ª×¤×œ×’×•×ª ×§×œ×¤×™×•×ª</a>
                <a href="geomap.html" class="view-btn" data-i18n="nav_geomap">××¤×” ×’×™××•×’×¨×¤×™×ª</a>
                <span class="view-btn active" data-i18n="nav_scatter">×”×©×•×•××ª ××¤×œ×’×•×ª</span>
                <a href="dhondt.html" class="view-btn" data-i18n="nav_dhondt">××—×©×‘×•×Ÿ ×‘××“×¨-×¢×•×¤×¨</a>
                <a href="irregular.html" class="view-btn" data-i18n="nav_irregular">×§×œ×¤×™×•×ª ×—×¨×™×’×•×ª</a>
                <a href="regional.html" class="view-btn" data-i18n="nav_regional">×‘×—×™×¨×•×ª ××–×•×¨×™×•×ª</a>
                <button class="export-btn header-export" id="export-png" data-i18n="export_png">ğŸ“· ×™×™×¦×•× PNG</button>
            </nav>
        </header>

        <main class="main-content">
            <aside class="control-panel">
                <div class="control-section">
                    <h3 class="control-title" data-i18n="x_axis_horizontal">×¦×™×¨ X (××•×¤×§×™)</h3>
                    <select id="election-x" class="control-select">
                        <option value="21">×›× ×¡×ª 21 (××¤×¨×™×œ 2019)</option>
                        <option value="22">×›× ×¡×ª 22 (×¡×¤×˜××‘×¨ 2019)</option>
                        <option value="23">×›× ×¡×ª 23 (××¨×¥ 2020)</option>
                        <option value="24">×›× ×¡×ª 24 (××¨×¥ 2021)</option>
                        <option value="25" selected>×›× ×¡×ª 25 (× ×•×‘××‘×¨ 2022)</option>
                    </select>
                    <select id="party-x" class="control-select">
                        <option value="">×˜×•×¢×Ÿ ××¤×œ×’×•×ª...</option>
                    </select>
                </div>

                <button class="swap-axes-btn" id="swap-axes" title="Swap X â†” Y">
                    <span class="swap-icon">â‡…</span>
                    <span data-i18n="swap_axes">×”×—×œ×£ ×¦×™×¨×™×</span>
                </button>

                <div class="control-section">
                    <h3 class="control-title" data-i18n="y_axis_vertical">×¦×™×¨ Y (×× ×›×™)</h3>
                    <select id="election-y" class="control-select">
                        <option value="21">×›× ×¡×ª 21 (××¤×¨×™×œ 2019)</option>
                        <option value="22">×›× ×¡×ª 22 (×¡×¤×˜××‘×¨ 2019)</option>
                        <option value="23">×›× ×¡×ª 23 (××¨×¥ 2020)</option>
                        <option value="24">×›× ×¡×ª 24 (××¨×¥ 2021)</option>
                        <option value="25" selected>×›× ×¡×ª 25 (× ×•×‘××‘×¨ 2022)</option>
                    </select>
                    <select id="party-y" class="control-select">
                        <option value="">×˜×•×¢×Ÿ ××¤×œ×’×•×ª...</option>
                    </select>
                </div>

                <div class="control-section">
                    <h3 class="control-title" data-i18n="display_settings">×”×’×“×¨×•×ª ×ª×¦×•×’×”</h3>
                    <div class="scale-toggle">
                        <label class="toggle-label" data-i18n="units">×™×—×™×“×•×ª:</label>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" data-units="relative" data-i18n="pct_unit">××—×•×–×™×</button>
                            <button class="toggle-btn" data-units="absolute" data-i18n="votes">×§×•×œ×•×ª</button>
                        </div>
                    </div>
                    <div class="scale-toggle" style="margin-top: 0.75rem;">
                        <label class="toggle-label" data-i18n="scale_type">×¡×•×’ ×¡×§××œ×”:</label>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" data-scale="linear" data-i18n="scale_linear">×œ×™× ××¨×™</button>
                            <button class="toggle-btn" data-scale="symlog" data-i18n="scale_log">×œ×•×’×¨×™×ª××™</button>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3 class="control-title" data-i18n="filter_by_settlement">×¡×™× ×•×Ÿ ×œ×¤×™ ×™×™×©×•×‘</h3>
                    <div class="search-container">
                        <input type="text" id="settlement-search" class="control-select" placeholder="×—×¤×© ×™×™×©×•×‘..." data-i18n-placeholder="search_settlement" style="margin-bottom: 0.5rem;">
                        <div class="search-results" id="search-results"></div>
                    </div>
                    <div class="selected-settlements" id="selected-settlements"></div>
                </div>

                <div class="control-section">
                    <h3 class="control-title" data-i18n="statistics">×¡×˜×˜×™×¡×˜×™×§×•×ª</h3>
                    <div class="stats-box">
                        <div class="stat-row">
                            <span class="stat-label" data-i18n="correlation_label">××ª××:</span>
                            <span class="stat-value correlation-value" id="correlation">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label" data-i18n="common_precincts">×§×œ×¤×™×•×ª ××©×•×ª×¤×•×ª:</span>
                            <span class="stat-value" id="station-count">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label" data-i18n="r_squared">RÂ²:</span>
                            <span class="stat-value" id="r-squared">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label" data-i18n="regression_label">××©×•×•××ª ×¨×’×¨×¡×™×”:</span>
                            <span class="stat-value" id="regression-equation" style="font-family: monospace; direction: ltr;">-</span>
                        </div>
                    </div>
                </div>

            </aside>

            <div class="visualization-container">
                <div class="loading" id="loading" data-i18n="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
                <svg id="scatter-chart"></svg>
                <div class="tooltip" id="tooltip"></div>
                <button class="reset-zoom" id="reset-zoom" data-i18n="reset_zoom">××™×¤×•×¡ ×ª×§×¨×™×‘</button>
            </div>
        </main>

        <footer class="main-footer">
            <div class="footer-content">
                <p class="methodology">
                    <strong data-i18n="methodology_short">××ª×•×“×•×œ×•×’×™×”:</strong>
                    <span data-i18n="scatter_methodology_text">×›×œ × ×§×•×“×” ××™×™×¦×’×ª ×§×œ×¤×™ ××—×ª. ××™×§×•× ×”× ×§×•×“×” × ×§×‘×¢ ×œ×¤×™ ××—×•×– ×”×ª××™×›×” ×‘××¤×œ×’×” ×”× ×‘×—×¨×ª ×‘×¦×™×¨ X (××•×¤×§×™) ×•×‘×¦×™×¨ Y (×× ×›×™).
                    × ×™×ª×Ÿ ×œ×”×©×•×•×ª ××¤×œ×’×•×ª ×××•×ª×Ÿ ×‘×—×™×¨×•×ª ××• ××‘×—×™×¨×•×ª ×©×•× ×•×ª - ×‘××§×¨×” ×©×œ ×‘×—×™×¨×•×ª ×©×•× ×•×ª, ××•×¦×’×•×ª ×¨×§ ×§×œ×¤×™×•×ª ×©×§×™×™××•×ª ×‘×©×ª×™ ×”×‘×—×™×¨×•×ª.
                    ×§×• ×”××’××” (××§×•×•×§×•) ××¦×™×’ ××ª ×§×• ×”×¨×’×¨×¡×™×” ×”×œ×™× ×™××¨×™×ª.</span>
                </p>
                <p class="credits">
                    <span data-i18n="credits_line">Â© ×”×¨××œ ×§×™×Ÿ</span> |
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> |
                    <a href="https://github.com/harelc/elections-vote-transfer/" target="_blank" data-i18n="source_code">×§×•×“ ××§×•×¨</a>
                </p>
            </div>
        </footer>
    </div>

    <script>
        class ScatterVisualization {
            constructor() {
                this.electionsData = {};
                this.currentElectionX = '25';
                this.currentElectionY = '25';
                this.currentPartyX = null;
                this.currentPartyY = null;
                this.scaleType = 'linear'; // 'linear' or 'symlog'
                this.unitsMode = 'relative'; // 'relative' (%) or 'absolute' (vote count)
                this.selectedSettlements = []; // Array of selected settlement names for filtering
                this.settlements = []; // List of settlements with counts
                this.tooltip = d3.select('#tooltip');

                // Election metadata for labels
                this.electionMeta = {
                    '21': { he: '×›× ×¡×ª 21 (××¤×¨×™×œ 2019)',    en: 'Knesset 21 (April 2019)' },
                    '22': { he: '×›× ×¡×ª 22 (×¡×¤×˜××‘×¨ 2019)',    en: 'Knesset 22 (September 2019)' },
                    '23': { he: '×›× ×¡×ª 23 (××¨×¥ 2020)',       en: 'Knesset 23 (March 2020)' },
                    '24': { he: '×›× ×¡×ª 24 (××¨×¥ 2021)',       en: 'Knesset 24 (March 2021)' },
                    '25': { he: '×›× ×¡×ª 25 (× ×•×‘××‘×¨ 2022)',    en: 'Knesset 25 (November 2022)' },
                };
                if (i18n.SHOW_E26) this.electionMeta['26'] = { he: '×›× ×¡×ª 26 (2026)', en: 'Knesset 26 (2026)' };

                this.init();
            }

            /** Get localized election label for a given election ID */
            electionLabel(id) {
                const meta = this.electionMeta[id];
                if (!meta) return id;
                return meta[i18n.getLang()] || meta.he;
            }

            /** Get short localized election label (e.g., "Knesset 25" / "×›× ×¡×ª 25") */
            electionShort(id) {
                return i18n.getLang() === 'en' ? `Knesset ${id}` : `×›× ×¡×ª ${id}`;
            }

            async init() {
                // Set up event listeners
                document.getElementById('election-x').addEventListener('change', async (e) => {
                    this.currentElectionX = e.target.value;
                    this.settlements = []; // Reset settlements list
                    await this.loadElectionParties('x', e.target.value, false);
                    this.updateChart();
                });

                document.getElementById('election-y').addEventListener('change', async (e) => {
                    this.currentElectionY = e.target.value;
                    this.settlements = []; // Reset settlements list
                    await this.loadElectionParties('y', e.target.value, false);
                    this.updateChart();
                });

                document.getElementById('party-x').addEventListener('change', (e) => {
                    this.currentPartyX = e.target.value;
                    this.updateChart();
                });

                document.getElementById('party-y').addEventListener('change', (e) => {
                    this.currentPartyY = e.target.value;
                    this.updateChart();
                });

                // Units toggle buttons
                document.querySelectorAll('.toggle-btn[data-units]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.toggle-btn[data-units]').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.unitsMode = e.target.dataset.units;
                        this.updateChart();
                    });
                });

                // Scale toggle buttons
                document.querySelectorAll('.toggle-btn[data-scale]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.toggle-btn[data-scale]').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.scaleType = e.target.dataset.scale;
                        this.updateChart();
                    });
                });

                // Export PNG button
                document.getElementById('export-png').addEventListener('click', () => this.exportPNG());

                // Swap axes button
                document.getElementById('swap-axes').addEventListener('click', () => this.swapAxes());

                // Reset zoom button
                document.getElementById('reset-zoom').addEventListener('click', () => this.resetZoom());

                // Settlement search
                const searchInput = document.getElementById('settlement-search');
                const searchResults = document.getElementById('search-results');

                searchInput.addEventListener('input', (e) => {
                    this.handleSearchInput(e.target.value);
                });

                searchInput.addEventListener('focus', () => {
                    if (searchInput.value.length > 0) {
                        this.handleSearchInput(searchInput.value);
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        searchResults.classList.remove('visible');
                    }
                });

                // Listen for language changes
                window.addEventListener('langchange', () => {
                    this.rebuildElectionDropdowns();
                    this.rebuildPartyDropdowns();
                    this.updateChart();
                });

                // Rebuild election dropdowns for current language
                this.rebuildElectionDropdowns();

                // Load initial data (don't update chart until both are loaded)
                await this.loadElectionParties('x', '25', false);
                await this.loadElectionParties('y', '25', false);
                this.updateChart();
            }

            /** Rebuild election select options with current language */
            rebuildElectionDropdowns() {
                ['election-x', 'election-y'].forEach(id => {
                    const select = document.getElementById(id);
                    const currentVal = select.value;
                    select.innerHTML = Object.keys(this.electionMeta).map(eid =>
                        `<option value="${eid}"${eid === currentVal ? ' selected' : ''}>${this.electionLabel(eid)}</option>`
                    ).join('');
                });
            }

            /** Rebuild party select options with current language (preserving selection) */
            rebuildPartyDropdowns() {
                ['x', 'y'].forEach(axis => {
                    const electionId = axis === 'x' ? this.currentElectionX : this.currentElectionY;
                    const data = this.electionsData[electionId];
                    if (!data) return;
                    const select = document.getElementById(`party-${axis}`);
                    const currentVal = axis === 'x' ? this.currentPartyX : this.currentPartyY;
                    select.innerHTML = data.parties.map(p =>
                        `<option value="${p.name}"${p.name === currentVal ? ' selected' : ''}>${i18n.partyName(p)}</option>`
                    ).join('');
                });
            }

            buildSettlementsList() {
                // Build from the intersection of both elections' data
                const settlements = {};

                const dataX = this.electionsData[this.currentElectionX];
                const dataY = this.electionsData[this.currentElectionY];

                if (!dataX || !dataY) return;

                // Build lookup for X stations (exact keys)
                const lookupX = {};
                dataX.stations.forEach(s => {
                    const key = this.normalizeKey(s);
                    lookupX[key] = s;
                });

                // Track which base keys have a .0 variant in Y
                const yBaseKeys = new Set();
                dataY.stations.forEach(s => {
                    const ballot = String(s.b || s.ballot_number || '');
                    if (ballot.endsWith('.0')) {
                        yBaseKeys.add(this.normalizeKey(s));
                    }
                });

                // Count matching stations per settlement
                // Matching: exact first, then only .1 falls back to base (if no .0 sibling)
                dataY.stations.forEach(s => {
                    const key = this.normalizeKey(s);
                    let matched = lookupX[key];

                    // If no exact match, try base ballot fallback
                    if (!matched) {
                        const ballot = String(s.b || s.ballot_number || '');
                        // Only .1 subdivisions can fall back (not .2, .3, etc.)
                        if (ballot.endsWith('.1')) {
                            const baseKey = this.getBaseKey(key);
                            if (!yBaseKeys.has(baseKey)) {
                                matched = lookupX[baseKey];
                            }
                        }
                    }

                    if (matched) {
                        const name = s.n || s.settlement_name;
                        settlements[name] = (settlements[name] || 0) + 1;
                    }
                });

                this.settlements = Object.entries(settlements)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count);
            }

            handleSearchInput(query) {
                const searchResults = document.getElementById('search-results');

                if (query.length < 1) {
                    searchResults.classList.remove('visible');
                    return;
                }

                // Build list if not already done
                if (this.settlements.length === 0) {
                    this.buildSettlementsList();
                }

                const matches = this.settlements
                    .filter(s => i18n.settlementMatches(s.name, query))
                    .slice(0, 15);

                if (matches.length === 0) {
                    searchResults.classList.remove('visible');
                    return;
                }

                searchResults.innerHTML = matches.map(s => `
                    <div class="search-result-item" data-settlement="${s.name}">
                        ${i18n.settlementName(s.name)}
                        <span class="station-count">${i18n.fmtNum(s.count)} ${i18n.t('ballot')}</span>
                    </div>
                `).join('');

                searchResults.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.selectSettlement(item.dataset.settlement);
                    });
                });

                searchResults.classList.add('visible');
            }

            selectSettlement(name) {
                if (this.selectedSettlements.includes(name)) {
                    return;
                }

                this.selectedSettlements.push(name);
                this.updateSelectedSettlementsUI();
                document.getElementById('settlement-search').value = '';
                document.getElementById('search-results').classList.remove('visible');
                this.updateChart();
            }

            removeSettlement(name) {
                this.selectedSettlements = this.selectedSettlements.filter(s => s !== name);
                this.updateSelectedSettlementsUI();
                this.updateChart();
            }

            swapAxes() {
                // Swap elections
                const tmpElection = this.currentElectionX;
                this.currentElectionX = this.currentElectionY;
                this.currentElectionY = tmpElection;

                // Swap parties
                const tmpParty = this.currentPartyX;
                this.currentPartyX = this.currentPartyY;
                this.currentPartyY = tmpParty;

                // Update dropdowns
                document.getElementById('election-x').value = this.currentElectionX;
                document.getElementById('election-y').value = this.currentElectionY;

                // Rebuild party dropdowns for possibly different elections, then set values
                const dataX = this.electionsData[this.currentElectionX];
                const dataY = this.electionsData[this.currentElectionY];
                if (dataX) {
                    const selectX = document.getElementById('party-x');
                    selectX.innerHTML = dataX.parties.map(p =>
                        `<option value="${p.name}">${i18n.partyName(p)}</option>`
                    ).join('');
                    selectX.value = this.currentPartyX;
                }
                if (dataY) {
                    const selectY = document.getElementById('party-y');
                    selectY.innerHTML = dataY.parties.map(p =>
                        `<option value="${p.name}">${i18n.partyName(p)}</option>`
                    ).join('');
                    selectY.value = this.currentPartyY;
                }

                this.settlements = [];
                this.updateChart();
            }

            resetZoom() {
                if (this._zoom && this._zoomG) {
                    this._zoomG.transition().duration(300)
                        .call(this._zoom.transform, d3.zoomIdentity);
                }
            }

            updateSelectedSettlementsUI() {
                const container = document.getElementById('selected-settlements');
                container.innerHTML = this.selectedSettlements.map(name => `
                    <div class="selected-settlement">
                        <span>${i18n.settlementName(name)}</span>
                        <span class="remove-btn" data-settlement="${name}">Ã—</span>
                    </div>
                `).join('');

                container.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.removeSettlement(btn.dataset.settlement);
                    });
                });
            }

            async loadElectionData(electionId) {
                if (this.electionsData[electionId]) {
                    return this.electionsData[electionId];
                }

                const response = await fetch(`data/tsne_${electionId}.json`);
                const data = await response.json();
                this.electionsData[electionId] = data;
                return data;
            }

            async loadElectionParties(axis, electionId, autoUpdateChart = true) {
                const data = await this.loadElectionData(electionId);
                const select = document.getElementById(`party-${axis}`);
                const partyNames = data.parties.map(p => p.name);

                // Get current selection before rebuilding options
                const currentSelection = axis === 'x' ? this.currentPartyX : this.currentPartyY;

                // Rebuild options
                select.innerHTML = data.parties.map(p =>
                    `<option value="${p.name}">${i18n.partyName(p)}</option>`
                ).join('');

                // Try to keep the same party selected if it exists in the new election
                let newSelection;
                if (currentSelection && partyNames.includes(currentSelection)) {
                    newSelection = currentSelection;
                } else {
                    // Fall back to first party (or second for Y if same election)
                    if (axis === 'x') {
                        newSelection = data.parties[0].name;
                    } else {
                        const defaultIndex = (this.currentElectionX === this.currentElectionY && data.parties.length > 1) ? 1 : 0;
                        newSelection = data.parties[defaultIndex].name;
                    }
                }

                // Update both the select element and the state variable
                select.value = newSelection;
                if (axis === 'x') {
                    this.currentPartyX = newSelection;
                } else {
                    this.currentPartyY = newSelection;
                }

                if (autoUpdateChart) {
                    this.updateChart();
                }
            }

            normalizeKey(station, forceBase = false) {
                const settlement = station.n || station.settlement_name || '';
                let ballot = String(station.b || station.ballot_number || '');
                // Remove trailing .0
                if (ballot.endsWith('.0')) {
                    ballot = ballot.slice(0, -2);
                }
                // If forceBase, get base ballot number (14.1 -> 14)
                if (forceBase && ballot.includes('.')) {
                    ballot = ballot.split('.')[0];
                }
                return `${settlement}|${ballot}`;
            }

            getBaseKey(key) {
                // Convert "settlement|14.1" to "settlement|14"
                // Used for fallback matching when .0 variant doesn't exist
                const parts = key.split('|');
                if (parts.length === 2 && parts[1].includes('.')) {
                    return parts[0] + '|' + parts[1].split('.')[0];
                }
                return key;
            }

            getSiblingZeroKey(key) {
                // Convert "settlement|14.1" to "settlement|14.0"
                // Used to check if .0 variant exists
                const parts = key.split('|');
                if (parts.length === 2 && /\.\d+$/.test(parts[1])) {
                    const base = parts[1].split('.')[0];
                    return parts[0] + '|' + base + '.0';
                }
                return null;
            }

            getPartyValue(station, partyName, unitsMode) {
                const props = station.p || station.proportions || {};
                const totalVoters = station.v || station.total_voters || 0;

                const percentage = props[partyName] || 0;
                if (unitsMode === 'absolute') {
                    // Convert percentage to absolute votes
                    return Math.round(totalVoters * percentage / 100);
                }
                return percentage;
            }

            async updateChart() {
                if (!this.currentPartyX || !this.currentPartyY) return;

                const dataX = await this.loadElectionData(this.currentElectionX);
                const dataY = await this.loadElectionData(this.currentElectionY);

                const partyX = dataX.parties.find(p => p.name === this.currentPartyX);
                const partyY = dataY.parties.find(p => p.name === this.currentPartyY);

                if (!partyX || !partyY) return;

                // Build lookup for matching stations (exact keys)
                const lookupX = {};
                dataX.stations.forEach(s => {
                    const key = this.normalizeKey(s);
                    lookupX[key] = {
                        station: s,
                        value: this.getPartyValue(s, this.currentPartyX, this.unitsMode)
                    };
                });

                // Build set of normalized Y keys to check for .0 siblings
                // Note: .0 ballots normalize to base, so we track which bases have a .0 variant
                const yBaseKeys = new Set();
                dataY.stations.forEach(s => {
                    const ballot = String(s.b || s.ballot_number || '');
                    if (ballot.endsWith('.0')) {
                        // This base has a .0 variant
                        yBaseKeys.add(this.normalizeKey(s));
                    }
                });

                // Find matching stations and build plot data
                // Matching logic:
                // - Exact match first (including 177.0 normalized to 177)
                // - Only .1 can fall back to base, and only if no .0 sibling exists in Y
                const plotData = [];
                dataY.stations.forEach(s => {
                    const key = this.normalizeKey(s);
                    let matchedX = lookupX[key];

                    // If no exact match, try base ballot fallback
                    if (!matchedX) {
                        const ballot = String(s.b || s.ballot_number || '');
                        // Only .1 subdivisions can fall back (not .2, .3, etc.)
                        if (ballot.endsWith('.1')) {
                            const baseKey = this.getBaseKey(key);
                            // Only fall back to base if no .0 sibling exists
                            if (!yBaseKeys.has(baseKey)) {
                                matchedX = lookupX[baseKey];
                            }
                        }
                    }

                    if (matchedX) {
                        plotData.push({
                            key,
                            settlement: s.n || s.settlement_name,
                            ballot: s.b || s.ballot_number,
                            location: s.l || '',
                            x: matchedX.value,
                            y: this.getPartyValue(s, this.currentPartyY, this.unitsMode),
                            voters: s.v || s.total_voters || 0
                        });
                    }
                });

                // Filter by selected settlements if any
                const filteredData = this.selectedSettlements.length > 0
                    ? plotData.filter(d => this.selectedSettlements.includes(d.settlement))
                    : plotData;

                this.render(filteredData, partyX, partyY, plotData);
            }

            render(data, partyX, partyY, allData = null) {
                const container = document.querySelector('.visualization-container');
                const hasFilter = this.selectedSettlements.length > 0;
                const backgroundData = hasFilter && allData ? allData : null;
                const width = container.clientWidth;
                const height = Math.max(container.clientHeight, 600);
                const margin = { top: 40, right: 40, bottom: 60, left: 70 };
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('reset-zoom').style.display = 'none';

                // Clear and setup SVG
                const svg = d3.select('#scatter-chart');
                svg.selectAll('*').remove();
                svg.attr('width', width).attr('height', height);

                // Clip path for plot area
                svg.append('defs').append('clipPath')
                    .attr('id', 'plot-clip')
                    .append('rect')
                    .attr('width', innerWidth)
                    .attr('height', innerHeight);

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);

                // Base scales
                const scaleData = backgroundData || data;
                const maxX = Math.max(d3.max(scaleData, d => d.x) || 50, 10);
                const maxY = Math.max(d3.max(scaleData, d => d.y) || 50, 10);
                const maxVal = Math.max(maxX, maxY);

                let xScale0, yScale0;
                if (this.scaleType === 'symlog') {
                    xScale0 = d3.scaleSymlog().domain([0, maxVal * 1.05]).range([0, innerWidth]).constant(1);
                    yScale0 = d3.scaleSymlog().domain([0, maxVal * 1.05]).range([innerHeight, 0]).constant(1);
                } else {
                    xScale0 = d3.scaleLinear().domain([0, maxVal * 1.05]).range([0, innerWidth]);
                    yScale0 = d3.scaleLinear().domain([0, maxVal * 1.05]).range([innerHeight, 0]);
                }

                let xScale = xScale0.copy();
                let yScale = yScale0.copy();

                const formatTick = this.unitsMode === 'absolute'
                    ? d => d >= 1000 ? (d / 1000).toFixed(0) + 'K' : d
                    : d => d + '%';

                // Layer groups
                const gridG = g.append('g').attr('class', 'grid-layer');
                const clipG = g.append('g').attr('clip-path', 'url(#plot-clip)');
                const xAxisG = g.append('g').attr('class', 'axis').attr('transform', `translate(0, ${innerHeight})`);
                const yAxisG = g.append('g').attr('class', 'axis');

                const regression = this.calculateRegression(data);
                const self = this;

                // Create dot elements (positions set in updatePositions)
                if (backgroundData) {
                    clipG.selectAll('.station-dot-bg')
                        .data(backgroundData)
                        .join('circle')
                        .attr('class', 'station-dot-bg')
                        .attr('r', 2)
                        .attr('fill', '#374151')
                        .attr('opacity', 0.3);
                }

                clipG.selectAll('.station-dot')
                    .data(data)
                    .join('circle')
                    .attr('class', 'station-dot')
                    .attr('r', hasFilter ? 4 : 3)
                    .attr('fill', d => {
                        const t = d.x + d.y > 0 ? d.x / (d.x + d.y) : 0.5;
                        return d3.interpolateRgb(partyY.color, partyX.color)(t);
                    })
                    .attr('opacity', hasFilter ? 0.8 : 0.5)
                    .on('mouseenter', (event, d) => {
                        self.showTooltip(event, d, partyX, partyY);
                        self.highlightSettlement(d.settlement, clipG);
                    })
                    .on('mousemove', (event) => self.moveTooltip(event))
                    .on('mouseleave', () => {
                        self.hideTooltip();
                        self.clearHighlight(clipG);
                    });

                // Positions update function (called on zoom and initial draw)
                const updatePositions = () => {
                    // Grid
                    gridG.selectAll('*').remove();
                    gridG.selectAll('.gx').data(xScale.ticks(10)).join('line').attr('class', 'gx')
                        .attr('x1', d => xScale(d)).attr('x2', d => xScale(d))
                        .attr('y1', 0).attr('y2', innerHeight);
                    gridG.selectAll('.gy').data(yScale.ticks(10)).join('line').attr('class', 'gy')
                        .attr('x1', 0).attr('x2', innerWidth)
                        .attr('y1', d => yScale(d)).attr('y2', d => yScale(d));

                    // Axes
                    xAxisG.call(d3.axisBottom(xScale).tickFormat(formatTick));
                    yAxisG.call(d3.axisLeft(yScale).tickFormat(formatTick));

                    // Diagonal
                    clipG.selectAll('.diagonal-line').remove();
                    if (self.scaleType === 'symlog') {
                        const pts = [];
                        for (let i = 0; i <= 100; i++) { const v = maxVal * i / 100; pts.push([v, v]); }
                        clipG.append('path').attr('class', 'diagonal-line')
                            .attr('d', d3.line().x(d => xScale(d[0])).y(d => yScale(d[1]))(pts));
                    } else {
                        clipG.append('line').attr('class', 'diagonal-line')
                            .attr('x1', xScale(0)).attr('y1', yScale(0))
                            .attr('x2', xScale(maxVal)).attr('y2', yScale(maxVal));
                    }

                    // Regression
                    clipG.selectAll('.regression-line').remove();
                    if (regression) {
                        if (self.scaleType === 'symlog') {
                            const pts = [];
                            for (let i = 0; i <= 100; i++) {
                                const x = maxVal * i / 100;
                                const y = regression.intercept + regression.slope * x;
                                if (y >= 0 && y <= maxVal * 1.05) pts.push([x, y]);
                            }
                            clipG.append('path').attr('class', 'regression-line')
                                .attr('d', d3.line().x(d => xScale(d[0])).y(d => yScale(d[1]))(pts));
                        } else {
                            const x1 = 0, x2 = maxVal;
                            clipG.append('line').attr('class', 'regression-line')
                                .attr('x1', xScale(x1)).attr('y1', yScale(Math.max(0, regression.intercept + regression.slope * x1)))
                                .attr('x2', xScale(x2)).attr('y2', yScale(Math.max(0, regression.intercept + regression.slope * x2)));
                        }
                    }

                    // Dot positions
                    clipG.selectAll('.station-dot-bg')
                        .attr('cx', d => xScale(d.x)).attr('cy', d => yScale(d.y));
                    clipG.selectAll('.station-dot')
                        .attr('cx', d => xScale(d.x)).attr('cy', d => yScale(d.y));
                };

                // Initial draw
                updatePositions();

                // Axis labels (outside clip, static)
                svg.append('text')
                    .attr('class', 'axis-label-text')
                    .attr('x', margin.left + innerWidth / 2)
                    .attr('y', height - 10)
                    .attr('text-anchor', 'middle')
                    .text(`${i18n.partyName(this.currentPartyX)} (${this.electionShort(this.currentElectionX)})`);

                svg.append('text')
                    .attr('class', 'axis-label-text')
                    .attr('transform', 'rotate(-90)')
                    .attr('x', -(margin.top + innerHeight / 2))
                    .attr('y', 20)
                    .attr('text-anchor', 'middle')
                    .text(`${i18n.partyName(this.currentPartyY)} (${this.electionShort(this.currentElectionY)})`);

                // Zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([1, 20])
                    .translateExtent([[0, 0], [innerWidth, innerHeight]])
                    .extent([[0, 0], [innerWidth, innerHeight]])
                    .on('zoom', (event) => {
                        xScale = event.transform.rescaleX(xScale0);
                        yScale = event.transform.rescaleY(yScale0);
                        updatePositions();
                        const isZoomed = event.transform.k !== 1;
                        document.getElementById('reset-zoom').style.display = isZoomed ? 'flex' : 'none';
                    });

                // Transparent rect for zoom hit area (behind content but zoom attached to g)
                g.insert('rect', ':first-child')
                    .attr('class', 'zoom-rect')
                    .attr('width', innerWidth)
                    .attr('height', innerHeight)
                    .attr('fill', 'transparent');

                g.call(zoom);
                this._zoom = zoom;
                this._zoomG = g;

                // Update stats
                this.updateStats(data, regression);
            }

            calculateRegression(data) {
                if (data.length < 2) return null;

                const n = data.length;
                const sumX = d3.sum(data, d => d.x);
                const sumY = d3.sum(data, d => d.y);
                const sumXY = d3.sum(data, d => d.x * d.y);
                const sumX2 = d3.sum(data, d => d.x * d.x);
                const sumY2 = d3.sum(data, d => d.y * d.y);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                // Correlation coefficient
                const correlation = (n * sumXY - sumX * sumY) /
                    Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

                return { slope, intercept, correlation, rSquared: correlation * correlation };
            }

            updateStats(data, regression) {
                document.getElementById('station-count').textContent = i18n.fmtNum(data.length);

                if (regression) {
                    const corrEl = document.getElementById('correlation');
                    const corr = regression.correlation.toFixed(3);
                    corrEl.textContent = corr;
                    corrEl.className = `stat-value correlation-value ${regression.correlation >= 0 ? 'correlation-positive' : 'correlation-negative'}`;

                    document.getElementById('r-squared').textContent = regression.rSquared.toFixed(3);

                    // Format regression equation: y = mx + b
                    const slope = regression.slope.toFixed(2);
                    const intercept = regression.intercept.toFixed(2);
                    const sign = regression.intercept >= 0 ? '+' : '';
                    document.getElementById('regression-equation').textContent = `y = ${slope}x ${sign}${intercept}`;
                } else {
                    document.getElementById('correlation').textContent = '-';
                    document.getElementById('r-squared').textContent = '-';
                    document.getElementById('regression-equation').textContent = '-';
                }
            }

            showTooltip(event, d, partyX, partyY) {
                const locationHtml = d.location ? `<div class="tooltip-location">${d.location}</div>` : '';
                const formatValue = (val) => {
                    if (this.unitsMode === 'absolute') {
                        return i18n.fmtNum(val) + ' ' + i18n.t('votes');
                    }
                    return val.toFixed(1) + '%';
                };
                const partyXName = i18n.partyName(partyX);
                const partyYName = i18n.partyName(partyY);
                const elXShort = this.electionShort(this.currentElectionX);
                const elYShort = this.electionShort(this.currentElectionY);
                const votersLabel = i18n.getLang() === 'en' ? 'Voters' : '××¦×‘×™×¢×™×';
                const html = `
                    <div class="tooltip-title">${i18n.settlementName(d.settlement)}</div>
                    <div class="tooltip-subtitle">${i18n.t('ballot')} ${d.ballot} Â· ${votersLabel}: ${i18n.fmtNum(d.voters)}</div>
                    ${locationHtml}
                    <div class="tooltip-values">
                        <div class="tooltip-party">
                            <span class="tooltip-party-color" style="background: ${partyX.color}"></span>
                            ${partyXName} (${elXShort}):
                        </div>
                        <span class="tooltip-pct">${formatValue(d.x)}</span>
                        <div class="tooltip-party">
                            <span class="tooltip-party-color" style="background: ${partyY.color}"></span>
                            ${partyYName} (${elYShort}):
                        </div>
                        <span class="tooltip-pct">${formatValue(d.y)}</span>
                    </div>
                    <div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border-color)">
                        <a href="settlement.html?name=${encodeURIComponent(d.settlement)}" style="color:#3b82f6;text-decoration:none;font-size:0.85em">${i18n.t('go_to_profile')} \u2192</a>
                    </div>
                `;
                this.tooltip.html(html).classed('visible', true);
                this.moveTooltip(event);
            }

            moveTooltip(event) {
                const tooltipRect = this.tooltip.node().getBoundingClientRect();
                let x = event.clientX - tooltipRect.width - 15;
                let y = event.clientY - tooltipRect.height / 2;

                if (x < 10) x = event.clientX + 15;
                if (y < 10) y = 10;
                if (y + tooltipRect.height > window.innerHeight - 10) {
                    y = window.innerHeight - tooltipRect.height - 10;
                }

                this.tooltip
                    .style('left', x + 'px')
                    .style('top', y + 'px');
            }

            hideTooltip() {
                this.tooltip.classed('visible', false);
            }

            highlightSettlement(settlement, g) {
                g.selectAll('.station-dot')
                    .each(function(d) {
                        const el = d3.select(this);
                        if (d.settlement === settlement) {
                            el.classed('settlement-highlight', true).classed('settlement-dim', false);
                        } else {
                            el.classed('settlement-dim', true).classed('settlement-highlight', false);
                        }
                    });
                g.selectAll('.station-dot-bg')
                    .classed('settlement-dim', true);
            }

            clearHighlight(g) {
                g.selectAll('.station-dot')
                    .classed('settlement-highlight', false)
                    .classed('settlement-dim', false);
                g.selectAll('.station-dot-bg')
                    .classed('settlement-dim', false);
            }

            generateQRCodeDataURL() {
                // Pre-computed QR code for https://kolot-nodedim.netlify.app/
                const qrMatrix = [
                    [1,1,1,1,1,1,1,0,1,0,0,0,1,1,1,0,0,0,1,1,1,1,1,1,1],
                    [1,0,0,0,0,0,1,0,0,1,0,1,1,0,0,0,1,0,1,0,0,0,0,0,1],
                    [1,0,1,1,1,0,1,0,1,1,0,0,0,1,1,0,1,0,1,0,1,1,1,0,1],
                    [1,0,1,1,1,0,1,0,0,0,1,0,1,0,0,1,0,0,1,0,1,1,1,0,1],
                    [1,0,1,1,1,0,1,0,1,0,1,1,0,0,1,1,1,0,1,0,1,1,1,0,1],
                    [1,0,0,0,0,0,1,0,0,1,1,0,1,0,1,0,0,0,1,0,0,0,0,0,1],
                    [1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1],
                    [0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0],
                    [1,0,1,1,0,1,1,1,1,0,1,0,0,0,1,0,0,1,1,0,0,1,0,1,0],
                    [0,1,0,0,1,0,0,1,0,0,0,1,1,0,1,1,0,0,0,1,0,0,1,0,1],
                    [1,1,0,1,0,0,1,0,0,1,0,1,0,1,0,0,1,1,0,0,1,0,0,1,0],
                    [0,0,1,1,0,1,0,0,1,0,1,0,1,0,1,0,0,1,0,1,1,0,1,0,1],
                    [0,0,0,1,1,0,1,0,1,1,0,0,1,1,0,1,1,0,1,0,0,1,1,0,0],
                    [0,1,1,0,0,1,0,1,0,1,1,0,0,1,0,0,0,0,1,1,0,0,0,1,1],
                    [1,0,1,0,1,0,1,0,1,0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0],
                    [0,1,0,1,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0,1],
                    [1,0,0,1,1,1,1,0,1,1,1,0,1,1,1,0,0,1,1,1,1,1,0,1,0],
                    [0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,0,0,1,1],
                    [1,1,1,1,1,1,1,0,1,0,1,0,0,0,1,0,0,0,1,0,1,1,1,0,0],
                    [1,0,0,0,0,0,1,0,0,0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1],
                    [1,0,1,1,1,0,1,0,1,1,1,1,0,1,1,0,0,1,1,1,1,1,0,1,0],
                    [1,0,1,1,1,0,1,0,0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,0,1],
                    [1,0,1,1,1,0,1,0,1,0,0,1,0,0,1,1,1,1,0,1,1,0,1,1,0],
                    [1,0,0,0,0,0,1,0,0,0,1,1,0,0,0,1,0,0,0,1,1,0,0,1,1],
                    [1,1,1,1,1,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,1,1,1,0,0]
                ];

                const size = 25;
                const cellSize = 4;
                const canvasSize = size * cellSize;
                const canvas = document.createElement('canvas');
                canvas.width = canvasSize;
                canvas.height = canvasSize;
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvasSize, canvasSize);

                ctx.fillStyle = '#000000';
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        if (qrMatrix[y][x]) {
                            ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                        }
                    }
                }

                return canvas.toDataURL('image/png');
            }

            exportPNG() {
                const svgElement = document.getElementById('scatter-chart');
                if (!svgElement) return;

                // Clone the SVG
                const svgClone = svgElement.cloneNode(true);

                // Add background
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '100%');
                rect.setAttribute('height', '100%');
                rect.setAttribute('fill', '#12121a');
                svgClone.insertBefore(rect, svgClone.firstChild);

                // Inline styles for elements (CSS variables not applied in export)
                svgClone.querySelectorAll('.diagonal-line').forEach(el => {
                    el.setAttribute('stroke', '#606075');
                    el.setAttribute('stroke-width', '1');
                    el.setAttribute('stroke-dasharray', '3, 3');
                    el.setAttribute('opacity', '0.5');
                    el.setAttribute('fill', 'none');
                });
                svgClone.querySelectorAll('.regression-line').forEach(el => {
                    el.setAttribute('stroke', '#f59e0b');
                    el.setAttribute('stroke-width', '2');
                    el.setAttribute('stroke-dasharray', '5, 5');
                    el.setAttribute('opacity', '0.8');
                    el.setAttribute('fill', 'none');
                });
                // Axis labels (party names on axes) - with font
                svgClone.querySelectorAll('.axis-label-text').forEach(el => {
                    el.setAttribute('fill', '#a0a0b0');
                    el.setAttribute('font-family', 'Heebo, sans-serif');
                    el.setAttribute('font-size', '14px');
                });
                // Axis tick labels (percentages) - with font
                svgClone.querySelectorAll('.axis text').forEach(el => {
                    el.setAttribute('fill', '#94a3b8');
                    el.setAttribute('font-family', 'Heebo, sans-serif');
                    el.setAttribute('font-size', '12px');
                });
                // Axis lines
                svgClone.querySelectorAll('.axis line, .axis path').forEach(el => {
                    el.setAttribute('stroke', '#2a2a3a');
                });
                // Grid lines
                svgClone.querySelectorAll('.grid line').forEach(el => {
                    el.setAttribute('stroke', '#2a2a3a');
                    el.setAttribute('stroke-opacity', '0.3');
                });

                // Get dimensions
                const svgWidth = parseInt(svgElement.getAttribute('width') || svgElement.clientWidth);
                const svgHeight = parseInt(svgElement.getAttribute('height') || svgElement.clientHeight);

                // Layout
                const headerHeight = 70;
                const infoHeight = 40;
                const watermarkHeight = 60;
                const scale = 2;
                const totalHeight = svgHeight + headerHeight + infoHeight + watermarkHeight;

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = svgWidth * scale;
                canvas.height = totalHeight * scale;
                const ctx = canvas.getContext('2d');
                ctx.scale(scale, scale);

                // Draw background
                ctx.fillStyle = '#0a0a0f';
                ctx.fillRect(0, 0, svgWidth, totalHeight);

                // Draw header
                ctx.fillStyle = '#12121a';
                ctx.fillRect(0, 0, svgWidth, headerHeight);

                // Title
                ctx.fillStyle = '#f8fafc';
                ctx.font = 'bold 18px Heebo, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(i18n.t('scatter_title'), svgWidth / 2, 28);

                // Subtitle with axis info
                ctx.fillStyle = '#94a3b8';
                ctx.font = '13px Heebo, sans-serif';
                const partyXLabel = i18n.partyName(this.currentPartyX);
                const partyYLabel = i18n.partyName(this.currentPartyY);
                const elXLabel = this.electionShort(this.currentElectionX);
                const elYLabel = this.electionShort(this.currentElectionY);
                const vsWord = i18n.getLang() === 'en' ? 'vs' : '××•×œ';
                const subtitle = `${partyXLabel} (${elXLabel}) ${vsWord} ${partyYLabel} (${elYLabel})`;
                ctx.fillText(subtitle, svgWidth / 2, 52);

                // Chart area
                ctx.fillStyle = '#12121a';
                ctx.fillRect(0, headerHeight, svgWidth, svgHeight);

                // Serialize and draw SVG
                const svgData = new XMLSerializer().serializeToString(svgClone);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, headerHeight);
                    URL.revokeObjectURL(url);

                    // Info section with stats
                    const infoY = headerHeight + svgHeight;
                    ctx.fillStyle = '#1a1a25';
                    ctx.fillRect(0, infoY, svgWidth, infoHeight);

                    // Get stats from DOM
                    const corrEl = document.getElementById('correlation');
                    const r2El = document.getElementById('r-squared');
                    const stationsEl = document.getElementById('station-count');
                    const equationEl = document.getElementById('regression-equation');
                    const correlation = corrEl ? corrEl.textContent : '-';
                    const rSquared = r2El ? r2El.textContent : '-';
                    const stations = stationsEl ? stationsEl.textContent : '-';
                    const equation = equationEl ? equationEl.textContent : '-';

                    // Draw stats as separate items to avoid RTL issues
                    ctx.font = '12px Heebo, sans-serif';
                    ctx.fillStyle = '#94a3b8';

                    // Draw each stat separately with proper spacing
                    const statsY = infoY + 25;
                    const stationsLabel = i18n.getLang() === 'en' ? 'Ballots' : '×§×œ×¤×™×•×ª';
                    const corrLabel = i18n.getLang() === 'en' ? 'Correlation' : '××ª××';
                    const items = [
                        `${stationsLabel}: ${stations}`,
                        `${corrLabel}: ${correlation}`,
                        `RÂ²: ${rSquared}`,
                        equation
                    ];
                    const itemsText = items.join('   Â·   ');
                    ctx.textAlign = 'center';
                    ctx.fillText(itemsText, svgWidth / 2, statsY);

                    // Draw watermark section
                    const watermarkY = totalHeight - watermarkHeight;
                    ctx.fillStyle = '#1a1a25';
                    ctx.fillRect(0, watermarkY, svgWidth, watermarkHeight);

                    ctx.strokeStyle = '#2a2a3a';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(0, watermarkY);
                    ctx.lineTo(svgWidth, watermarkY);
                    ctx.stroke();

                    // Draw QR code
                    const qrDataURL = this.generateQRCodeDataURL();
                    const qrImg = new Image();
                    qrImg.onload = () => {
                        const qrSize = 45;
                        ctx.drawImage(qrImg, 15, watermarkY + 7, qrSize, qrSize);

                        ctx.fillStyle = '#f8fafc';
                        ctx.font = 'bold 14px Heebo, sans-serif';
                        ctx.textAlign = 'right';
                        ctx.fillText(i18n.t('watermark_created'), svgWidth - 15, watermarkY + 25);

                        ctx.fillStyle = '#64748b';
                        ctx.font = '12px Heebo, sans-serif';
                        ctx.fillText('https://kolot-nodedim.netlify.app/', svgWidth - 15, watermarkY + 45);

                        // Download
                        const link = document.createElement('a');
                        const partyX = this.currentPartyX || 'none';
                        const partyY = this.currentPartyY || 'none';
                        link.download = `scatter-${this.currentElectionX}-${partyX}-vs-${this.currentElectionY}-${partyY}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    };
                    qrImg.src = qrDataURL;
                };
                img.src = url;
            }
        }

        // Initialize
        new ScatterVisualization();
    </script>
    <script>i18n.renderNav('scatter'); i18n.renderBMC();</script>
</body>
</html>
