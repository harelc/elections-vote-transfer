<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:type" content="website">
    <meta property="og:title" content="×§×•×œ×•×ª × ×•×“×“×™× â€” ×¤×¨×•×¤×™×œ ××¤×œ×’×”">
    <meta property="og:description" content="× ×™×ª×•×— ××™× ×˜×¨××§×˜×™×‘×™ ×©×œ × ×ª×•× ×™ ×‘×—×™×¨×•×ª ×œ×›× ×¡×ª â€” Interactive Israeli Knesset election data analysis">
    <meta property="og:image" content="https://kolot-nodedim.netlify.app/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <title>×¤×¨×•×¤×™×œ ××¤×œ×’×” - ×§×•×œ×•×ª × ×•×“×“×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="../i18n.css">
    <script src="../i18n.js"></script>
    <style>
        html, body { overflow: auto; height: auto; min-height: 100%; }
        .m-profile {
            padding: calc(44px + 0.75rem) 0.75rem calc(54px + var(--safe-bottom));
        }
        .m-back { color: var(--accent); text-decoration: none; font-size: 0.85rem; display: inline-block; margin-bottom: 0.5rem; }

        /* Hero */
        .m-hero { display: flex; gap: 0.75rem; margin-bottom: 1rem; align-items: flex-start; }
        .m-hero-bar {
            width: 6px; min-height: 60px; border-radius: 3px; flex-shrink: 0; align-self: stretch;
        }
        .m-hero-leader-img {
            width: 52px; height: 52px; border-radius: 50%;
            object-fit: cover; flex-shrink: 0;
            border: 2px solid var(--border);
        }
        .m-hero-info { min-width: 0; }
        .m-hero-name { font-size: 1.3rem; font-weight: 700; }
        .m-hero-name-en { font-size: 0.8rem; color: var(--text-muted); }
        .m-hero-meta { display: flex; gap: 0.75rem; flex-wrap: wrap; font-size: 0.78rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .m-hero-meta strong { color: var(--text-primary); }
        .m-hero-aliases { font-size: 0.78rem; color: var(--text-secondary); margin-top: 0.25rem; line-height: 1.4; }
        .m-hero-aliases strong { color: var(--text-muted); }

        /* Sections */
        .m-section { margin-bottom: 1.25rem; }
        .m-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .m-chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            height: 250px;
            position: relative;
        }

        /* History table */
        .m-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .m-history-table th {
            background: var(--bg-tertiary);
            padding: 0.4rem 0.5rem;
            text-align: start;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.72rem;
        }
        .m-history-table td {
            padding: 0.4rem 0.5rem;
            border-top: 1px solid var(--border);
        }
        .m-history-table .dot {
            display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; margin-inline-end: 0.3rem; vertical-align: middle;
        }
        .m-history-table .merged-note {
            font-size: 0.72rem; color: var(--text-muted); font-style: italic;
        }

        /* Strongholds */
        .m-stronghold-item {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
            font-size: 0.82rem;
            border-bottom: 1px solid var(--border);
        }
        .m-stronghold-item:last-child { border-bottom: none; }
        .m-stronghold-item a { color: var(--text-primary); text-decoration: none; }
        .m-stronghold-pct { color: var(--text-muted); }
        .m-strongholds-block {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .m-strongholds-block h4 {
            font-size: 0.82rem; font-weight: 600; margin: 0 0 0.5rem; color: var(--text-secondary);
        }

        /* Search */
        .m-search { position: relative; margin-bottom: 1rem; }
        .m-search input {
            width: 100%; padding: 0.5rem 0.75rem;
            border: 1px solid var(--border); border-radius: var(--radius);
            background: var(--bg-card); color: var(--text-primary);
            font-family: inherit; font-size: 0.88rem; outline: none;
        }
        .m-search input:focus { border-color: var(--accent); }
        .m-dropdown {
            position: absolute; top: 100%; right: 0; left: 0;
            max-height: 200px; overflow-y: auto;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); margin-top: 2px; z-index: 100; display: none;
        }
        .m-dropdown.visible { display: block; }
        .m-dropdown a {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 0.75rem; color: var(--text-primary); text-decoration: none; font-size: 0.85rem;
        }
        .m-dropdown a:hover { background: var(--bg-hover); }
        .m-dropdown .sdot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }

        /* Landing grid */
        .m-party-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .m-party-card {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            text-decoration: none;
            color: inherit;
            text-align: start;
        }
        .m-party-card:active { border-color: var(--accent); }
        .m-party-card-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        .m-party-card-name { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
        .m-party-card-seats { font-size: 0.78rem; color: var(--text-muted); }

        .m-loading { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }

        /* Metrics */
        .m-metrics-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .m-metrics-card h4 {
            font-size: 0.82rem; font-weight: 600; margin: 0 0 0.5rem; color: var(--text-secondary);
        }
        .m-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border);
        }
        .m-metric-row:last-child { border-bottom: none; }
        .m-metric-label { color: var(--text-secondary); }
        .m-metric-value { color: var(--text-primary); font-weight: 600; }
        .m-metric-big { font-size: 1.5rem; font-weight: 700; line-height: 1; margin-bottom: 0.2rem; }
        .m-metric-sub { font-size: 0.72rem; color: var(--text-muted); }
        .m-sim-row {
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border);
        }
        .m-sim-row:last-child { border-bottom: none; }
        .m-sim-label { width: 100px; flex-shrink: 0; color: var(--text-secondary); }
        .m-sim-bar {
            flex: 1; height: 10px; background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 5px; margin: 0 0.4rem; overflow: hidden; direction: ltr;
        }
        .m-sim-fill { height: 100%; border-radius: 4px; opacity: 0.75; }
        .m-sim-value { width: 36px; flex-shrink: 0; text-align: left; color: var(--text-primary); font-weight: 600; font-size: 0.75rem; }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="index.html" class="home-link">ğŸ </a>
        <span class="title"><span data-i18n="site_title">×§×•×œ×•×ª × ×•×“×“×™×</span> Â· <span data-i18n="party_profile">×¤×¨×•×¤×™×œ ××¤×œ×’×”</span></span>
    </div>
    <div class="m-profile" id="profile"></div>

    <nav class="tab-bar">
        <a href="geomap.html"><span class="tab-icon">ğŸ—ºï¸</span><span data-i18n="tab_map">××¤×”</span></a>
        <a href="tsne.html"><span class="tab-icon">ğŸ”µ</span><span data-i18n="tab_tsne">×¤×™×–×•×¨</span></a>
        <a href="sankey.html"><span class="tab-icon">ğŸ”€</span><span data-i18n="tab_sankey">× ×“×™×“×”</span></a>
        <a href="scatter.html"><span class="tab-icon">ğŸ“ˆ</span><span data-i18n="tab_scatter">×”×©×•×•××”</span></a>
        <a href="dhondt.html"><span class="tab-icon">ğŸ›ï¸</span><span data-i18n="tab_dhondt">×× ×“×˜×™×</span></a>
        <a href="regional.html"><span class="tab-icon">ğŸ§©</span><span data-i18n="tab_regional">××–×•×¨×™</span></a>
        <a href="discussions.html"><span class="tab-icon">ğŸ’¬</span><span data-i18n="nav_discussions">×“×™×•× ×™×</span></a>
    </nav>

    <script>
    (function() {
        /* â”€â”€ Party Families (same as desktop) â”€â”€ */
        const PARTY_FAMILIES = [
            {
                id: 'likud', name: '×”×œ×™×›×•×“', name_en: 'Likud', color: '#2563eb',
                elections: {
                    '21': { partyName: '×”×œ×™×›×•×“', symbol: '××—×œ', seats: 35 },
                    '22': { partyName: '×”×œ×™×›×•×“', symbol: '××—×œ', seats: 32 },
                    '23': { partyName: '×”×œ×™×›×•×“', symbol: '××—×œ', seats: 36 },
                    '24': { partyName: '×”×œ×™×›×•×“', symbol: '××—×œ', seats: 30 },
                    '25': { partyName: '×”×œ×™×›×•×“', symbol: '××—×œ', seats: 32 },
                }
            },
            {
                id: 'yesh_atid', name: '×™×© ×¢×ª×™×“', name_en: 'Yesh Atid', color: '#06b6d4',
                elections: {
                    '21': { partyName: '×›×—×•×œ ×œ×‘×Ÿ', symbol: '×¤×”', seats: 35 },
                    '22': { partyName: '×›×—×•×œ ×œ×‘×Ÿ', symbol: '×¤×”', seats: 33 },
                    '23': { partyName: '×›×—×•×œ ×œ×‘×Ÿ', symbol: '×¤×”', seats: 33 },
                    '24': { partyName: '×™×© ×¢×ª×™×“', symbol: '×¤×”', seats: 17 },
                    '25': { partyName: '×™×© ×¢×ª×™×“', symbol: '×¤×”', seats: 24 },
                }
            },
            {
                id: 'national_unity', name: '×”××—× ×” ×”×××œ×›×ª×™', name_en: 'National Unity', color: '#7c3aed',
                elections: {
                    '24': { partyName: '×›×—×•×œ ×œ×‘×Ÿ', symbol: '×›×Ÿ', seats: 8 },
                    '25': { partyName: '×”××—× ×” ×”×××œ×›×ª×™', symbol: '×›×Ÿ', seats: 12 },
                },
                notes: { '21': '×›×—×•×œ ×œ×‘×Ÿ (×¤×”)', '22': '×›×—×•×œ ×œ×‘×Ÿ (×¤×”)', '23': '×›×—×•×œ ×œ×‘×Ÿ (×¤×”)' }
            },
            {
                id: 'shas', name: '×©×´×¡', name_en: 'Shas', color: '#1e3a8a',
                elections: {
                    '21': { partyName: '×©×´×¡', symbol: '×©×¡', seats: 8 },
                    '22': { partyName: '×©×´×¡', symbol: '×©×¡', seats: 9 },
                    '23': { partyName: '×©×´×¡', symbol: '×©×¡', seats: 9 },
                    '24': { partyName: '×©×´×¡', symbol: '×©×¡', seats: 9 },
                    '25': { partyName: '×©×´×¡', symbol: '×©×¡', seats: 11 },
                }
            },
            {
                id: 'utj', name: '×™×”×“×•×ª ×”×ª×•×¨×”', name_en: 'United Torah Judaism', color: '#4b5563',
                elections: {
                    '21': { partyName: '×™×”×“×•×ª ×”×ª×•×¨×”', symbol: '×’', seats: 8 },
                    '22': { partyName: '×™×”×“×•×ª ×”×ª×•×¨×”', symbol: '×’', seats: 7 },
                    '23': { partyName: '×™×”×“×•×ª ×”×ª×•×¨×”', symbol: '×’', seats: 7 },
                    '24': { partyName: '×™×”×“×•×ª ×”×ª×•×¨×”', symbol: '×’', seats: 7 },
                    '25': { partyName: '×™×”×“×•×ª ×”×ª×•×¨×”', symbol: '×’', seats: 7 },
                }
            },
            {
                id: 'yisrael_beiteinu', name: '×™×©×¨××œ ×‘×™×ª× ×•', name_en: 'Yisrael Beiteinu', color: '#db2777',
                elections: {
                    '21': { partyName: '×™×©×¨××œ ×‘×™×ª× ×•', symbol: '×œ', seats: 5 },
                    '22': { partyName: '×™×©×¨××œ ×‘×™×ª× ×•', symbol: '×œ', seats: 8 },
                    '23': { partyName: '×™×©×¨××œ ×‘×™×ª× ×•', symbol: '×œ', seats: 7 },
                    '24': { partyName: '×™×©×¨××œ ×‘×™×ª× ×•', symbol: '×œ', seats: 7 },
                    '25': { partyName: '×™×©×¨××œ ×‘×™×ª× ×•', symbol: '×œ', seats: 6 },
                }
            },
            {
                id: 'labor', name: '×”×¢×‘×•×“×”', name_en: 'Labor', color: '#dc2626',
                elections: {
                    '21': { partyName: '×”×¢×‘×•×“×”', symbol: '×××ª', seats: 6 },
                    '22': { partyName: '×”×¢×‘×•×“×”-×’×©×¨', symbol: '×××ª', seats: 6 },
                    '23': { partyName: '×¢×‘×•×“×”-×’×©×¨-××¨×¦', symbol: '×××ª', seats: 7 },
                    '24': { partyName: '×”×¢×‘×•×“×”', symbol: '×××ª', seats: 7 },
                    '25': { partyName: '×”×¢×‘×•×“×”', symbol: '×××ª', seats: 4 },
                }
            },
            {
                id: 'meretz', name: '××¨×¦', name_en: 'Meretz', color: '#16a34a',
                elections: {
                    '21': { partyName: '××¨×¦', symbol: '××¨×¦', seats: 4 },
                    '22': { partyName: '×”××—× ×” ×”×“××•×§×¨×˜×™', symbol: '××¨×¦', seats: 5 },
                    '24': { partyName: '××¨×¦', symbol: '××¨×¦', seats: 6 },
                    '25': { partyName: '××¨×¦', symbol: '××¨×¦', seats: 0 },
                },
                notes: { '23': '×¢×‘×•×“×”-×’×©×¨-××¨×¦ (×××ª)' }
            },
            {
                id: 'joint_list', name: '×”×¨×©×™××” ×”××©×•×ª×¤×ª', name_en: 'Joint List', color: '#059669',
                elections: {
                    '21': { partyName: '×—×“×´×©-×ª×¢×´×œ', symbol: '×•×', seats: 6 },
                    '22': { partyName: '×”×¨×©×™××” ×”××©×•×ª×¤×ª', symbol: '×•×“×¢×', seats: 13 },
                    '23': { partyName: '×”×¨×©×™××” ×”××©×•×ª×¤×ª', symbol: '×•×“×¢×', seats: 15 },
                    '24': { partyName: '×”×¨×©×™××” ×”××©×•×ª×¤×ª', symbol: '×•×“×¢×', seats: 6 },
                    '25': { partyName: '×—×“×´×©-×ª×¢×´×œ', symbol: '×•×', seats: 5 },
                }
            },
            {
                id: 'raam', name: '×¨×¢×´×', name_en: "Ra'am", color: '#84cc16',
                elections: {
                    '21': { partyName: '×¨×¢×´×-×‘×œ×´×“', symbol: '×“×¢×', seats: 4 },
                    '24': { partyName: '×¨×¢×´×', symbol: '×¢×', seats: 4 },
                    '25': { partyName: '×¨×¢×´×', symbol: '×¢×', seats: 5 },
                },
                notes: { '22': '×”×¨×©×™××” ×”××©×•×ª×¤×ª (×•×“×¢×)', '23': '×”×¨×©×™××” ×”××©×•×ª×¤×ª (×•×“×¢×)' }
            },
            {
                id: 'yamina', name: '×™××™× ×”', name_en: 'Yamina', color: '#ea580c',
                elections: {
                    '21': { partyName: '×”×‘×™×ª ×”×™×”×•×“×™', symbol: '×˜×‘', seats: 5 },
                    '22': { partyName: '×™××™× ×”', symbol: '×˜×‘', seats: 7 },
                    '23': { partyName: '×™××™× ×”', symbol: '×˜×‘', seats: 6 },
                    '24': { partyName: '×™××™× ×”', symbol: '×‘', seats: 7 },
                }
            },
            {
                id: 'religious_zionism', name: '×”×¦×™×•× ×•×ª ×”×“×ª×™×ª', name_en: 'Religious Zionism', color: '#92400e',
                elections: {
                    '24': { partyName: '×”×¦×™×•× ×•×ª ×”×“×ª×™×ª', symbol: '×˜', seats: 6 },
                    '25': { partyName: '×”×¦×™×•× ×•×ª ×”×“×ª×™×ª', symbol: '×˜', seats: 14 },
                }
            },
            {
                id: 'new_hope', name: '×ª×§×•×•×” ×—×“×©×”', name_en: 'New Hope', color: '#a855f7',
                elections: {
                    '24': { partyName: '×ª×§×•×•×” ×—×“×©×”', symbol: '×ª', seats: 6 },
                },
                notes: { '25': '×”××—× ×” ×”×××œ×›×ª×™ (×›×Ÿ)' }
            },
            {
                id: 'kulanu', name: '×›×•×œ× ×•', name_en: 'Kulanu', color: '#eab308',
                elections: {
                    '21': { partyName: '×›×•×œ× ×•', symbol: '×›', seats: 4 },
                },
                notes: { '22': '×”×œ×™×›×•×“ (××—×œ)' }
            },
            {
                id: 'balad', name: '×‘×œ×´×“', name_en: 'Balad', color: '#065f46',
                elections: {
                    '25': { partyName: '×‘×œ×´×“', symbol: '×“', seats: 0 },
                },
                notes: { '21': '×¨×¢×´×-×‘×œ×´×“ (×“×¢×)', '22': '×”×¨×©×™××” ×”××©×•×ª×¤×ª (×•×“×¢×)', '23': '×”×¨×©×™××” ×”××©×•×ª×¤×ª (×•×“×¢×)', '24': '×”×¨×©×™××” ×”××©×•×ª×¤×ª (×•×“×¢×)' }
            },
        ];

        const ELECTIONS = ['21','22','23','24','25'];
        const LABELS = { '21':'×›× ×¡×ª 21','22':'×›× ×¡×ª 22','23':'×›× ×¡×ª 23','24':'×›× ×¡×ª 24','25':'×›× ×¡×ª 25' };
        const LABELS_EN = { '21':'Knesset 21','22':'Knesset 22','23':'Knesset 23','24':'Knesset 24','25':'Knesset 25' };

        const params = new URLSearchParams(location.search);
        const partyParam = params.get('name');
        const container = document.getElementById('profile');
        let allMap = {};
        let wikiResults = {};
        let metricsData = null;

        if (!partyParam) { showLanding(); return; }

        function findFamily(name) {
            return PARTY_FAMILIES.find(f =>
                f.name === name || f.name_en === name ||
                Object.values(f.elections).some(e => e.partyName === name)
            );
        }

        function getLatestSeats(family) {
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                const e = family.elections[ELECTIONS[i]];
                if (e) return e.seats;
            }
            return -1;
        }

        /* â”€â”€ Landing â”€â”€ */
        function showLanding() {
            const lang = i18n.getLang();
            const sorted = [...PARTY_FAMILIES].sort((a, b) => getLatestSeats(b) - getLatestSeats(a));
            let h = '';
            h += '<div class="m-search"><input type="text" id="search-input" placeholder="' + i18n.t('search_party') + '">';
            h += '<div class="m-dropdown" id="search-dropdown"></div></div>';
            h += '<div class="m-party-grid">';
            sorted.forEach(f => {
                const seats = getLatestSeats(f);
                const display = lang === 'en' ? f.name_en : f.name;
                const seatsLabel = seats > 0 ? seats + ' ' + i18n.t('seats') : '\u2014';
                h += '<a class="m-party-card" href="party.html?name=' + encodeURIComponent(f.name) + '">';
                h += '<span class="m-party-card-dot" style="background:' + f.color + '"></span>';
                h += '<div><div class="m-party-card-name">' + display + '</div>';
                h += '<div class="m-party-card-seats">' + seatsLabel + '</div></div></a>';
            });
            h += '</div>';
            container.innerHTML = h;
            initSearch();
        }

        /* â”€â”€ Profile â”€â”€ */
        const family = findFamily(partyParam);
        if (!family && partyParam) {
            container.innerHTML = '<div class="m-loading">' + i18n.t('no_data') + '</div>';
            return;
        }
        if (partyParam) {
            document.title = family.name + ' - ×§×•×œ×•×ª × ×•×“×“×™×';
            container.innerHTML = '<div class="m-loading" data-i18n="loading">' + i18n.t('loading') + '</div>';

            Promise.all([
                ...ELECTIONS.map(e => fetch('../data/map_' + e + '.json').then(r => r.json()).then(d => { allMap[e] = d; })),
                fetch('../data/wiki_official_results.json').then(r => r.json()).then(d => { wikiResults = d; }).catch(() => {}),
                fetch('../data/metrics.json').then(r => r.json()).then(d => { metricsData = d; }).catch(() => {}),
            ]).then(() => renderProfile(family))
             .catch(() => { container.innerHTML = '<div class="m-loading">' + i18n.t('error_loading') + '</div>'; });
        }

        function renderProfile(family) {
            const lang = i18n.getLang();
            const displayName = lang === 'en' ? family.name_en : family.name;
            const elLabels = lang === 'en' ? LABELS_EN : LABELS;

            // Get latest party info
            let latestInfo = null;
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                const elec = family.elections[ELECTIONS[i]];
                if (!elec) continue;
                const mapData = allMap[ELECTIONS[i]];
                if (!mapData) continue;
                const p = mapData.parties.find(p => p.name === elec.partyName);
                if (p && p.info) { latestInfo = p.info; break; }
            }

            let h = '<a class="m-back" href="party.html">\u2190 ' + i18n.t('party_profile') + '</a>';

            // Search
            h += '<div class="m-search"><input type="text" id="search-input" placeholder="' + i18n.t('search_party') + '">';
            h += '<div class="m-dropdown" id="search-dropdown"></div></div>';

            // Hero
            h += '<div class="m-hero">';
            h += '<div class="m-hero-bar" style="background:' + family.color + '"></div>';
            if (latestInfo && latestInfo.leader_image) {
                h += '<img class="m-hero-leader-img" src="../' + latestInfo.leader_image + '" alt="" onerror="this.style.display=\'none\'">';
            }
            h += '<div class="m-hero-info">';
            h += '<div class="m-hero-name">' + displayName + '</div>';
            if (lang === 'he' && family.name_en) {
                h += '<div class="m-hero-name-en">' + family.name_en + '</div>';
            } else if (lang === 'en') {
                h += '<div class="m-hero-name-en">' + family.name + '</div>';
            }
            h += '<div class="m-hero-meta">';
            if (latestInfo) {
                const leader = lang === 'en' && latestInfo.leader_en ? latestInfo.leader_en : latestInfo.leader;
                if (leader) h += '<span><strong>' + leader + '</strong></span>';
                if (latestInfo.ideology) h += '<span>' + latestInfo.ideology + '</span>';
            }
            h += '</div>';

            // Aliases
            const aliases = [];
            Object.values(family.elections).forEach(data => {
                if (data.partyName !== family.name && !aliases.includes(data.partyName)) {
                    aliases.push(data.partyName);
                }
            });
            if (aliases.length > 0) {
                h += '<div class="m-hero-aliases"><strong>' + i18n.t('also_known_as') + '</strong> ' + aliases.join(', ') + '</div>';
            }
            h += '</div></div>';

            // Trends chart
            h += '<div class="m-section">';
            h += '<div class="m-section-title" data-i18n="seats_trend">' + i18n.t('seats_trend') + '</div>';
            h += '<div class="m-chart-container"><canvas id="trends-chart"></canvas></div>';
            h += '</div>';

            // Election history table
            h += '<div class="m-section">';
            h += '<div class="m-section-title" data-i18n="election_history">' + i18n.t('election_history') + '</div>';
            h += '<table class="m-history-table"><thead><tr>';
            h += '<th>' + i18n.t('election') + '</th>';
            h += '<th>' + i18n.t('party') + '</th>';
            h += '<th>' + i18n.t('seats') + '</th>';
            h += '<th>' + i18n.t('votes') + '</th>';
            h += '<th>%</th>';
            h += '</tr></thead><tbody>';

            ELECTIONS.forEach(e => {
                const data = family.elections[e];
                const label = elLabels[e];
                if (!data) {
                    const note = family.notes && family.notes[e];
                    h += '<tr><td>' + label + '</td>';
                    if (note) {
                        h += '<td colspan="4" class="merged-note">' + note + '</td>';
                    } else {
                        h += '<td colspan="4" class="merged-note">' + i18n.t('did_not_run') + '</td>';
                    }
                    h += '</tr>';
                    return;
                }

                let supportPct = '\u2014';
                let votesDisplay = '\u2014';
                const wikiEntry = (wikiResults[e] || []).find(p => p.name === data.partyName);
                if (wikiEntry && wikiEntry.votes) {
                    votesDisplay = i18n.fmtNum(wikiEntry.votes);
                    const totalValid = (wikiResults[e] || []).reduce((sum, p) => sum + (p.votes || 0), 0);
                    if (totalValid > 0) {
                        supportPct = (wikiEntry.votes / totalValid * 100).toFixed(1) + '%';
                    }
                }

                h += '<tr>';
                h += '<td>' + label + '</td>';
                h += '<td><span class="dot" style="background:' + family.color + '"></span>' + i18n.partyName(data.partyName) + '</td>';
                h += '<td>' + data.seats + '</td>';
                h += '<td>' + votesDisplay + '</td>';
                h += '<td>' + supportPct + '</td>';
                h += '</tr>';
            });
            h += '</tbody></table></div>';

            // Geographic strongholds (top 10 only on mobile)
            let latestE = null, latestPartyName = null;
            for (let i = ELECTIONS.length - 1; i >= 0; i--) {
                if (family.elections[ELECTIONS[i]]) {
                    latestE = ELECTIONS[i];
                    latestPartyName = family.elections[latestE].partyName;
                    break;
                }
            }
            if (latestE && allMap[latestE]) {
                const settlements = allMap[latestE].settlements || [];
                const withSupport = settlements
                    .filter(s => s.proportions && s.proportions[latestPartyName] != null && s.voters >= 100)
                    .map(s => ({ name: s.name, pct: s.proportions[latestPartyName] }))
                    .sort((a, b) => b.pct - a.pct);
                const top10 = withSupport.slice(0, 10);

                if (top10.length > 0) {
                    h += '<div class="m-section">';
                    h += '<div class="m-section-title" data-i18n="geographic_strongholds">' + i18n.t('geographic_strongholds') + '</div>';
                    h += '<div class="m-strongholds-block">';
                    h += '<h4 data-i18n="top_strongholds">' + i18n.t('top_strongholds') + '</h4>';
                    top10.forEach(s => {
                        const display = lang === 'en' ? i18n.settlementName(s.name) : s.name;
                        h += '<div class="m-stronghold-item">';
                        h += '<a href="settlement.html?name=' + encodeURIComponent(s.name) + '">' + display + '</a>';
                        h += '<span class="m-stronghold-pct">' + s.pct.toFixed(1) + '%</span>';
                        h += '</div>';
                    });
                    h += '</div>';

                    h += '</div>';
                }
            }

            // Statistical metrics
            h += buildMobileMetrics(family);

            container.innerHTML = h;

            setTimeout(() => {
                initChart(family);
                initSearch();
                drawConcentrationCDF(family);
            }, 50);
        }

        function drawConcentrationCDF(family) {
            var canvas = document.getElementById('concentration-cdf');
            if (!canvas) return;
            var latestE = null, latestPartyName = null;
            for (var i = ELECTIONS.length - 1; i >= 0; i--) {
                if (family.elections[ELECTIONS[i]]) {
                    latestE = ELECTIONS[i];
                    latestPartyName = family.elections[latestE].partyName;
                    break;
                }
            }
            if (!latestE || !allMapData[latestE]) return;
            var settlements = allMapData[latestE].settlements || [];
            var partyVotes = settlements
                .filter(function(s) { return s.proportions && s.proportions[latestPartyName] != null && s.voters > 0; })
                .map(function(s) { return { name: s.name, votes: s.proportions[latestPartyName] / 100 * s.voters }; })
                .filter(function(s) { return s.votes > 0; })
                .sort(function(a, b) { return b.votes - a.votes; });
            if (partyVotes.length === 0) return;
            var totalVotes = partyVotes.reduce(function(sum, s) { return sum + s.votes; }, 0);
            var cumData = [];
            var cumSum = 0;
            for (var j = 0; j < partyVotes.length; j++) {
                cumSum += partyVotes[j].votes;
                cumData.push({ n: j + 1, pct: cumSum / totalVotes * 100 });
            }
            var n50 = cumData.find(function(d) { return d.pct >= 50; });
            var n90 = cumData.find(function(d) { return d.pct >= 90; });
            var dpr = window.devicePixelRatio || 1;
            var rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            var ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            var W = rect.width, H = rect.height;
            var pad = { top: 12, right: 12, bottom: 40, left: 38 };
            var plotW = W - pad.left - pad.right;
            var plotH = H - pad.top - pad.bottom;
            var maxN = partyVotes.length;
            function xScale(n) { return pad.left + (n / maxN) * plotW; }
            function yScale(pct) { return pad.top + plotH - (pct / 100) * plotH; }
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-card').trim() || '#1a1a2e';
            ctx.fillRect(0, 0, W, H);
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            ctx.lineWidth = 0.5;
            [25, 50, 75, 100].forEach(function(pct) {
                ctx.beginPath(); ctx.moveTo(pad.left, yScale(pct)); ctx.lineTo(W - pad.right, yScale(pct)); ctx.stroke();
            });
            if (n50) {
                ctx.fillStyle = family.color + '18';
                ctx.beginPath();
                ctx.moveTo(xScale(0), yScale(0));
                for (var k = 0; k < cumData.length && cumData[k].n <= n50.n; k++) {
                    ctx.lineTo(xScale(cumData[k].n), yScale(cumData[k].pct));
                }
                ctx.lineTo(xScale(n50.n), yScale(0));
                ctx.closePath();
                ctx.fill();
            }
            ctx.strokeStyle = family.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(xScale(0), yScale(0));
            cumData.forEach(function(d) { ctx.lineTo(xScale(d.n), yScale(d.pct)); });
            ctx.stroke();
            ctx.setLineDash([4, 3]);
            ctx.strokeStyle = 'rgba(255,255,255,0.35)';
            ctx.lineWidth = 1;
            if (n50) {
                ctx.beginPath(); ctx.moveTo(xScale(n50.n), yScale(50)); ctx.lineTo(xScale(n50.n), yScale(0)); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(pad.left, yScale(50)); ctx.lineTo(xScale(n50.n), yScale(50)); ctx.stroke();
            }
            if (n90) {
                ctx.beginPath(); ctx.moveTo(xScale(n90.n), yScale(90)); ctx.lineTo(xScale(n90.n), yScale(0)); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(pad.left, yScale(90)); ctx.lineTo(xScale(n90.n), yScale(90)); ctx.stroke();
            }
            ctx.setLineDash([]);
            if (n50) {
                ctx.beginPath(); ctx.arc(xScale(n50.n), yScale(50), 3.5, 0, Math.PI * 2);
                ctx.fillStyle = family.color; ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5; ctx.stroke();
            }
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '9px system-ui, sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            [0, 50, 100].forEach(function(pct) { ctx.fillText(pct + '%', pad.left - 4, yScale(pct)); });
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            [1, n50 ? n50.n : null, n90 ? n90.n : null, maxN > 10 ? maxN : null].forEach(function(n) {
                if (n) ctx.fillText(n, xScale(n), H - pad.bottom + 4);
            });
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.font = '9px system-ui, sans-serif';
            var xTitle = i18n.getLang() === 'en' ? 'Settlements (sorted by votes)' : '×™×™×©×•×‘×™× (×œ×¤×™ ××¡×¤×¨ ×§×•×œ×•×ª)';
            ctx.fillText(xTitle, pad.left + plotW / 2, H - 3);
            if (n50) {
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.font = 'bold 9px system-ui, sans-serif';
                ctx.textAlign = 'left';
                var label50 = i18n.getLang() === 'en' ? '50% â† ' + n50.n + ' towns' : n50.n + ' ×™×™×©×•×‘×™× â†’ 50%';
                ctx.fillText(label50, xScale(n50.n) + 5, yScale(50) - 2);
            }
        }

        function buildMobileMetrics(family) {
            if (!metricsData) return '';
            var partyName = null;
            for (var i = ELECTIONS.length - 1; i >= 0; i--) {
                var e = family.elections[ELECTIONS[i]];
                if (e) { partyName = e.partyName; break; }
            }
            if (!partyName) return '';

            var hhi = metricsData.party_hhi[partyName];
            var cosine = metricsData.party_cosine_similarity[partyName];
            var conc = metricsData.party_concentration[partyName];
            if (!hhi && !cosine) return '';

            var h = '<div class="m-section">';
            h += '<div class="m-section-title" data-i18n="party_analytics">' + i18n.t('party_analytics') + '</div>';

            // Concentration
            if (hhi && conc) {
                h += '<div class="m-metrics-card">';
                h += '<h4 data-i18n="geographic_concentration">' + i18n.t('geographic_concentration') + '</h4>';
                h += '<p style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.4rem;line-height:1.3">' + i18n.t('hhi_explainer') + '</p>';
                h += '<canvas id="concentration-cdf" style="width:100%;height:180px;margin:0.5rem 0"></canvas>';
                h += '<div style="margin-top:0.5rem">';
                h += '<div class="m-metric-row"><span class="m-metric-label">' + i18n.t('settlements_for_half') + '</span><span class="m-metric-value">' + conc.settlements_for_50pct + '</span></div>';
                h += '<div class="m-metric-row"><span class="m-metric-label">' + i18n.t('settlements_for_90') + '</span><span class="m-metric-value">' + conc.settlements_for_90pct + '</span></div>';
                h += '<div class="m-metric-row"><span class="m-metric-label">' + i18n.t('effective_settlements') + '</span><span class="m-metric-value">' + hhi.effective_settlements + '</span></div>';
                h += '<div style="font-size:0.65rem;color:var(--text-muted);margin-top:-0.1rem;padding-bottom:0.2rem">' + i18n.t('effective_settlements_tip') + '</div>';
                h += '</div></div>';
            }

            // Similar parties
            if (cosine) {
                h += '<div class="m-metrics-card">';
                h += '<h4 data-i18n="similar_parties">' + i18n.t('similar_parties') + '</h4>';
                h += '<p style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.4rem;line-height:1.3">' + i18n.t('cosine_explainer') + '</p>';
                var sorted = Object.entries(cosine).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 5);
                sorted.forEach(function(pair) {
                    var pctW = Math.round(pair[1] * 100);
                    h += '<div class="m-sim-row">';
                    h += '<span class="m-sim-label">' + i18n.partyName(pair[0]) + '</span>';
                    h += '<div class="m-sim-bar"><div class="m-sim-fill" style="width:' + pctW + '%;background:' + family.color + '"></div></div>';
                    h += '<span class="m-sim-value">' + pair[1].toFixed(2) + '</span>';
                    h += '</div>';
                });
                h += '</div>';
            }

            h += '</div>';
            return h;
        }

        function initChart(family) {
            const canvas = document.getElementById('trends-chart');
            if (!canvas) return;
            const lang = i18n.getLang();
            const elLabels = lang === 'en' ? LABELS_EN : LABELS;

            const supportData = [];
            const seatsData = [];
            ELECTIONS.forEach(e => {
                const data = family.elections[e];
                if (!data) { supportData.push(null); seatsData.push(null); return; }
                seatsData.push(data.seats);
                const wikiEntry = (wikiResults[e] || []).find(p => p.name === data.partyName);
                if (wikiEntry && wikiEntry.votes) {
                    const totalValid = (wikiResults[e] || []).reduce((sum, p) => sum + (p.votes || 0), 0);
                    supportData.push(totalValid > 0 ? +(wikiEntry.votes / totalValid * 100).toFixed(2) : null);
                } else {
                    supportData.push(null);
                }
            });

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: ELECTIONS.map(e => elLabels[e]),
                    datasets: [
                        {
                            label: i18n.t('support_pct'),
                            data: supportData,
                            borderColor: family.color,
                            backgroundColor: family.color + '33',
                            tension: 0.3, pointRadius: 4, yAxisID: 'y', spanGaps: false,
                        },
                        {
                            label: i18n.t('seats'),
                            data: seatsData,
                            borderColor: family.color + '99',
                            borderDash: [6, 4],
                            tension: 0.3, pointRadius: 3, pointStyle: 'rectRot', yAxisID: 'y1', spanGaps: false,
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#a0a0b0', font: { family: 'Heebo', size: 10 }, padding: 8 } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    if (ctx.datasetIndex === 0) return ctx.dataset.label + ': ' + ctx.parsed.y + '%';
                                    return ctx.dataset.label + ': ' + ctx.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#a0a0b0', font: { family: 'Heebo', size: 10 } }, grid: { color: '#2a2a3a' } },
                        y: {
                            position: lang === 'en' ? 'left' : 'right',
                            ticks: { color: '#a0a0b0', callback: v => v + '%' },
                            grid: { color: '#2a2a3a' }, min: 0,
                        },
                        y1: {
                            position: lang === 'en' ? 'right' : 'left',
                            ticks: { color: '#94a3b8', stepSize: 5 },
                            grid: { display: false }, min: 0,
                        }
                    }
                }
            });
        }

        function initSearch() {
            const input = document.getElementById('search-input');
            const dropdown = document.getElementById('search-dropdown');
            if (!input || !dropdown) return;

            input.addEventListener('input', () => {
                const q = input.value.trim().toLowerCase();
                if (q.length < 1) { dropdown.classList.remove('visible'); return; }
                const lang = i18n.getLang();
                const matches = PARTY_FAMILIES.filter(f => {
                    const names = [f.name, f.name_en, ...Object.values(f.elections).map(e => e.partyName)];
                    return names.some(n => n && n.toLowerCase().includes(q));
                }).slice(0, 10);
                if (!matches.length) { dropdown.classList.remove('visible'); return; }
                dropdown.innerHTML = matches.map(f => {
                    const display = lang === 'en' ? f.name_en : f.name;
                    return '<a href="party.html?name=' + encodeURIComponent(f.name) + '">' +
                        '<span class="sdot" style="background:' + f.color + '"></span>' + display + '</a>';
                }).join('');
                dropdown.classList.add('visible');
            });
            input.addEventListener('blur', () => setTimeout(() => dropdown.classList.remove('visible'), 200));
        }
    })();
    </script>
    <script>i18n.injectLangToggle('.top-bar');i18n.renderMobileBMC();</script>
</body>
</html>
