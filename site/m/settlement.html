<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:type" content="website">
    <meta property="og:title" content="×§×•×œ×•×ª × ×•×“×“×™× â€” ×¤×¨×•×¤×™×œ ×™×™×©×•×‘">
    <meta property="og:description" content="× ×™×ª×•×— ××™× ×˜×¨××§×˜×™×‘×™ ×©×œ × ×ª×•× ×™ ×‘×—×™×¨×•×ª ×œ×›× ×¡×ª â€” Interactive Israeli Knesset election data analysis">
    <meta property="og:image" content="https://kolot-nodedim.netlify.app/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <title>×¤×¨×•×¤×™×œ ×™×™×©×•×‘ - ×§×•×œ×•×ª × ×•×“×“×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="../i18n.css">
    <script src="../i18n.js"></script>
    <style>
        html, body { overflow: auto; height: auto; min-height: 100%; }
        .m-profile {
            padding: calc(44px + 0.75rem) 0.75rem calc(54px + var(--safe-bottom));
        }
        .m-back { color: var(--accent); text-decoration: none; font-size: 0.85rem; display: inline-block; margin-bottom: 0.5rem; }
        .m-hero { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .m-hero-thumb {
            width: 72px; height: 72px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
            background: var(--bg-tertiary);
        }
        .m-hero-info { min-width: 0; }
        .m-hero-name { font-size: 1.3rem; font-weight: 700; }
        .m-hero-name-en { font-size: 0.8rem; color: var(--text-muted); }
        .m-hero-meta { display: flex; gap: 0.75rem; flex-wrap: wrap; font-size: 0.78rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .m-hero-meta strong { color: var(--text-primary); }
        .m-extract { font-size: 0.82rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 1rem; }
        .m-extract a { color: var(--accent); text-decoration: none; }
        .m-section { margin-bottom: 1.25rem; }
        .m-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .m-chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            height: 250px;
            position: relative;
        }
        .m-party-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .m-party-table th {
            background: var(--bg-tertiary);
            padding: 0.4rem 0.5rem;
            text-align: start;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        .m-party-table td { padding: 0.4rem 0.5rem; border-top: 1px solid var(--border); }
        .m-party-table .dot {
            display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; margin-inline-end: 0.3rem; vertical-align: middle;
        }
        .m-search { position: relative; margin-bottom: 1rem; }
        .m-search input {
            width: 100%; padding: 0.5rem 0.75rem;
            border: 1px solid var(--border); border-radius: var(--radius);
            background: var(--bg-card); color: var(--text-primary);
            font-family: inherit; font-size: 0.88rem; outline: none;
        }
        .m-search input:focus { border-color: var(--accent); }
        .m-dropdown {
            position: absolute; top: 100%; right: 0; left: 0;
            max-height: 200px; overflow-y: auto;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); margin-top: 2px; z-index: 100; display: none;
        }
        .m-dropdown.visible { display: block; }
        .m-dropdown a { display: block; padding: 0.5rem 0.75rem; color: var(--text-primary); text-decoration: none; font-size: 0.85rem; }
        .m-dropdown a:hover { background: var(--bg-hover); }
        .m-loading { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="index.html" class="home-link">ğŸ </a>
        <span class="title"><span data-i18n="site_title">×§×•×œ×•×ª × ×•×“×“×™×</span> Â· <span data-i18n="settlement_profile">×¤×¨×•×¤×™×œ ×™×™×©×•×‘</span></span>
    </div>
    <div class="m-profile" id="profile"></div>

    <nav class="tab-bar">
        <a href="geomap.html"><span class="tab-icon">ğŸ—ºï¸</span><span data-i18n="tab_map">××¤×”</span></a>
        <a href="tsne.html"><span class="tab-icon">ğŸ”µ</span><span data-i18n="tab_tsne">×¤×™×–×•×¨</span></a>
        <a href="sankey.html"><span class="tab-icon">ğŸ”€</span><span data-i18n="tab_sankey">× ×“×™×“×”</span></a>
        <a href="scatter.html"><span class="tab-icon">ğŸ“ˆ</span><span data-i18n="tab_scatter">×”×©×•×•××”</span></a>
        <a href="dhondt.html"><span class="tab-icon">ğŸ›ï¸</span><span data-i18n="tab_dhondt">×× ×“×˜×™×</span></a>
        <a href="regional.html"><span class="tab-icon">ğŸ§©</span><span data-i18n="tab_regional">××–×•×¨×™</span></a>
        <a href="discussions.html"><span class="tab-icon">ğŸ’¬</span><span data-i18n="nav_discussions">×“×™×•× ×™×</span></a>
    </nav>

    <script>
    (function() {
        const params = new URLSearchParams(location.search);
        const name = params.get('name');
        const container = document.getElementById('profile');

        const ELECTIONS = ['21','22','23','24','25'];
        const LABELS = { '21':'×›× ×¡×ª 21','22':'×›× ×¡×ª 22','23':'×›× ×¡×ª 23','24':'×›× ×¡×ª 24','25':'×›× ×¡×ª 25' };
        let allMap = {}, wikiData = {}, socioData = [], metricsData = null;

        if (!name) { showSearch(); return; }

        document.title = name + ' - ×§×•×œ×•×ª × ×•×“×“×™×';

        container.innerHTML = '<div class="m-loading" data-i18n="loading">' + i18n.t('loading') + '</div>';

        Promise.all([
            ...ELECTIONS.map(e => fetch('../data/map_'+e+'.json').then(r=>r.json()).then(d=>{allMap[e]=d})),
            fetch('../data/settlement_wiki.json').then(r=>r.json()).then(d=>{wikiData=d}).catch(()=>{}),
            fetch('../data/socioeconomic_clusters.json').then(r=>r.json()).then(d=>{socioData=d}).catch(()=>{}),
            fetch('../data/metrics.json').then(r=>r.json()).then(d=>{metricsData=d}).catch(()=>{}),
        ]).then(render).catch(()=>{container.innerHTML='<div class="m-loading">'+i18n.t('error_loading')+'</div>'});

        function render() {
            const byElection = {};
            ELECTIONS.forEach(e => {
                if (allMap[e] && allMap[e].settlements) {
                    const s = allMap[e].settlements.find(s=>s.name===name);
                    if (s) byElection[e] = s;
                }
            });
            if (!Object.keys(byElection).length) {
                container.innerHTML = '<div class="m-loading">'+i18n.t('no_data')+'</div>';
                return;
            }
            const latest = byElection['25'] || byElection[Object.keys(byElection).pop()];
            const wiki = wikiData[name] || null;
            const socio = socioData.find(s=>s.name===name);
            const enName = i18n.settlementName(name);
            let h = '';

            // Search bar for navigation
            h += '<div class="m-search"><input type="text" id="search-input" placeholder="'+i18n.t('search_settlement_profile')+'">';
            h += '<div class="m-dropdown" id="search-dropdown"></div></div>';

            h += '<div class="m-hero">';
            if (wiki && wiki.thumbnail) h += '<img class="m-hero-thumb" src="'+wiki.thumbnail+'">';
            h += '<div class="m-hero-info">';
            h += '<div class="m-hero-name">' + name + '</div>';
            if (enName !== name) h += '<div class="m-hero-name-en">' + enName + '</div>';
            h += '<div class="m-hero-meta">';
            if (latest.ballotCount) h += '<span><strong>'+latest.ballotCount+'</strong> '+i18n.t('dashboard_stat_ballots')+'</span>';
            if (latest.eligible) h += '<span><strong>'+i18n.fmtNum(latest.eligible)+'</strong> '+i18n.t('eligible_voters')+'</span>';
            if (latest.turnout) h += '<span><strong>'+latest.turnout.toFixed(1)+'%</strong></span>';
            if (socio) h += '<span><strong>'+socio.cluster+'/10</strong></span>';
            var pedersen = metricsData && metricsData.settlement_pedersen && metricsData.settlement_pedersen[name];
            if (pedersen) {
                var pctile = Math.round((1 - pedersen.rank / metricsData.national_stats.total_settlements) * 100);
                h += '<span title="'+i18n.t('volatility_explainer').replace(/"/g,'&quot;')+'"><strong>'+pedersen.average.toFixed(1)+'%</strong> '+i18n.t('volatility_label')+' <span style="opacity:0.6;font-size:0.68rem">('+i18n.t('percentile_label')+' '+pctile+')</span></span>';
            }
            h += '</div></div></div>';

            if (wiki && wiki.extract) {
                h += '<p class="m-extract">' + wiki.extract;
                if (wiki.wiki_url) h += ' <a href="'+wiki.wiki_url+'" target="_blank">'+i18n.t('wiki_source')+' â†’</a>';
                h += '</p>';
            }

            // Trends chart
            h += '<div class="m-section">';
            h += '<div class="m-section-title" data-i18n="voting_trends">'+i18n.t('voting_trends')+'</div>';
            h += '<div class="m-chart-container"><canvas id="trends-chart"></canvas></div>';
            h += '</div>';

            // Volatility breakdown
            if (pedersen) {
                h += '<div class="m-section">';
                h += '<div class="m-section-title">'+i18n.t('volatility_label')+'</div>';
                h += '<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:0.75rem">';
                h += '<p style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.5rem;line-height:1.3">'+i18n.t('volatility_explainer')+'</p>';
                var tL = {'21_to_22':'21â†’22','22_to_23':'22â†’23','23_to_24':'23â†’24','24_to_25':'24â†’25'};
                Object.entries(pedersen.transitions).forEach(function(e) {
                    var k=e[0],v=e[1],l=tL[k]||k;
                    var bc = v>25?'#f87171':v>10?'#fbbf24':'#4ade80';
                    h += '<div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.3rem;font-size:0.8rem">';
                    h += '<span style="min-width:48px;color:var(--text-secondary)">'+l+'</span>';
                    h += '<div style="flex:1;height:6px;background:var(--bg-tertiary);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+Math.min(v,100)+'%;background:'+bc+';border-radius:3px"></div></div>';
                    h += '<span style="min-width:36px;text-align:end;font-weight:600">'+v.toFixed(1)+'%</span></div>';
                });
                h += '<div style="display:flex;justify-content:space-between;margin-top:0.4rem;padding-top:0.4rem;border-top:1px solid var(--border);font-size:0.82rem">';
                h += '<span style="color:var(--text-secondary)">'+(i18n.getLang()==='en'?'Average':'×××•×¦×¢')+'</span>';
                h += '<span style="font-weight:700">'+pedersen.average.toFixed(1)+'%</span></div>';
                h += '<div style="font-size:0.7rem;color:var(--text-muted);margin-top:0.2rem">'+i18n.t('percentile_label')+' '+pctile+' ('+(i18n.getLang()==='en'?'national median':'×—×¦×™×•×Ÿ ××¨×¦×™')+': '+metricsData.national_stats.median_pedersen+'%)</div>';
                h += '<a href="rankings.html" style="display:inline-block;margin-top:0.4rem;font-size:0.75rem;color:var(--accent);text-decoration:none">'+i18n.t('see_all_rankings')+'</a>';
                h += '</div></div>';
            }

            // Party table
            h += '<div class="m-section">';
            h += '<div class="m-section-title" data-i18n="latest_breakdown">'+i18n.t('latest_breakdown')+'</div>';
            h += '<table class="m-party-table"><thead><tr><th>'+i18n.t('party')+'</th><th>%</th><th>'+i18n.t('votes')+'</th></tr></thead><tbody>';
            if (latest.proportions) {
                const sorted = Object.entries(latest.proportions).sort((a,b)=>b[1]-a[1]);
                const tableColors = {};
                ELECTIONS.forEach(e => {
                    if (allMap[e] && allMap[e].parties) {
                        allMap[e].parties.forEach(p => { if (!tableColors[p.name]) tableColors[p.name] = p.color; });
                    }
                });
                sorted.forEach(([pname, pct]) => {
                    if (pct < 0.5) return;
                    const color = tableColors[pname] || '#666';
                    const votes = latest.voters ? Math.round(pct/100*latest.voters) : 'â€”';
                    h += '<tr><td><span class="dot" style="background:'+color+'"></span>'+i18n.partyName(pname)+'</td>';
                    h += '<td>'+pct.toFixed(1)+'%</td><td>'+i18n.fmtNum(votes)+'</td></tr>';
                });
            }
            h += '</tbody></table></div>';

            // Ballot table
            if (latest.ballots && latest.ballots.length > 0) {
                const allColors = {};
                ELECTIONS.forEach(e => {
                    if (allMap[e] && allMap[e].parties) allMap[e].parties.forEach(p => { if (!allColors[p.name]) allColors[p.name] = p.color; });
                });
                h += '<div class="m-section">';
                h += '<div class="m-section-title" data-i18n="ballot_table">'+i18n.t('ballot_table')+'</div>';
                h += '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">';
                h += '<table class="m-party-table" id="ballot-table"><thead><tr>';
                h += '<th data-col="b" style="cursor:pointer">'+i18n.t('ballot')+' â†•</th>';
                h += '<th data-col="l">'+i18n.t('venue')+'</th>';
                h += '<th data-col="v" style="cursor:pointer">'+i18n.t('voters')+' â†•</th>';
                h += '<th data-col="t" style="cursor:pointer">'+i18n.t('turnout')+' â†•</th>';
                h += '<th data-col="w">'+i18n.t('winning_party')+'</th>';
                h += '</tr></thead><tbody>';
                latest.ballots.sort((a,b) => {
                    const an = parseFloat(a.b), bn = parseFloat(b.b);
                    return an - bn;
                }).forEach(bl => {
                    const topP = bl.p ? Object.entries(bl.p).sort((a,b)=>b[1]-a[1])[0] : null;
                    const wColor = topP ? (allColors[topP[0]] || '#666') : '#666';
                    const wName = topP ? i18n.partyName(topP[0]) : 'â€”';
                    const wPct = topP ? topP[1].toFixed(1)+'%' : '';
                    h += '<tr>';
                    h += '<td>'+bl.b+'</td>';
                    h += '<td style="font-size:0.72rem;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+(bl.l||'')+'</td>';
                    h += '<td>'+i18n.fmtNum(bl.v||0)+'</td>';
                    h += '<td>'+(bl.t||0)+'%</td>';
                    h += '<td><span class="dot" style="background:'+wColor+'"></span>'+wName+' '+wPct+'</td>';
                    h += '</tr>';
                });
                h += '</tbody></table></div></div>';
            }

            container.innerHTML = h;

            // Ballot table sort
            setTimeout(() => {
                const table = document.getElementById('ballot-table');
                if (table) {
                    table.querySelectorAll('th[data-col]').forEach(th => {
                        if (!th.style.cursor) return;
                        let asc = true;
                        th.addEventListener('click', () => {
                            const col = th.dataset.col;
                            const tbody = table.querySelector('tbody');
                            const rows = Array.from(tbody.rows);
                            rows.sort((a, b) => {
                                const ai = col === 'b' ? parseFloat(a.cells[0].textContent) : col === 'v' ? parseInt(a.cells[2].textContent.replace(/[,\s]/g,'')) : parseFloat(a.cells[3].textContent);
                                const bi = col === 'b' ? parseFloat(b.cells[0].textContent) : col === 'v' ? parseInt(b.cells[2].textContent.replace(/[,\s]/g,'')) : parseFloat(b.cells[3].textContent);
                                return asc ? ai - bi : bi - ai;
                            });
                            asc = !asc;
                            rows.forEach(r => tbody.appendChild(r));
                        });
                    });
                }
            }, 100);

            // Chart
            setTimeout(() => {
                initChart(byElection);
                initSearch();
            }, 50);
        }

        function initChart(byElection) {
            const canvas = document.getElementById('trends-chart');
            if (!canvas) return;
            const pv = {};
            ELECTIONS.forEach(e => {
                const s = byElection[e];
                if (!s || !s.proportions) return;
                Object.entries(s.proportions).forEach(([n, pct]) => {
                    if (!pv[n]) pv[n] = {};
                    pv[n][e] = pct;
                });
            });
            const top = Object.entries(pv).map(([n, v]) => {
                const vals = Object.values(v);
                return { name: n, avg: vals.reduce((a,b)=>a+b,0)/vals.length };
            }).sort((a,b)=>b.avg-a.avg).slice(0, 5);

            const allPartyColors = {};
            ELECTIONS.forEach(e => {
                if (allMap[e] && allMap[e].parties) {
                    allMap[e].parties.forEach(p => { if (!allPartyColors[p.name]) allPartyColors[p.name] = p.color; });
                }
            });
            const datasets = top.map(p => {
                const color = allPartyColors[p.name] || '#888';
                return {
                    label: i18n.partyName(p.name),
                    data: ELECTIONS.map(e => pv[p.name][e] || null),
                    borderColor: color, backgroundColor: color+'33',
                    tension: 0.3, pointRadius: 3, spanGaps: true,
                };
            });

            new Chart(canvas, {
                type: 'line',
                data: { labels: ELECTIONS.map(e => LABELS[e]), datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#a0a0b0', font: { family: 'Heebo', size: 10 }, padding: 8 } } },
                    scales: {
                        x: { ticks: { color: '#a0a0b0', font: { family: 'Heebo', size: 10 } }, grid: { color: '#2a2a3a' } },
                        y: { ticks: { color: '#a0a0b0', callback: v => v+'%' }, grid: { color: '#2a2a3a' }, min: 0 }
                    }
                }
            });
        }

        function initSearch() {
            const input = document.getElementById('search-input');
            const dropdown = document.getElementById('search-dropdown');
            if (!input) return;
            const names = [];
            const m = allMap['25'];
            if (m && m.settlements) m.settlements.forEach(s => { if (s.name) names.push(s.name); });
            names.sort();
            input.addEventListener('input', () => {
                const q = input.value.trim();
                if (q.length < 1) { dropdown.classList.remove('visible'); return; }
                const matches = names.filter(n => i18n.settlementMatches(n, q)).slice(0, 10);
                if (!matches.length) { dropdown.classList.remove('visible'); return; }
                dropdown.innerHTML = matches.map(n => '<a href="settlement.html?name='+encodeURIComponent(n)+'">'+
                    (i18n.getLang()==='en' ? i18n.settlementName(n) : n) + '</a>').join('');
                dropdown.classList.add('visible');
            });
            input.addEventListener('blur', () => setTimeout(() => dropdown.classList.remove('visible'), 200));
        }

        function showSearch() {
            container.innerHTML = '<div style="padding:2rem 1rem;text-align:center">' +
                '<h2 data-i18n="settlement_profile">'+i18n.t('settlement_profile')+'</h2>' +
                '<div class="m-search" style="margin-top:1rem">' +
                '<input type="text" id="search-input" placeholder="'+i18n.t('search_settlement_profile')+'" autofocus>' +
                '<div class="m-dropdown" id="search-dropdown"></div></div></div>';
            fetch('../data/map_25.json').then(r=>r.json()).then(d=>{allMap['25']=d;initSearch()});
        }
    })();
    </script>
    <script>i18n.injectLangToggle('.top-bar');i18n.renderMobileBMC();</script>
</body>
</html>
