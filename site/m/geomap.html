<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:type" content="website">
    <meta property="og:title" content="×§×•×œ×•×ª × ×•×“×“×™× â€” ××¤×” ×’×™××•×’×¨×¤×™×ª">
    <meta property="og:description" content="× ×™×ª×•×— ××™× ×˜×¨××§×˜×™×‘×™ ×©×œ × ×ª×•× ×™ ×‘×—×™×¨×•×ª ×œ×›× ×¡×ª â€” Interactive Israeli Knesset election data analysis">
    <meta property="og:image" content="https://kolot-nodedim.netlify.app/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <title>××¤×” - ×§×•×œ×•×ª × ×•×“×“×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="../i18n.css">
    <script src="../i18n.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100%;
        }

        .leaflet-tile-pane { filter: brightness(0.7) saturate(0.8); }
        .leaflet-popup-pane, .leaflet-marker-pane, .leaflet-overlay-pane { filter: none; }

        /* Cluster icons */
        .custom-cluster {
            background: none !important;
            border: none !important;
        }
        .custom-cluster .cluster-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .cluster-count { font-size: 0.8rem; line-height: 1; text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 2px rgba(0,0,0,0.9); }
        .cluster-info { font-size: 0.6rem; opacity: 0.8; line-height: 1; text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 2px rgba(0,0,0,0.9); }

        /* Colocated cluster: all ballots at same venue */
        .cluster-colocated .cluster-inner {
            border-style: dashed;
            border-width: 2.5px;
            border-color: rgba(255,255,255,0.6);
        }

        /* Color mode FABs */
        .color-fabs {
            position: fixed;
            top: 52px;
            left: 8px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .color-fab-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .color-fab {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .color-fab.active { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
        .color-fab:active { transform: scale(0.9); }

        .color-fab-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            background: rgba(10, 10, 15, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
            transition: opacity 0.15s;
        }

        .color-fab-wrapper.active .color-fab-label {
            color: var(--text-primary);
        }

        /* Search FAB */
        .search-fab {
            top: 52px;
            right: 8px;
        }

        /* Search panel */
        .search-panel {
            position: fixed;
            top: 44px;
            right: 0;
            width: 280px;
            max-height: calc(100% - 100px);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            border-radius: 0 0 0 var(--radius);
            padding: 12px;
            z-index: 450;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.25s ease;
        }

        .search-panel.visible { transform: translateX(0); }

        .search-panel .search-section { margin-bottom: 12px; }
        .search-panel .section-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        /* Station popup override for dark theme */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-radius: var(--radius) !important;
            border: 1px solid var(--border) !important;
            box-shadow: var(--shadow) !important;
        }
        .leaflet-popup-tip { background: var(--bg-card) !important; }
        .leaflet-popup-close-button { color: var(--text-muted) !important; font-size: 18px !important; }

        .popup-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
        .popup-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
        .popup-parties { margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; }

        /* Color scale legend */
        .color-scale {
            position: fixed;
            bottom: calc(54px + var(--safe-bottom));
            left: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 10px;
            z-index: 400;
            font-size: 0.7rem;
            min-width: 120px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        .color-scale-title { color: var(--text-muted); margin-bottom: 4px; }
        .color-scale-bar {
            height: 8px;
            border-radius: 4px;
            margin-bottom: 2px;
        }
        .color-scale-labels {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 0.65rem;
        }
        .cluster-legend {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--border);
            display: none;
        }
        .cluster-legend.visible { display: block; }
        .cluster-legend-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 3px;
            font-size: 0.62rem;
            color: var(--text-secondary);
        }
        .cluster-legend-row:last-child { margin-bottom: 0; }
        .cluster-legend-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
        }
        .cluster-legend-explain {
            font-size: 0.58rem;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.3;
            font-style: italic;
        }

        /* Compare pills */
        .compare-row {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--border);
        }
        .compare-row-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 3px;
        }
        .compare-pills {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }
        .compare-pill {
            padding: 2px 6px;
            font-size: 0.62rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
        }
        .compare-pill.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .compare-msg {
            font-size: 0.6rem;
            color: #ef4444;
            margin-top: 3px;
        }

        /* Party list in sheet */
        .party-list-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        .party-list-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s;
        }
        .party-list-item:active { background: var(--bg-hover); }
        .party-list-item.active { border-color: var(--accent); background: var(--bg-hover); }
        .party-list-item .dot {
            width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
        }
        .party-list-item .name { font-size: 0.8rem; }

        /* Colocated sheet: individual ballot rows */
        .colocated-ballot-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: background 0.15s;
        }
        .colocated-ballot-row:active { background: var(--bg-hover); }
        .colocated-ballot-num {
            min-width: 32px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--accent);
        }
        .colocated-ballot-info {
            flex: 1;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <a href="index.html" class="home-link">ğŸ </a>
        <span class="title"><span data-i18n="site_title">×§×•×œ×•×ª × ×•×“×“×™×</span> Â· <span data-i18n="tab_map">××¤×”</span></span>
        <div class="election-pills" id="election-pills"></div>
        <button class="info-toggle" id="info-btn" title="About">â„¹</button>
    </div>

    <!-- Main Map -->
    <div class="main-area">
        <div id="map"></div>
        <div class="loading-overlay" id="loading">
            <div style="text-align:center;">
                <div class="spinner" style="margin:0 auto 12px;"></div>
                <div style="color:var(--text-secondary);font-size:0.85rem;" data-i18n="loading_please_wait">×˜×•×¢×Ÿ × ×ª×•× ×™×, × × ×œ×”××ª×™×Ÿ...</div>
            </div>
        </div>
    </div>

    <!-- Color mode FABs (left side) -->
    <div class="color-fabs" id="color-fabs"></div>

    <!-- Search FAB (right side) -->
    <div class="fab search-fab" id="search-toggle">ğŸ”</div>

    <!-- Search Panel (slides from right) -->
    <div class="search-panel" id="search-panel">
        <div class="search-section">
            <div class="section-title" data-i18n="search_settlement">×—×™×¤×•×© ×™×™×©×•×‘</div>
            <div style="position: relative;">
                <input class="search-input" id="settlement-search" placeholder="×©× ×™×™×©×•×‘..." data-i18n-placeholder="filter_settlement" autocomplete="off">
                <div class="search-results" id="settlement-results"></div>
            </div>
            <div class="selected-tags" id="settlement-tags"></div>
        </div>
        <div class="search-section">
            <div class="section-title" data-i18n="search_station">×—×™×¤×•×© ×§×œ×¤×™</div>
            <div style="position: relative;">
                <input class="search-input" id="station-search" placeholder="×™×™×©×•×‘, ××¡×¤×¨ ××• ××™×§×•×..." data-i18n-placeholder="search_station" autocomplete="off">
                <div class="search-results" id="station-results"></div>
            </div>
        </div>
    </div>

    <!-- Color Scale Legend -->
    <div class="color-scale" id="color-scale" style="display:none;">
        <div class="color-scale-title" id="scale-title"></div>
        <div class="color-scale-bar" id="scale-bar"></div>
        <div class="color-scale-labels">
            <span id="scale-min"></span>
            <span id="scale-max"></span>
        </div>
        <div class="cluster-legend" id="cluster-legend">
            <div class="cluster-legend-row">
                <span class="cluster-legend-icon" style="background: #2563eb; border: 2px solid rgba(255,255,255,0.3); width:12px; height:12px;"></span>
                <span data-i18n="legend_single_ballot">×§×œ×¤×™ ×‘×•×“×“×ª â€” ×”×¦×‘×¢ ××™×™×¦×’ ××ª ×”××¤×œ×’×” ×”×× ×¦×—×ª</span>
            </div>
            <div class="cluster-legend-row">
                <span class="cluster-legend-icon" style="background: conic-gradient(#2563eb 0% 60%, #06b6d4 60% 100%); border: 2px solid rgba(255,255,255,0.3);">5</span>
                <span data-i18n="legend_spread_cluster">××§×‘×¥ ×©×œ ××ª×¨×™ ×”×¦×‘×¢×” ×©×•× ×™× â€” ×œ×—×¥ ×›×“×™ ×œ×”×ª×§×¨×‘</span>
            </div>
            <div class="cluster-legend-row">
                <span class="cluster-legend-icon" style="background: conic-gradient(#2563eb 0% 70%, #dc2626 70% 100%); border: 2.5px dashed rgba(255,255,255,0.6);">3</span>
                <span data-i18n="legend_colocated_cluster">××§×‘×¥ ×§×œ×¤×™×•×ª ×‘××•×ª×• ××§×•×</span>
            </div>
            <div class="cluster-legend-explain" data-i18n="legend_pie_explain">×¦×‘×¢×™ ×”×¢×•×’×” ×‘××§×‘×¦×™×: ×—×œ×•×§×ª ×”××¤×œ×’×” ×”×× ×¦×—×ª ×‘×›×œ ×§×œ×¤×™</div>
        </div>
        <div class="compare-row" id="compare-row" style="display:none;">
            <div class="compare-row-label" id="compare-label">×”×©×•×•××” ×œ×›× ×¡×ª:</div>
            <div class="compare-pills" id="compare-pills"></div>
            <div class="compare-msg" id="compare-msg" style="display:none;"></div>
        </div>
    </div>

    <!-- Bottom Sheet (for cluster/marker details & party selection) -->
    <div class="sheet-backdrop" id="sheet-backdrop"></div>
    <div class="bottom-sheet" id="bottom-sheet">
        <div class="sheet-handle"></div>
        <div id="sheet-content"></div>
    </div>

    <!-- Bottom Tabs -->
    <nav class="tab-bar">
        <a href="geomap.html" class="active"><span class="tab-icon">ğŸ—ºï¸</span><span data-i18n="tab_map">××¤×”</span></a>
        <a href="tsne.html"><span class="tab-icon">ğŸ”µ</span><span data-i18n="tab_tsne">×¤×™×–×•×¨</span></a>
        <a href="sankey.html"><span class="tab-icon">ğŸ”€</span><span data-i18n="tab_sankey">× ×“×™×“×”</span></a>
        <a href="scatter.html"><span class="tab-icon">ğŸ“ˆ</span><span data-i18n="tab_scatter">×”×©×•×•××”</span></a>
        <a href="dhondt.html"><span class="tab-icon">ğŸ›ï¸</span><span data-i18n="tab_dhondt">×× ×“×˜×™×</span></a>
        <a href="regional.html"><span class="tab-icon">ğŸ§©</span><span data-i18n="tab_regional">××–×•×¨×™</span></a>
        <a href="discussions.html"><span class="tab-icon">ğŸ’¬</span><span data-i18n="nav_discussions">×“×™×•× ×™×</span></a>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
    class MobileGeoMap {
        constructor() {
            this.currentElection = '25';
            this.colorMode = 'winner';
            this.selectedParty = null;
            this.tsneData = null;
            this.coordinates = null;
            this.socioeconomicData = null;
            this.parties = [];
            this.settlements = [];
            this.selectedSettlements = [];
            this.compareElection = null;
            this.compareData = null;
            this.compareLookup = {};
            this.compareCache = {};

            this.initElectionPills();
            this.initMap();
            this.initEvents();
            this.loadData();

            // Re-render on language change
            window.addEventListener('langchange', () => {
                i18n.applyTranslations();
                this.buildColorFabs();
                this.updateCompareRow();
                this.updateColorScale();
                this.renderMarkers();
            });
        }

        initElectionPills() {
            const pills = document.getElementById('election-pills');
            const electionIds = ['16','17','18','19','20','21','22','23','24','25'];
            if (i18n.SHOW_E26) electionIds.push('26');
            electionIds.forEach(id => {
                const btn = document.createElement('button');
                btn.className = 'election-pill' + (id === this.currentElection ? ' active' : '');
                btn.textContent = id;
                btn.onclick = () => this.switchElection(id);
                pills.appendChild(btn);
            });
            // Scroll active pill into view
            const active = pills.querySelector('.active');
            if (active) setTimeout(() => active.scrollIntoView({ inline: 'center', block: 'nearest' }), 0);
        }

        initMap() {
            this.map = L.map('map', {
                center: [31.5, 34.9],
                zoom: 8,
                minZoom: 7,
                maxZoom: 18,
                zoomControl: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(this.map);

            L.control.zoom({ position: 'bottomright' }).addTo(this.map);

            this.markers = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: false,
                spiderfyOnMaxZoom: false,
                iconCreateFunction: c => this.createClusterIcon(c)
            });
            this.map.addLayer(this.markers);

            // Tap on cluster â†’ smart handling
            this.markers.on('clusterclick', e => {
                const cluster = e.layer;
                const children = cluster.getAllChildMarkers();
                const firstLL = children[0].getLatLng();
                const colocated = children.every(m => {
                    const ll = m.getLatLng();
                    return ll.lat === firstLL.lat && ll.lng === firstLL.lng;
                });

                if (colocated) {
                    // Colocated: show bottom sheet with individual ballot list (no spiderfy)
                    this.showColocatedSheet(cluster);
                } else {
                    // Spread: zoom in, or spiderfy if can't zoom further
                    const boundsZoom = this.map.getBoundsZoom(cluster.getBounds());
                    if (boundsZoom <= this.map.getZoom()) {
                        cluster.spiderfy();
                    } else {
                        cluster.zoomToBounds({padding: [20, 20]});
                    }
                }
            });
        }

        initEvents() {
            // Search toggle
            document.getElementById('search-toggle').onclick = () => {
                document.getElementById('search-panel').classList.toggle('visible');
            };

            // Close search when tapping map
            this.map.on('click', () => {
                document.getElementById('search-panel').classList.remove('visible');
            });

            // Settlement search
            const setSearch = document.getElementById('settlement-search');
            setSearch.oninput = () => this.handleSettlementSearch(setSearch.value);

            // Station search
            const staSearch = document.getElementById('station-search');
            staSearch.oninput = () => this.handleStationSearch(staSearch.value);

            // Sheet backdrop
            document.getElementById('sheet-backdrop').onclick = () => this.hideSheet();
        }

        async loadData() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const [tsneRes, coordRes, seRes, stRes] = await Promise.all([
                    fetch(`../data/tsne_${this.currentElection}.json`),
                    fetch(`../data/station_coordinates.json`),
                    fetch(`../data/socioeconomic_clusters.json`),
                    fetch(`../data/station_socioeconomic.json`)
                ]);
                this.tsneData = await tsneRes.json();
                this.coordinates = await coordRes.json();
                const seArr = await seRes.json();

                this.socioeconomicData = {};
                seArr.forEach(item => {
                    this.socioeconomicData[item.name] = item.cluster;
                    this.socioeconomicData[this.normalizeName(item.name)] = item.cluster;
                });
                this.stationSocioeconomic = {};
                if (stRes.ok) {
                    const stData = await stRes.json();
                    for (const [key, val] of Object.entries(stData)) {
                        if (val.cluster) this.stationSocioeconomic[key] = { cluster: val.cluster, statArea: val.zone };
                    }
                }

                this.parties = this.tsneData.parties || [];
                this.buildSettlements();
                this.buildColorFabs();
                this.renderMarkers();
            } catch (err) {
                console.error('Load error:', err);
            }
            document.getElementById('loading').style.display = 'none';
        }

        async switchElection(id) {
            this.currentElection = id;
            document.querySelectorAll('.election-pill').forEach(p => {
                p.classList.toggle('active', p.textContent === id);
                if (p.textContent === id) p.scrollIntoView({ inline: 'center', block: 'nearest', behavior: 'smooth' });
            });
            this.selectedSettlements = [];
            document.getElementById('settlement-tags').innerHTML = '';

            // If compare election is same as new current, clear compare
            if (this.compareElection === id) {
                this.compareElection = null;
                this.compareData = null;
                this.compareLookup = {};
            }

            const prevSymbol = this.selectedParty ? this.selectedParty.symbol : null;
            const prevMode = this.colorMode;

            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(`../data/tsne_${id}.json`);
                this.tsneData = await res.json();
                this.parties = this.tsneData.parties || [];
                this.buildSettlements();
                this.buildColorFabs();
                // Restore party selection by symbol (party family)
                if (prevSymbol && prevMode === 'party') {
                    const match = this.parties.find(p => p.symbol === prevSymbol);
                    if (match) { this.setColorMode('party', match); }
                    else { this.renderMarkers(); }
                } else {
                    this.updateCompareRow();
                    this.renderMarkers();
                }
            } catch (err) { console.error(err); }
            document.getElementById('loading').style.display = 'none';
        }

        buildSettlements() {
            const counts = {};
            this.tsneData.stations.forEach(s => {
                const n = s.n || '';
                counts[n] = (counts[n] || 0) + 1;
            });
            this.settlements = Object.entries(counts)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
        }

        buildColorFabs() {
            const container = document.getElementById('color-fabs');
            const modes = [
                { id: 'winner', bg: 'linear-gradient(135deg, #2563eb, #dc2626, #16a34a)', label: i18n.t('winner') },
                { id: 'turnout', bg: 'linear-gradient(to bottom, #10b981, #fbbf24, #ef4444)', label: i18n.t('turnout') },
                { id: 'socioeconomic', bg: 'linear-gradient(to bottom, #5e4fa2, #66c2a5, #9e0142)', label: i18n.t('socioeconomic') },
                { id: 'party', bg: '#6366f1', label: i18n.t('party') }
            ];

            container.innerHTML = modes.map(m => `
                <div class="color-fab-wrapper ${m.id === this.colorMode ? 'active' : ''}" data-mode="${m.id}">
                    <div class="color-fab ${m.id === this.colorMode ? 'active' : ''}"
                         style="background: ${m.bg};"></div>
                    <span class="color-fab-label">${m.label}</span>
                </div>
            `).join('');

            container.querySelectorAll('.color-fab-wrapper').forEach(wrapper => {
                wrapper.onclick = () => {
                    const mode = wrapper.dataset.mode;
                    if (mode === 'party') {
                        this.showPartyPicker();
                    } else {
                        this.setColorMode(mode);
                    }
                };
            });
        }

        setColorMode(mode, party = null) {
            this.colorMode = mode;
            this.selectedParty = party;

            // Clear compare when switching away from party mode
            if (mode !== 'party' || !party) {
                this.compareElection = null;
                this.compareData = null;
                this.compareLookup = {};
            } else if (this.compareElection && this.compareData) {
                // Rebuild lookup for new party
                if (!this.buildCompareLookup()) {
                    this.compareElection = null;
                    this.compareData = null;
                    this.compareLookup = {};
                }
            }

            document.querySelectorAll('.color-fab-wrapper').forEach(w => {
                const isActive = w.dataset.mode === mode;
                w.classList.toggle('active', isActive);
                w.querySelector('.color-fab').classList.toggle('active', isActive);
            });

            this.updateCompareRow();
            this.updateColorScale();
            this.renderMarkers();
        }

        updateColorScale() {
            const el = document.getElementById('color-scale');
            const bar = document.getElementById('scale-bar');
            const title = document.getElementById('scale-title');
            const min = document.getElementById('scale-min');
            const max = document.getElementById('scale-max');
            const clusterLegend = document.getElementById('cluster-legend');
            clusterLegend.classList.remove('visible');

            if (this.colorMode === 'turnout') {
                el.style.display = 'block';
                title.textContent = i18n.t('turnout');
                bar.style.display = '';
                bar.style.background = 'linear-gradient(to left, #10b981, #fbbf24, #ef4444)';
                min.textContent = '40%';
                max.textContent = '90%';
            } else if (this.colorMode === 'socioeconomic') {
                el.style.display = 'block';
                title.textContent = i18n.t('socioeconomic');
                bar.style.display = '';
                bar.style.background = 'linear-gradient(to left, #5e4fa2, #3288bd, #66c2a5, #abdda4, #e6f598, #fee08b, #fdae61, #f46d43, #d53e4f, #9e0142)';
                min.textContent = '1';
                max.textContent = '10';
            } else if (this.colorMode === 'party' && this.selectedParty) {
                el.style.display = 'block';
                if (this.compareElection) {
                    const isEn = i18n.getLang() === 'en';
                    const displayName = i18n.partyName(this.selectedParty.name);
                    if (isEn) {
                        title.textContent = `${displayName}: K.${this.compareElection} â† K.${this.currentElection}`;
                    } else {
                        const heName = this.selectedParty.name.startsWith('×”') ? this.selectedParty.name.slice(1) : this.selectedParty.name;
                        title.textContent = `×©×™× ×•×™ ×‘${heName}: ×›× ×¡×ª ${this.compareElection} â† ${this.currentElection}`;
                    }
                    bar.style.display = '';
                    bar.style.background = 'linear-gradient(to left, #0d9488, #f5f5f5, #d97706)';
                    min.textContent = '-20%';
                    max.textContent = '+20%';
                } else {
                    title.textContent = i18n.partyName(this.selectedParty.name);
                    bar.style.display = '';
                    const c = this.selectedParty.color;
                    bar.style.background = `linear-gradient(to left, ${c}, ${this.lightenColor(c, 0.85)})`;
                    min.textContent = '0%';
                    max.textContent = '50%';
                }
            } else if (this.colorMode === 'winner') {
                el.style.display = 'block';
                title.textContent = i18n.t('winner');
                bar.style.display = 'none';
                min.textContent = '';
                max.textContent = '';
                clusterLegend.classList.add('visible');
            } else {
                el.style.display = 'none';
            }
        }

        renderMarkers() {
            this.markers.clearLayers();
            const stations = this.tsneData.stations;
            let filtered = stations;

            if (this.selectedSettlements.length > 0) {
                filtered = stations.filter(s =>
                    this.selectedSettlements.includes(s.n));
            }

            const batch = [];
            filtered.forEach(station => {
                const key = `${station.n}|${station.b}`;
                const coord = this.coordinates?.stations?.[key];
                if (!coord || !coord.lat || !coord.lng) return;

                const color = this.getColor(station);
                const voters = station.v || 0;
                const radius = Math.max(4, Math.min(12, Math.sqrt(voters / 50) * 2.5));

                const marker = L.circleMarker([coord.lat, coord.lng], {
                    radius,
                    fillColor: color,
                    color: '#000',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.7,
                    stationData: { ...station, l: coord.location || '' }
                });

                marker.on('click', () => this.showStationSheet(station, coord));
                batch.push(marker);
            });

            this.markers.addLayers(batch);

            if (this.selectedSettlements.length > 0) {
                const bounds = this.markers.getBounds();
                if (bounds.isValid()) this.map.fitBounds(bounds, { padding: [30, 30] });
            }
        }

        createClusterIcon(cluster) {
            const children = cluster.getAllChildMarkers();
            const count = children.length;
            let totalVoters = 0, totalEligible = 0;
            const partyVotes = {};
            const clusterCounts = {};

            children.forEach(m => {
                const s = m.options.stationData;
                if (!s) return;
                totalVoters += s.v || 0;
                totalEligible += s.e || 0;
                const name = s.n || '';
                const seInfo = this.getStationCluster(s);
                if (seInfo) clusterCounts[seInfo.cluster] = (clusterCounts[seInfo.cluster] || 0) + 1;
                const p = s.p || {};
                Object.entries(p).forEach(([party, pct]) => {
                    partyVotes[party] = (partyVotes[party] || 0) + ((s.v || 0) * pct / 100);
                });
            });

            const avgTurnout = totalEligible > 0 ? Math.round(totalVoters / totalEligible * 100) : 0;
            const sorted = Object.entries(partyVotes).sort((a, b) => b[1] - a[1]);
            const winner = sorted[0];

            let size = count > 100 ? 52 : count > 30 ? 46 : 40;
            let bgColor = 'rgba(59,130,246,0.8)';
            let info = '';

            if (this.colorMode === 'winner' && winner) {
                const party = this.parties.find(p => p.name === winner[0]);
                bgColor = party ? this.hexToRgba(party.color, 0.8) : bgColor;
                info = `${Math.round(winner[1] / totalVoters * 100)}%`;
            } else if (this.colorMode === 'turnout') {
                bgColor = this.getTurnoutColor(avgTurnout).replace('rgb', 'rgba').replace(')', ',0.8)');
                info = `${avgTurnout}%`;
            } else if (this.colorMode === 'socioeconomic') {
                const entries = Object.entries(clusterCounts);
                if (entries.length) {
                    const dominant = entries.sort((a, b) => b[1] - a[1])[0];
                    const colors = ['#9e0142','#d53e4f','#f46d43','#fdae61','#fee08b','#e6f598','#abdda4','#66c2a5','#3288bd','#5e4fa2'];
                    bgColor = this.hexToRgba(colors[dominant[0] - 1], 0.8);
                    info = dominant[0];
                }
            } else if (this.colorMode === 'party' && this.selectedParty) {
                if (this.compareElection) {
                    let totalW = 0, wDiff = 0, hasAny = false;
                    children.forEach(m => {
                        const s = m.options.stationData;
                        if (!s) return;
                        const v = s.v || 0;
                        const cp = this.getComparePct(s);
                        if (cp === undefined) return;
                        const curP = (s.p || {})[this.selectedParty.name] || 0;
                        wDiff += (curP - cp) * v;
                        totalW += v;
                        hasAny = true;
                    });
                    if (hasAny && totalW > 0) {
                        const avgDiff = wDiff / totalW;
                        bgColor = this.getDiffColor(avgDiff);
                        const sign = avgDiff >= 0 ? '+' : '';
                        info = `${sign}${avgDiff.toFixed(1)}%`;
                    } else {
                        bgColor = 'rgba(102,102,102,0.5)';
                        info = '?';
                    }
                } else {
                    const pv = partyVotes[this.selectedParty.name] || 0;
                    const pct = totalVoters > 0 ? Math.round(pv / totalVoters * 100) : 0;
                    const t = Math.min(pct / 50, 1);
                    bgColor = this.hexToRgba(this.interpolateHex(
                        this.lightenColor(this.selectedParty.color, 0.85),
                        this.selectedParty.color, t), 0.8);
                    info = `${pct}%`;
                }
            }

            // Detect colocated cluster (all children at same coordinates)
            const firstLL = children[0].getLatLng();
            const colocated = children.every(m => {
                const ll = m.getLatLng();
                return ll.lat === firstLL.lat && ll.lng === firstLL.lng;
            });

            // Pie chart background for clusters in winner mode
            let bgStyle = `background:${bgColor}`;
            if (this.colorMode === 'winner' && count > 1) {
                const winnerCounts = {};
                children.forEach(m => {
                    const s = m.options.stationData;
                    if (!s) return;
                    const p = s.p || {};
                    const w = Object.entries(p).sort((a, b) => b[1] - a[1])[0];
                    if (w) winnerCounts[w[0]] = (winnerCounts[w[0]] || 0) + 1;
                });
                let slices = Object.entries(winnerCounts).sort((a, b) => b[1] - a[1]);
                if (slices.length > 1) {
                    let otherCount = 0;
                    if (slices.length > 5) {
                        otherCount = slices.slice(5).reduce((s, e) => s + e[1], 0);
                        slices = slices.slice(0, 5);
                    }
                    let angle = 0;
                    const stops = [];
                    slices.forEach(([party, n]) => {
                        const p = this.parties.find(pp => pp.name === party);
                        const color = p ? p.color : '#6b7280';
                        const pct = n / count * 100;
                        stops.push(`${color} ${angle.toFixed(1)}% ${(angle + pct).toFixed(1)}%`);
                        angle += pct;
                    });
                    if (otherCount > 0) {
                        const pct = otherCount / count * 100;
                        stops.push(`#4b5563 ${angle.toFixed(1)}% ${(angle + pct).toFixed(1)}%`);
                    }
                    bgStyle = `background:conic-gradient(${stops.join(', ')})`;
                }
            }

            if (colocated) size = Math.round(size * 0.85);
            const cls = colocated ? 'custom-cluster cluster-colocated' : 'custom-cluster';

            return L.divIcon({
                html: `<div class="cluster-inner" style="${bgStyle}">
                    <div class="cluster-count">${count}</div>
                    <div class="cluster-info">${info}</div>
                </div>`,
                className: cls,
                iconSize: L.point(size, size)
            });
        }

        // ---- Compare mode methods ----

        async fetchCompareData(electionId) {
            if (this.compareCache[electionId]) return this.compareCache[electionId];
            const res = await fetch(`../data/tsne_${electionId}.json`);
            const data = await res.json();
            this.compareCache[electionId] = data;
            return data;
        }

        normalizeBallot(b) {
            const s = String(b);
            return s.endsWith('.0') ? s.slice(0, -2) : s;
        }

        baseBallot(b) {
            const s = this.normalizeBallot(b);
            const dot = s.indexOf('.');
            return dot >= 0 ? s.slice(0, dot) : s;
        }

        buildCompareLookup() {
            this.compareLookup = {};
            if (!this.compareData || !this.selectedParty) return false;
            const compareParty = this.compareData.parties.find(p => p.symbol === this.selectedParty.symbol);
            if (!compareParty) return false;
            this.compareData.stations.forEach(s => {
                const val = (s.p || {})[compareParty.name] || 0;
                // Store under both raw and normalized key
                this.compareLookup[`${s.n}|${s.b}`] = val;
                this.compareLookup[`${s.n}|${this.normalizeBallot(s.b)}`] = val;
            });
            return true;
        }

        getComparePct(station) {
            const name = station.n || station.settlement_name || '';
            const ballot = station.b || station.ballot_number || '';
            // Try exact key
            let pct = this.compareLookup[`${name}|${ballot}`];
            if (pct !== undefined) return pct;
            // Try normalized (.0 stripped)
            pct = this.compareLookup[`${name}|${this.normalizeBallot(ballot)}`];
            if (pct !== undefined) return pct;
            // Try base ballot number (strip subdivision: 14.2 â†’ 14)
            pct = this.compareLookup[`${name}|${this.baseBallot(ballot)}`];
            return pct;
        }

        getDiffColor(diff) {
            const t = Math.max(-1, Math.min(1, diff / 20));
            if (t < 0) {
                return this.interpolateHex('#f5f5f5', '#d97706', Math.abs(t));
            } else {
                return this.interpolateHex('#f5f5f5', '#0d9488', t);
            }
        }

        updateCompareRow() {
            const row = document.getElementById('compare-row');
            const pills = document.getElementById('compare-pills');
            const label = document.getElementById('compare-label');
            const msg = document.getElementById('compare-msg');
            msg.style.display = 'none';

            if (this.colorMode !== 'party' || !this.selectedParty) {
                row.style.display = 'none';
                return;
            }

            row.style.display = '';
            const isEn = i18n.getLang() === 'en';
            label.textContent = isEn ? 'Compare to:' : '×”×©×•×•××” ×œ×›× ×¡×ª:';

            const electionIds = ['16','17','18','19','20','21','22','23','24','25'];
            if (i18n.SHOW_E26) electionIds.push('26');

            pills.innerHTML = electionIds
                .filter(id => id !== this.currentElection)
                .map(id => `<button class="compare-pill${this.compareElection === id ? ' active' : ''}" data-cmp="${id}">${id}</button>`)
                .join('');

            pills.querySelectorAll('.compare-pill').forEach(btn => {
                btn.onclick = () => this.toggleCompare(btn.dataset.cmp);
            });
        }

        async toggleCompare(electionId) {
            const msg = document.getElementById('compare-msg');
            msg.style.display = 'none';

            if (this.compareElection === electionId) {
                this.compareElection = null;
                this.compareData = null;
                this.compareLookup = {};
            } else {
                this.compareElection = electionId;
                this.compareData = await this.fetchCompareData(electionId);
                if (!this.buildCompareLookup()) {
                    const isEn = i18n.getLang() === 'en';
                    msg.textContent = isEn
                        ? `Party not found in Knesset ${electionId}`
                        : `×”××¤×œ×’×” ×œ× ×”×ª××•×“×“×” ×‘×›× ×¡×ª ${electionId}`;
                    msg.style.display = 'block';
                    this.compareElection = null;
                    this.compareData = null;
                    this.compareLookup = {};
                    this.updateCompareRow();
                    return;
                }
            }
            this.updateCompareRow();
            this.updateColorScale();
            this.renderMarkers();
        }

        getColor(station) {
            if (this.colorMode === 'turnout') {
                return this.getTurnoutColor(station.t || 0);
            }
            if (this.colorMode === 'socioeconomic') {
                const se = this.getStationCluster(station);
                if (!se) return '#374151';
                const colors = ['#9e0142','#d53e4f','#f46d43','#fdae61','#fee08b','#e6f598','#abdda4','#66c2a5','#3288bd','#5e4fa2'];
                return colors[Math.min(Math.max(se.cluster, 1), 10) - 1];
            }
            if (this.colorMode === 'winner') {
                const p = station.p || {};
                const w = Object.entries(p).sort((a, b) => b[1] - a[1])[0];
                if (w) {
                    const party = this.parties.find(pp => pp.name === w[0]);
                    return party ? party.color : '#374151';
                }
                return '#374151';
            }
            if (this.colorMode === 'party' && this.selectedParty) {
                const currentPct = (station.p || {})[this.selectedParty.name] || 0;

                if (this.compareElection) {
                    const comparePct = this.getComparePct(station);
                    if (comparePct === undefined) return 'rgba(102,102,102,0.5)';
                    return this.getDiffColor(currentPct - comparePct);
                }

                const t = Math.min(currentPct / 50, 1);
                return this.interpolateHex(
                    this.lightenColor(this.selectedParty.color, 0.85),
                    this.selectedParty.color, t);
            }
            return '#3b82f6';
        }

        // ---- Bottom Sheets ----

        showStationSheet(station, coord) {
            const name = station.n || '';
            const ballot = station.b || '';
            const location = station.l || coord.location || '';
            const voters = station.v || 0;
            const eligible = station.e || 0;
            const turnout = station.t || 0;
            const se = this.getStationCluster(station);

            const topParties = Object.entries(station.p || {})
                .sort((a, b) => b[1] - a[1]).slice(0, 7);

            const partyHtml = topParties.map(([pname, pct]) => {
                const party = this.parties.find(p => p.name === pname);
                const color = party?.color || '#64748b';
                return `<div class="party-row">
                    <span class="party-dot" style="background:${color}"></span>
                    <span class="party-name">${i18n.partyName(pname)}</span>
                    <span class="party-pct">${Math.round(pct)}%</span>
                    <div class="party-bar"><div class="party-bar-fill" style="width:${pct}%;background:${color}"></div></div>
                </div>`;
            }).join('');

            // Compare diff
            let diffHtml = '';
            if (this.compareElection && this.selectedParty) {
                const curPct = (station.p || {})[this.selectedParty.name] || 0;
                const cmpPct = this.getComparePct(station);
                if (cmpPct !== undefined) {
                    const diff = curPct - cmpPct;
                    const sign = diff >= 0 ? '+' : '';
                    const isEn = i18n.getLang() === 'en';
                    diffHtml = `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:0.85rem;">
                        <span dir="ltr" style="color:${diff >= 0 ? '#0d9488' : '#d97706'};font-weight:600;">${sign}${diff.toFixed(1)}%</span>
                        <span dir="ltr" style="color:var(--text-muted);margin-right:4px;display:inline-block;">${isEn ? 'K.' : '×›.'}${this.compareElection}: ${cmpPct.toFixed(1)}% â† ${isEn ? 'K.' : '×›.'}${this.currentElection}: ${curPct.toFixed(1)}%</span>
                    </div>`;
                }
            }

            document.getElementById('sheet-content').innerHTML = `
                <div style="font-weight:600;font-size:1rem;margin-bottom:2px;">${i18n.settlementName(name)}</div>
                <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;">
                    ${i18n.t('ballot')} ${ballot}${location ? ' Â· ' + location : ''}${se ? ' Â· ' + i18n.t('socioeconomic') + ' ' + se.cluster + (se.statArea ? ', ' + (i18n.getLang() === 'en' ? 'area' : '××–×•×¨') + ' ' + se.statArea : '') : ''}
                </div>
                <div class="stat-grid">
                    <span class="label">${i18n.t('eligible_voters')}</span><span class="value">${i18n.fmtNum(eligible)}</span>
                    <span class="label">${i18n.t('voted')}</span><span class="value">${i18n.fmtNum(voters)}</span>
                    <span class="label">${i18n.t('turnout')}</span><span class="value">${turnout}%</span>
                </div>
                ${partyHtml}
                ${diffHtml}
                <a href="settlement.html?name=${encodeURIComponent(name)}" style="display:block;margin-top:10px;color:#3b82f6;text-decoration:none;font-size:0.85em;">${i18n.t('go_to_profile')} &rarr;</a>
            `;
            this.showSheet();
        }

        showClusterSheet(cluster) {
            const children = cluster.getAllChildMarkers();
            const count = children.length;
            let totalVoters = 0, totalEligible = 0;
            const partyVotes = {};
            const settlements = new Set();
            const locations = new Set();

            children.forEach(m => {
                const s = m.options.stationData;
                if (!s) return;
                totalVoters += s.v || 0;
                totalEligible += s.e || 0;
                if (s.n) settlements.add(s.n);
                if (s.l) locations.add(s.l);
                Object.entries(s.p || {}).forEach(([p, pct]) => {
                    partyVotes[p] = (partyVotes[p] || 0) + ((s.v || 0) * pct / 100);
                });
            });

            const avgTurnout = totalEligible > 0 ? Math.round(totalVoters / totalEligible * 100) : 0;
            const setList = [...settlements];
            const andMore = i18n.getLang() === 'he'
                ? `×•×¢×•×“ ${setList.length - 2}`
                : `and ${setList.length - 2} more`;
            const title = setList.length === 1 ? i18n.settlementName(setList[0])
                : setList.length <= 3 ? setList.map(n => i18n.settlementName(n)).join(', ')
                : `${setList.slice(0, 2).map(n => i18n.settlementName(n)).join(', ')} ${andMore}`;
            const venue = locations.size === 1 ? [...locations][0] : '';

            const topParties = Object.entries(partyVotes)
                .sort((a, b) => b[1] - a[1]).slice(0, 7)
                .map(([name, votes]) => ({
                    name,
                    pct: totalVoters > 0 ? Math.round(votes / totalVoters * 100) : 0,
                    color: this.parties.find(p => p.name === name)?.color || '#64748b'
                }));

            const partyHtml = topParties.map(p => `
                <div class="party-row">
                    <span class="party-dot" style="background:${p.color}"></span>
                    <span class="party-name">${i18n.partyName(p.name)}</span>
                    <span class="party-pct">${p.pct}%</span>
                    <div class="party-bar"><div class="party-bar-fill" style="width:${p.pct}%;background:${p.color}"></div></div>
                </div>
            `).join('');

            document.getElementById('sheet-content').innerHTML = `
                <div style="font-weight:600;font-size:1rem;margin-bottom:2px;">${title}</div>
                ${venue ? `<div style="font-size:0.8rem;color:var(--text-muted);font-style:italic;margin-bottom:6px;">${venue}</div>` : ''}
                <div class="stat-grid">
                    <span class="label">${i18n.t('stations')}</span><span class="value">${i18n.fmtNum(count)}</span>
                    <span class="label">${i18n.t('voters')}</span><span class="value">${i18n.fmtNum(totalVoters)}</span>
                    <span class="label">${i18n.t('turnout')}</span><span class="value">${avgTurnout}%</span>
                </div>
                ${partyHtml}
            `;
            this.showSheet();
        }

        showColocatedSheet(cluster) {
            const children = cluster.getAllChildMarkers();
            const count = children.length;

            const sorted = children
                .map(m => m.options.stationData)
                .filter(Boolean)
                .sort((a, b) => (parseFloat(a.b) || 0) - (parseFloat(b.b) || 0));

            const settlement = sorted[0]?.n || '';
            const location = sorted[0]?.l || '';

            let totalVoters = 0, totalEligible = 0;
            sorted.forEach(s => { totalVoters += s.v || 0; totalEligible += s.e || 0; });
            const avgTurnout = totalEligible > 0 ? Math.round(totalVoters / totalEligible * 100) : 0;

            const ballotRows = sorted.map(s => {
                const topParties = Object.entries(s.p || {}).sort((a, b) => b[1] - a[1]).slice(0, 3);
                const topHtml = topParties.map(([pn, pct]) => {
                    const party = this.parties.find(p => p.name === pn);
                    return `<span style="display:inline-flex;align-items:center;gap:2px;">
                        <span style="width:8px;height:8px;border-radius:50%;background:${party?.color || '#64748b'};display:inline-block;"></span>
                        ${Math.round(pct)}%
                    </span>`;
                }).join(' ');

                return `<div class="colocated-ballot-row" data-ballot="${s.b}">
                    <div class="colocated-ballot-num">${s.b}</div>
                    <div class="colocated-ballot-info">
                        <div>${i18n.fmtNum(s.v || 0)} ${i18n.t('voted')} Â· ${s.t || 0}%</div>
                        <div style="color:var(--text-muted);margin-top:2px;">${topHtml}</div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('sheet-content').innerHTML = `
                <div style="font-weight:600;font-size:1rem;margin-bottom:2px;">${i18n.settlementName(settlement)}</div>
                ${location ? `<div style="font-size:0.8rem;color:var(--text-muted);font-style:italic;margin-bottom:4px;">${location}</div>` : ''}
                <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;">${count} ${i18n.t('stations')} Â· ${i18n.fmtNum(totalVoters)} ${i18n.t('voted')} Â· ${avgTurnout}%</div>
                <div style="display:flex;flex-direction:column;gap:4px;">${ballotRows}</div>
                <a href="settlement.html?name=${encodeURIComponent(settlement)}" style="display:block;margin-top:10px;color:#3b82f6;text-decoration:none;font-size:0.85em;">${i18n.t('go_to_profile')} &rarr;</a>
            `;

            // Tap individual ballot â†’ show its detail sheet
            document.querySelectorAll('.colocated-ballot-row').forEach(row => {
                row.onclick = () => {
                    const b = row.dataset.ballot;
                    const station = sorted.find(s => s.b === b);
                    if (station) {
                        const key = `${station.n}|${station.b}`;
                        const coord = this.coordinates?.stations?.[key];
                        this.showStationSheet(station, coord || {});
                    }
                };
            });

            this.showSheet();
        }

        showPartyPicker() {
            const html = `
                <div style="font-weight:600;font-size:1rem;margin-bottom:10px;">${i18n.t('specific_party')}</div>
                <div class="party-list-grid">
                    ${this.parties.map(p => `
                        <div class="party-list-item ${this.selectedParty?.name === p.name ? 'active' : ''}" data-party="${p.name}">
                            <span class="dot" style="background:${p.color}"></span>
                            <span class="name">${i18n.partyName(p.name)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('sheet-content').innerHTML = html;
            this.showSheet();

            document.querySelectorAll('.party-list-item').forEach(item => {
                item.onclick = () => {
                    const party = this.parties.find(p => p.name === item.dataset.party);
                    if (party) {
                        this.hideSheet();
                        this.setColorMode('party', party);
                    }
                };
            });
        }

        showSheet() {
            document.getElementById('sheet-backdrop').classList.add('visible');
            document.getElementById('bottom-sheet').classList.add('visible');
        }

        hideSheet() {
            document.getElementById('sheet-backdrop').classList.remove('visible');
            document.getElementById('bottom-sheet').classList.remove('visible');
        }

        // ---- Search ----

        handleSettlementSearch(query) {
            const results = document.getElementById('settlement-results');
            if (query.length < 1) { results.classList.remove('visible'); return; }

            const matches = this.settlements
                .filter(s => i18n.settlementMatches(s.name, query))
                .slice(0, 10);

            if (!matches.length) { results.classList.remove('visible'); return; }

            results.innerHTML = matches.map(s => `
                <div class="search-result-item" data-name="${s.name}">
                    ${i18n.settlementName(s.name)} <span class="detail">${i18n.fmtNum(s.count)} ${i18n.t('stations')}</span>
                </div>
            `).join('');
            results.classList.add('visible');

            results.querySelectorAll('.search-result-item').forEach(item => {
                item.onclick = () => {
                    const name = item.dataset.name;
                    if (!this.selectedSettlements.includes(name)) {
                        this.selectedSettlements.push(name);
                        this.renderSettlementTags();
                        this.renderMarkers();
                    }
                    document.getElementById('settlement-search').value = '';
                    results.classList.remove('visible');
                };
            });
        }

        handleStationSearch(query) {
            const results = document.getElementById('station-results');
            if (query.length < 2) { results.classList.remove('visible'); return; }

            const q = query.toLowerCase();
            const matches = this.tsneData.stations
                .filter(s => {
                    const b = String(s.b || '');
                    const l = (s.l || '').toLowerCase();
                    return i18n.settlementMatches(s.n || '', query) || b.includes(query) || l.includes(q);
                }).slice(0, 15);

            if (!matches.length) { results.classList.remove('visible'); return; }

            results.innerHTML = matches.map((s, i) => `
                <div class="search-result-item" data-idx="${i}">
                    <strong>${i18n.settlementName(s.n)}</strong> - ${i18n.t('ballot')} ${s.b}
                    ${s.l ? `<br><span class="detail">${s.l}</span>` : ''}
                </div>
            `).join('');
            results.classList.add('visible');

            this._stationMatches = matches;
            results.querySelectorAll('.search-result-item').forEach(item => {
                item.onclick = () => {
                    const s = this._stationMatches[parseInt(item.dataset.idx)];
                    const key = `${s.n}|${s.b}`;
                    const coord = this.coordinates?.stations?.[key];
                    if (coord) {
                        this.map.setView([coord.lat, coord.lng], 17);
                        this.showStationSheet(s, coord);
                    }
                    document.getElementById('station-search').value = '';
                    results.classList.remove('visible');
                    document.getElementById('search-panel').classList.remove('visible');
                };
            });
        }

        renderSettlementTags() {
            const container = document.getElementById('settlement-tags');
            container.innerHTML = this.selectedSettlements.map(name => `
                <span class="chip">${i18n.settlementName(name)}<span class="remove" data-name="${name}">&times;</span></span>
            `).join('');

            container.querySelectorAll('.remove').forEach(btn => {
                btn.onclick = e => {
                    e.stopPropagation();
                    this.selectedSettlements = this.selectedSettlements.filter(s => s !== btn.dataset.name);
                    this.renderSettlementTags();
                    this.renderMarkers();
                };
            });
        }

        // ---- Color Utilities ----

        getTurnoutColor(turnout) {
            if (turnout < 65) {
                const t = Math.max(0, Math.min(1, (turnout - 40) / 25));
                return this.interpolateHex('#ef4444', '#fbbf24', t);
            } else {
                const t = Math.max(0, Math.min(1, (turnout - 65) / 25));
                return this.interpolateHex('#fbbf24', '#10b981', t);
            }
        }

        interpolateHex(c1, c2, t) {
            const p1 = this.parseHex(c1), p2 = this.parseHex(c2);
            const r = Math.round(p1.r + (p2.r - p1.r) * t);
            const g = Math.round(p1.g + (p2.g - p1.g) * t);
            const b = Math.round(p1.b + (p2.b - p1.b) * t);
            return `rgb(${r},${g},${b})`;
        }

        parseHex(color) {
            if (color.startsWith('rgb')) {
                const m = color.match(/(\d+)/g);
                return { r: +m[0], g: +m[1], b: +m[2] };
            }
            const hex = color.replace('#', '');
            return {
                r: parseInt(hex.substr(0, 2), 16),
                g: parseInt(hex.substr(2, 2), 16),
                b: parseInt(hex.substr(4, 2), 16)
            };
        }

        lightenColor(color, factor) {
            const { r, g, b } = this.parseHex(color);
            return `rgb(${Math.round(r + (255 - r) * factor)},${Math.round(g + (255 - g) * factor)},${Math.round(b + (255 - b) * factor)})`;
        }

        hexToRgba(color, alpha) {
            const { r, g, b } = this.parseHex(color);
            return `rgba(${r},${g},${b},${alpha})`;
        }

        getStationCluster(station) {
            const name = station.n || '';
            const ballot = station.b || '';
            if (this.stationSocioeconomic) {
                const entry = this.stationSocioeconomic[`${name}|${ballot}`];
                if (entry) return entry; // {cluster, statArea}
            }
            const c = this.socioeconomicData?.[name] || this.socioeconomicData?.[this.normalizeName(name)];
            return c ? { cluster: c, statArea: null } : null;
        }

        normalizeName(name) {
            if (!name) return name;
            return name.replace(/[-â€“\s]+/g, '').replace(/×™×™/g, '×™');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new MobileGeoMap();

        // Info button click handler
        document.getElementById('info-btn').onclick = () => {
            document.getElementById('sheet-content').innerHTML = `
                <div class="about-sheet">
                    <h3>${i18n.t('about_this_view')}</h3>
                    <p>${i18n.t('geomap_info')}</p>

                    <h3>${i18n.t('about_site')}</h3>
                    <p>${i18n.t('about_description')}</p>

                    <h3>${i18n.t('license')}</h3>
                    <p>CC BY-NC-SA 4.0 &nbsp;|&nbsp; ${i18n.t('credits_line')}</p>
                    <p><a href="https://github.com/harelkain/elections-vote-transfer" target="_blank">${i18n.t('source_code')}</a></p>
                    <a href="https://www.buymeacoffee.com/harelc" target="_blank" class="bmc-inline">
                        <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="">
                        <span>${i18n.t('bmc_title')}</span>
                    </a>
                    <br>
                    <a href="discussions.html" class="discussions-link">
                        ${i18n.t('feedback_question')}
                    </a>
                </div>
            `;
            // Show the bottom sheet
            document.getElementById('sheet-backdrop').classList.add('visible');
            document.getElementById('bottom-sheet').classList.add('visible');
        };
    });
    </script>
    <script>i18n.injectLangToggle('.top-bar');i18n.renderMobileBMC();</script>
</body>
</html>
