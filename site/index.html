<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קולות נודדים - ניתוח מעבר קולות בבחירות לכנסת</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Animated sand dunes - חולות נודדים -->
    <div class="dunes-container">
        <div class="dune dune-3"></div>
        <div class="dune dune-2"></div>
        <div class="dune dune-1"></div>
    </div>

    <div class="app-container">
        <header class="main-header">
            <div class="header-content">
                <h1 class="site-title">
                    <span class="title-icon">🗳️</span>
                    קולות נודדים
                </h1>
                <p class="site-subtitle">ניתוח מעבר קולות בין בחירות לכנסת ישראל</p>
            </div>
            <nav class="view-switcher">
                <span class="view-btn active">נדידת קולות</span>
                <a href="tsne.html" class="view-btn">התפלגות קלפיות</a>
                <a href="geomap.html" class="view-btn">מפה גיאוגרפית</a>
                <a href="scatter.html" class="view-btn">השוואת מפלגות</a>
                <a href="dhondt.html" class="view-btn">מחשבון באדר-עופר</a>
                <a href="irregular.html" class="view-btn">קלפיות חריגות</a>
                <button class="export-btn header-export" id="export-png">📷 ייצוא PNG</button>
            </nav>
        </header>

        <nav class="election-nav">
            <div class="nav-container">
                <button class="nav-btn" data-transition="21_to_22">
                    <span class="nav-from">21</span>
                    <span class="nav-arrow">←</span>
                    <span class="nav-to">22</span>
                </button>
                <button class="nav-btn" data-transition="22_to_23">
                    <span class="nav-from">22</span>
                    <span class="nav-arrow">←</span>
                    <span class="nav-to">23</span>
                </button>
                <button class="nav-btn" data-transition="23_to_24">
                    <span class="nav-from">23</span>
                    <span class="nav-arrow">←</span>
                    <span class="nav-to">24</span>
                </button>
                <button class="nav-btn active" data-transition="24_to_25">
                    <span class="nav-from">24</span>
                    <span class="nav-arrow">←</span>
                    <span class="nav-to">25</span>
                </button>
            </div>
        </nav>

        <main class="main-content">
            <div class="info-panel">
                <div class="election-info">
                    <div class="election-card from-election">
                        <span class="election-label">מבחירות</span>
                        <h3 class="election-name" id="from-election-name">הכנסת ה-24</h3>
                        <span class="election-date" id="from-election-date">23.03.2021</span>
                        <div class="election-stats">
                            <span class="election-stat"><span id="from-eligible">6,578,084</span> בעלי זכות</span>
                            <span class="election-stat"><span id="from-votes">4,436,365</span> הצביעו</span>
                            <span class="election-stat"><span id="from-turnout">67.4%</span> אחוז הצבעה</span>
                        </div>
                    </div>
                    <div class="arrow-container">
                        <svg class="flow-arrow" viewBox="0 0 50 24">
                            <path d="M50 12 L10 12 M20 4 L8 12 L20 20" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                    <div class="election-card to-election">
                        <span class="election-label">לבחירות</span>
                        <h3 class="election-name" id="to-election-name">הכנסת ה-25</h3>
                        <span class="election-date" id="to-election-date">01.11.2022</span>
                        <div class="election-stats">
                            <span class="election-stat"><span id="to-eligible">6,788,804</span> בעלי זכות</span>
                            <span class="election-stat"><span id="to-votes">4,794,593</span> הצביעו</span>
                            <span class="election-stat"><span id="to-turnout">70.6%</span> אחוז הצבעה</span>
                        </div>
                    </div>
                </div>
                <div class="stats-panel">
                    <div class="stat-item">
                        <span class="stat-value" id="stat-precincts">6,857</span>
                        <span class="stat-label">קלפיות משותפות</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="stat-r2">0.896</span>
                        <span class="stat-label">R² (מידת התאמה)</span>
                    </div>
                    <div class="stat-item toggle-item">
                        <button class="percent-toggle" id="percent-toggle">
                            <span class="toggle-label">תצוגת אחוזים:</span>
                            <span class="toggle-value" id="toggle-value">מהבחירות הקודמות</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="visualization-container">
                <div class="legend-container legend-from">
                    <h4 id="legend-from-title">מפלגות מקור</h4>
                    <div id="legend-from" class="legend-grid"></div>
                </div>
                <div class="sankey-wrapper">
                    <div id="sankey-chart"></div>
                </div>
                <div class="legend-container legend-to">
                    <h4 id="legend-to-title">מפלגות יעד</h4>
                    <div id="legend-to" class="legend-grid"></div>
                </div>
            </div>

            <div class="tooltip" id="tooltip"></div>

            <!-- Mobile bottom sheet -->
            <div class="bottom-sheet" id="bottom-sheet">
                <div class="bottom-sheet-handle"></div>
                <div class="bottom-sheet-content" id="bottom-sheet-content"></div>
            </div>

            <!-- Mobile legends overlay -->
            <div class="legends-overlay" id="legends-overlay">
                <div class="legends-overlay-content">
                    <div class="legends-overlay-header">
                        <span class="legends-overlay-title">מפלגות</span>
                        <button class="legends-overlay-close" id="close-legends">×</button>
                    </div>
                    <div class="legends-section">
                        <div class="legends-section-title" id="overlay-from-title">בחירות קודמות</div>
                        <div class="legends-list" id="overlay-from-list"></div>
                    </div>
                    <div class="legends-section">
                        <div class="legends-section-title" id="overlay-to-title">בחירות חדשות</div>
                        <div class="legends-list" id="overlay-to-list"></div>
                    </div>
                </div>
            </div>

            <!-- Mobile controls -->
            <div class="mobile-controls">
                <button class="mobile-btn" id="show-legends-btn">
                    <span>מפלגות</span>
                </button>
                <button class="mobile-btn" id="mobile-percent-toggle">
                    <span id="mobile-toggle-value">% מהקודמות</span>
                </button>
            </div>
        </main>

        <footer class="main-footer">
            <div class="footer-content">
                <p class="methodology">
                    <strong>מתודולוגיה:</strong>
                    כל קלפי מהווה תצפית רועשת (noisy observation) של דפוס מעבר הקולות הארצי.
                    המצביעים בכל קלפי נוהגים באופן דומה לאוכלוסייה הכללית, אך גודל המדגם הקטן (מאות בוחרים) יוצר רעש סטטיסטי.
                    על ידי רגרסיה על אלפי קלפיות ברחבי הארץ, ניתן לשחזר את מטריצת המעבר הארצית האמיתית.
                    <a href="#" class="methodology-link" id="open-methodology">קראו עוד על המתודולוגיה...</a>
                </p>
                <p class="credits">
                    © הראל קין |
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> |
                    <a href="https://github.com/harelc/elections-vote-transfer/" target="_blank">קוד מקור</a>
                </p>
            </div>
        </footer>

        <!-- Methodology Modal -->
        <div class="modal-overlay" id="methodology-modal">
            <div class="modal-content">
                <button class="modal-close" id="close-methodology">&times;</button>
                <h2>על המתודולוגיה</h2>

                <section class="methodology-section">
                    <h3>🎯 הרעיון הבסיסי</h3>
                    <p>
                        דמיינו שאתם רוצים לדעת לאן עברו הקולות של מפלגה X בבחירות הקודמות.
                        ברור שחלק מהמצביעים נשארו נאמנים, אחרים עברו למפלגה Y, ואחרים למפלגה Z.
                        אבל איך אפשר לדעת את הפילוח הזה בלי לשאול כל אזרח איך הצביע?
                    </p>
                    <p>
                        הפתרון: <strong>להסתכל על קלפיות בודדות</strong>.
                        בכל קלפי יש כמה מאות מצביעים, ויש לנו את תוצאות ההצבעה שלהם בשתי בחירות עוקבות.
                        אם בקלפי מסוימת הייתה תמיכה גבוהה במפלגה X בבחירות הקודמות, ובבחירות הנוכחיות יש תמיכה גבוהה במפלגה Y -
                        זה רמז שמצביעי X עברו ל-Y.
                    </p>
                    <p>
                        כמובן, קלפי בודדת היא מדגם קטן ורועש. אבל כשמנתחים <strong>אלפי קלפיות</strong> יחד,
                        הרעש מתקזז והתמונה האמיתית מתגלה.
                    </p>
                </section>

                <section class="methodology-section">
                    <h3>📊 המודל המתמטי</h3>
                    <p>
                        אנחנו מחפשים <strong>מטריצת מעבר</strong> M, כך שכל תא M[i,j] מייצג את
                        ההסתברות שמצביע שהצביע למפלגה i בבחירות הקודמות יצביע למפלגה j בבחירות הנוכחיות.
                    </p>
                    <p>
                        המודל מניח שהתפלגות ההצבעה בכל קלפי מקיימת את המשוואה:
                    </p>
                    <div class="formula">
                        V<sub>לפני</sub> × M ≈ V<sub>אחרי</sub>
                    </div>
                    <p>
                        כאשר V<sub>לפני</sub> הוא וקטור אחוזי ההצבעה בבחירות הקודמות,
                        ו-V<sub>אחרי</sub> הוא וקטור אחוזי ההצבעה בבחירות הנוכחיות.
                    </p>
                </section>

                <section class="methodology-section">
                    <h3>⚙️ האופטימיזציה</h3>
                    <p>
                        המטריצה M מחושבת באמצעות <strong>אופטימיזציה קמורה</strong> (Convex Optimization),
                        שמוצאת את M שממזערת את סכום ריבועי השגיאות:
                    </p>
                    <div class="formula">
                        minimize Σ<sub>קלפי</sub> ||V<sub>לפני</sub> × M - V<sub>אחרי</sub>||²
                    </div>
                    <p>תחת האילוצים הבאים:</p>
                    <ul>
                        <li><strong>אי-שליליות:</strong> M[i,j] ≥ 0 (לא ייתכן מעבר שלילי)</li>
                        <li><strong>סטוכסטיות:</strong> סכום כל שורה שווה ל-1 (כל המצביעים הולכים למקום כלשהו)</li>
                    </ul>
                    <p>
                        הפתרון מתקבל באמצעות הספרייה CVXPY עם הפותר SCS.
                    </p>
                </section>

                <section class="methodology-section">
                    <h3>📈 מדד איכות: R²</h3>
                    <p>
                        מדד R² (R-squared) מציין כמה טוב המודל מסביר את השונות בנתונים.
                        ערך 1.0 מציין התאמה מושלמת, וערך 0 מציין שהמודל לא מסביר כלום.
                    </p>
                    <p>
                        בפועל, אנחנו מקבלים ערכי R² בטווח 0.7-0.9, שמעידים על התאמה טובה אך לא מושלמת -
                        מה שהגיוני, כי המודל הוא פישוט של המציאות.
                    </p>
                </section>

                <section class="methodology-section">
                    <h3>⚠️ מגבלות ואזהרות</h3>
                    <ul class="limitations-list">
                        <li>
                            <strong>הנחת אחידות:</strong>
                            המודל מניח שדפוס המעבר זהה בכל הארץ. במציאות, מצביעי ליכוד בתל אביב
                            עשויים להתנהג אחרת ממצביעי ליכוד בירושלים.
                        </li>
                        <li>
                            <strong>מצביעים חדשים ונפטרים:</strong>
                            המודל מתעלם מכניסת מצביעים חדשים (בני 18+) וממצביעים שנפטרו.
                            אלה מיוצגים באופן מאולץ כ"מעבר" ממפלגה כלשהי.
                        </li>
                        <li>
                            <strong>שינויים בהרכב הקלפי:</strong>
                            תושבים עוברים דירה, קלפיות מתפצלות או מתמזגות.
                            אנחנו משווים רק קלפיות עם אותו מזהה, מה שמפספס חלק מהתמונה.
                        </li>
                        <li>
                            <strong>קורלציה ≠ סיבתיות:</strong>
                            המודל מוצא קשרים סטטיסטיים, לא מוכיח שמצביעים באמת עברו.
                            יכולים להיות גורמים נסתרים שמסבירים את הקורלציות.
                        </li>
                        <li>
                            <strong>אי-ודאות:</strong>
                            התוצאות הן אומדנים סטטיסטיים עם שולי שגיאה.
                            מעברים קטנים (פחות מ-5%) עשויים להיות רעש סטטיסטי ולא מגמה אמיתית.
                        </li>
                    </ul>
                </section>

                <section class="methodology-section">
                    <h3>📚 קריאה נוספת</h3>
                    <p>
                        הקוד המלא זמין ב<a href="https://github.com/harelc/elections-vote-transfer/" target="_blank">GitHub</a>.
                    </p>
                </section>
            </div>
        </div>

        <style>
            .methodology-link {
                color: var(--accent-primary);
                text-decoration: none;
                font-weight: 500;
                margin-right: 8px;
            }
            .methodology-link:hover {
                text-decoration: underline;
                color: var(--accent-secondary);
            }
            .modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                z-index: 10000;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            }
            .modal-overlay.visible {
                display: flex;
            }
            .modal-content {
                background: var(--bg-card);
                border-radius: var(--radius-lg);
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                padding: 32px;
                position: relative;
                box-shadow: var(--shadow-lg), 0 0 40px rgba(99, 102, 241, 0.15);
                direction: rtl;
                border: 1px solid var(--border-color);
            }
            .modal-close {
                position: absolute;
                top: 16px;
                left: 16px;
                background: var(--bg-hover);
                border: 1px solid var(--border-color);
                font-size: 24px;
                cursor: pointer;
                color: var(--text-secondary);
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: var(--transition-fast);
            }
            .modal-close:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border-color: var(--accent-primary);
            }
            .modal-content h2 {
                margin: 0 0 24px 0;
                color: var(--text-primary);
                font-size: 1.8em;
            }
            .methodology-section {
                margin-bottom: 28px;
            }
            .methodology-section h3 {
                color: var(--accent-primary);
                margin: 0 0 12px 0;
                font-size: 1.2em;
            }
            .methodology-section p {
                line-height: 1.8;
                color: var(--text-secondary);
                margin: 0 0 12px 0;
            }
            .methodology-section ul {
                line-height: 1.8;
                color: var(--text-secondary);
                padding-right: 24px;
            }
            .methodology-section li {
                margin-bottom: 8px;
            }
            .formula {
                background: var(--bg-tertiary);
                padding: 16px 24px;
                border-radius: var(--radius-md);
                font-family: 'Courier New', monospace;
                font-size: 1.1em;
                text-align: center;
                margin: 16px 0;
                border: 1px solid var(--border-color);
                direction: ltr;
                color: var(--text-primary);
            }
            .limitations-list li {
                margin-bottom: 16px;
            }
            .limitations-list strong {
                color: var(--warning);
            }
            .methodology-section a {
                color: var(--accent-primary);
            }
            .methodology-section a:hover {
                color: var(--accent-secondary);
            }
            @media (max-width: 600px) {
                .modal-content {
                    padding: 20px;
                    margin: 10px;
                }
                .modal-content h2 {
                    font-size: 1.4em;
                    padding-left: 40px;
                }
            }
        </style>

        <script>
            document.getElementById('open-methodology').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('methodology-modal').classList.add('visible');
                document.body.style.overflow = 'hidden';
            });
            document.getElementById('close-methodology').addEventListener('click', () => {
                document.getElementById('methodology-modal').classList.remove('visible');
                document.body.style.overflow = '';
            });
            document.getElementById('methodology-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('methodology-modal').classList.remove('visible');
                    document.body.style.overflow = '';
                }
            });
        </script>
    </div>

    <script src="sankey.js"></script>

    <!-- Buy Me a Coffee button -->
    <a href="https://www.buymeacoffee.com/harelc" target="_blank" class="bmc-button" title="קנו לי כוס קפה ☕">
        <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy me a coffee">
        <span>אהבתם? עזרו לתמוך בפיתוח האתר ובעלויות שלו - קנו לי קפה</span>
    </a>
    <style>
        .bmc-button {
            position: fixed;
            bottom: 18px;
            left: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #FFDD00;
            border-radius: 8px;
            text-decoration: none;
            color: #000;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 9999;
        }
        .bmc-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        .bmc-button img {
            width: 24px;
            height: 24px;
        }
        .bmc-button span {
            display: none;
            max-width: 200px;
            line-height: 1.4;
        }
        .bmc-button:hover span {
            display: inline-block;
        }
    </style>
</body>
</html>
